System.register(["./vendor-legacy-D9drMVix.js"],(function(e,n){"use strict";var a,t,r,i,s,l,d,o,c,h,u,m,g,x,p,j,y,f,v,w,b,k,C,I,T,S,N,q,L,P,A,W,D,R,K,H,F,E,z,B,M,V,U,X,G,Q,$,O,Y,Z,_,J,ee,ne,ae,te,re,ie,se,le,de,oe,ce,he,ue,me,ge,xe,pe,je,ye,fe,ve,we,be,ke,Ce,Ie,Te,Se,Ne,qe,Le,Pe,Ae,We,De,Re,Ke,He,Fe,Ee,ze,Be,Me,Ve,Ue,Xe,Ge,Qe,$e,Oe,Ye,Ze,_e,Je,en,nn,an,tn,rn,sn,ln,dn,on,cn,hn,un,mn,gn,xn,pn,jn;return{setters:[e=>{a=e.c,t=e.u,r=e.j,i=e.D,s=e.a,l=e.b,d=e.d,o=e.e,c=e.B,h=e.f,u=e.r,m=e.g,g=e.h,x=e.C,p=e.L,j=e.i,y=e.R,f=e.A,v=e.M,w=e.k,b=e.l,k=e.S,C=e.Q,I=e.m,T=e.y,S=e.n,N=e.o,q=e.p,L=e.O,P=e.q,A=e.s,W=e.T,D=e.t,R=e.G,K=e.v,H=e.w,F=e.x,E=e.z,z=e.E,B=e.F,M=e.H,V=e.I,U=e.J,X=e.N,G=e.K,Q=e.P,$=e.U,O=e.V,Y=e.W,Z=e.X,_=e.Y,J=e.Z,ee=e._,ne=e.$,ae=e.a0,te=e.a1,re=e.a2,ie=e.a3,se=e.a4,le=e.a5,de=e.a6,oe=e.a7,ce=e.a8,he=e.a9,ue=e.aa,me=e.ab,ge=e.ac,xe=e.ad,pe=e.ae,je=e.af,ye=e.ag,fe=e.ah,ve=e.ai,we=e.aj,be=e.ak,ke=e.al,Ce=e.am,Ie=e.an,Te=e.ao,Se=e.ap,Ne=e.aq,qe=e.ar,Le=e.as,Pe=e.at,Ae=e.au,We=e.av,De=e.aw,Re=e.ax,Ke=e.ay,He=e.az,Fe=e.aA,Ee=e.aB,ze=e.aC,Be=e.aD,Me=e.aE,Ve=e.aF,Ue=e.aG,Xe=e.aH,Ge=e.aI,Qe=e.aJ,$e=e.aK,Oe=e.aL,Ye=e.aM,Ze=e.aN,_e=e.aO,Je=e.aP,en=e.aQ,nn=e.aR,an=e.aS,tn=e.aT,rn=e.aU,sn=e.aV,ln=e.aW,dn=e.aX,on=e.aY,cn=e.aZ,hn=e.a_,un=e.a$,mn=e.b0,gn=e.b1,xn=e.b2,pn=e.b3,jn=e.b4}],execute:function(){const e=a({cssVariables:{colorSchemeSelector:"data-toolpad-color-scheme"},colorSchemes:{light:!0,dark:!0}});function n({open:e,onClose:n}){return"/cap-nhat-thong-tin"===t().pathname?null:r.jsxs(i,{open:e,onClose:n,children:[r.jsx(s,{children:"Câp nhật thông tin"}),r.jsx(l,{children:r.jsx(d,{children:"Vui lòng cập nhật thông tin trước khi sử dụng hệ thống."})}),r.jsx(o,{children:r.jsx(c,{onClick:n,autoFocus:!0,children:"Câp nhật thông tin"})})]})}function yn({open:e,onClose:n}){return r.jsxs(i,{open:e,onClose:n,children:[r.jsx(s,{children:"Phiên đăng nhập đã hết hạn"}),r.jsx(l,{children:r.jsx(d,{children:"Vui lòng đăng nhập lại để tiếp tục sử dụng hệ thống."})}),r.jsx(o,{children:r.jsx(c,{onClick:n,autoFocus:!0,children:"Đăng nhập lại"})})]})}const fn=h.create({baseURL:"/api",headers:{"Content-Type":"application/json"},timeout:1e4});fn.interceptors.request.use((e=>{const n=localStorage.getItem("token");return n&&(e.headers.Authorization=`Bearer ${n}`),e}),(e=>Promise.reject(e)));const vn=async e=>(await fn.get(`/users/${e}`)).data,wn=async()=>(await fn.get("/users")).data,bn=async()=>(await fn.get("/users/me")).data,kn=async e=>(await fn.get(`/users/department/${e}`)).data,Cn=u.createContext(void 0),In=({children:e})=>{const[n,a]=u.useState(null),[t,i]=u.useState(!0),s=async()=>{const e=localStorage.getItem("token");if(!e)return a(null),void i(!1);try{const n=await bn();if(n.success){const t=n.data;t.role=m(e)["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"],a(t)}}catch(n){console.error("Failed to fetch user info:",n),localStorage.removeItem("token"),localStorage.removeItem("expiration"),a(null)}finally{i(!1)}};return u.useEffect((()=>{s()}),[]),r.jsx(Cn.Provider,{value:{user:n,setUser:a,signOut:()=>{localStorage.removeItem("token"),localStorage.removeItem("expiration"),a(null),window.location.href="/dang-nhap"},loading:t,refreshUserInfo:s},children:e})},Tn=()=>{const e=u.useContext(Cn);if(!e)throw new Error("useAuth must be used within an AuthProvider");return e},Sn=[{kind:"header",title:"Chính"},{title:"Trang chủ",icon:r.jsx(g,{})},{segment:"cong-trinh",title:"Công trình",icon:r.jsx(x,{})},{segment:"dang-ky-quy-doi",title:"Đăng ký quy đổi",icon:r.jsx(p,{})},{kind:"header",title:"Báo cáo"},{segment:"bao-cao",title:"Báo cáo",icon:r.jsx(j,{})}],Nn=[{kind:"header",title:"Chính"},{title:"Trang chủ",icon:r.jsx(g,{})},{segment:"cong-trinh",title:"Công trình",icon:r.jsx(x,{})},{segment:"cham-diem",title:"Chấm điểm công trình",icon:r.jsx(y,{})},{kind:"header",title:"Báo cáo"},{segment:"bao-cao",title:"Báo cáo",icon:r.jsx(j,{})},{segment:"thong-ke",title:"Thống kê",icon:r.jsx(f,{})},{kind:"header",title:"Hệ thống"},{segment:"quan-ly-tai-khoan",title:"Quản lý tài khoản",icon:r.jsx(v,{})}],qn=[{kind:"header",title:"Chính"},{title:"Trang chủ",icon:r.jsx(g,{})},{segment:"cham-diem",title:"Chấm điểm công trình",icon:r.jsx(y,{})},{segment:"phan-cong",title:"Phân công chấm điểm",icon:r.jsx(w,{})},{kind:"header",title:"Báo cáo"},{segment:"thong-ke",title:"Thống kê",icon:r.jsx(f,{})},{kind:"header",title:"Hệ thống"},{segment:"quan-ly-tai-khoan",title:"Quản lý tài khoản",icon:r.jsx(v,{})},{segment:"cau-hinh-he-thong",title:"Cấu hình hệ thống",icon:r.jsx(b,{})},{segment:"cai-dat",title:"Quản lý danh mục",icon:r.jsx(k,{}),children:[{segment:"he-so-quy-doi",title:"Hệ số quy đổi"},{segment:"muc-dich-quy-doi",title:"Mục đích quy đổi"},{segment:"vai-tro-tac-gia",title:"Vai trò tác giả"},{kind:"divider"},{segment:"loai-cong-trinh",title:"Loại công trình"},{segment:"cap-cong-trinh",title:"Cấp công trình"},{segment:"nganh-scimago",title:"Ngành SCImago"},{kind:"divider"},{segment:"don-vi",title:"Đơn vị"},{segment:"nganh",title:"Ngành"},{segment:"nam-hoc",title:"Năm học"}]}],Ln={logo:r.jsx("img",{src:"/logo.png",alt:"SGU"}),title:"SGU - NCKH"};function Pn(){const[e,a]=u.useState(null),[i,s]=u.useState(!1),[l,d]=u.useState(!1),{user:o,loading:c}=Tn(),h=o?.role,m=u.useMemo((()=>{switch(h){case"Admin":return qn;case"Manager":return Nn;case"User":return Sn;default:return[]}}),[h]),g=new C,x=t(),p=I();u.useEffect((()=>{T.dismiss()}),[x]);const j=u.useMemo((()=>({signIn:()=>{p("/dang-nhap")},signOut:()=>{localStorage.removeItem("token"),localStorage.removeItem("user"),a(null),p("/dang-nhap")}})),[]);return u.useEffect((()=>{if(o){const e=function(e){const n=["-","","Unknown"];return n.includes(e.email)||n.includes(e.phoneNumber)||n.includes(e.specialization)||n.includes(e.academicTitle)||n.includes(e.officerRank)||n.includes(e.fieldName)||"00000000-0000-0000-0000-000000000000"===e.fieldId}(o);e&&"/cap-nhat-thong-tin"!==x.pathname?d(!0):d(!1),a({user:o})}else c||a(null)}),[o,c,x.pathname]),u.useEffect((()=>{const e=localStorage.getItem("expiration");if(!e)return;const n=new Date(e).getTime()-Date.now();if(n>0){const e=setTimeout((()=>{s(!0),j.signOut()}),n);return()=>clearTimeout(e)}s(!0),j.signOut()}),[]),r.jsx(S,{navigation:m,branding:Ln,session:e,authentication:j,children:r.jsxs(N,{client:g,children:[r.jsx(q,{position:"top-right",autoClose:2e3}),r.jsx(L,{}),r.jsx(yn,{open:i,onClose:()=>p("/dang-nhap")}),r.jsx(n,{open:l,onClose:()=>p("/cap-nhat-thong-tin")})]})})}const An={CN:"Cử nhân",ThS:"Thạc sĩ",TS:"Tiến sĩ",PGS_TS:"Phó Giáo sư, Tiến sĩ",GS_TS:"Giáo sư, Tiến sĩ",Unknown:"-"},Wn=e=>An[e]||"-",Dn={GiaoVien:"Giáo viên",ChuyenVien:"Chuyên viên",ChuyenVienChinh:"Chuyên viên chính",ChuyenVienCaoCap:"Chuyên viên cao cấp",TroGiang:"Trợ giảng",GiangVien:"Giảng viên",GiangVienChinh:"Giảng viên chính",GiangVienCaoCap:"Giảng viên cao cấp",Unknown:"-"},Rn=e=>Dn[e]||"-";function Kn(){const e=P();return e&&e.user?r.jsxs(A,{sx:{maxWidth:350,padding:2},children:[e.user&&r.jsxs(A,{mb:1,children:[r.jsx(W,{variant:"h6",fontWeight:600,children:e.user.fullName}),r.jsx(W,{variant:"body2",children:e.user.fieldName}),r.jsx(W,{variant:"body2",fontWeight:300,children:e.user.userName}),r.jsx(D,{sx:{my:1}}),r.jsxs(R,{container:!0,spacing:2,children:[r.jsx(R,{item:!0,xs:6,children:r.jsx(W,{variant:"body2",children:"Email:"})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(W,{variant:"body2",children:e.user.email})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(W,{variant:"body2",children:"Học vị:"})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(W,{variant:"body2",children:Wn(e.user.academicTitle)})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(W,{variant:"body2",children:"Ngạch viên chức:"})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(W,{variant:"body2",children:Rn(e.user.officerRank)})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(W,{variant:"body2",children:"Đơn vị công tác:"})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(W,{variant:"body2",children:e.user.departmentName})})]}),r.jsx(K,{href:"/cap-nhat-thong-tin",sx:{marginTop:2},children:"Chỉnh sửa thông tin"})]}),r.jsx(D,{}),r.jsx(H,{children:r.jsx(F,{})})]}):null}const Hn=async()=>(await fn.get("/notifications/global")).data,Fn=async()=>(await fn.get("/notifications/me")).data;function En(e){return E.fromISO(e,{zone:"utc"}).setZone("Asia/Saigon").setLocale("vi").toFormat("d LLLL yyyy, HH:mm")}function zn(){const[e,n]=u.useState(null),a=Boolean(e),t=z(),{data:i,isLoading:s,refetch:l}=B({queryKey:["notifications"],queryFn:Fn});u.useEffect((()=>{const e=(new M).withUrl(`/notification-hub?access_token=${localStorage.getItem("token")}`).withAutomaticReconnect().build();return e.on("ReceiveNotification",(()=>{l()})),e.start().catch(console.error),()=>{e.stop()}}),[l]);const d=i?.data||[],o=d.filter((e=>!e.isRead)).length,h=()=>{n(null)},m=async e=>{try{await(async e=>(await fn.put(`/notifications/${e}`)).data)(e),t.invalidateQueries({queryKey:["notifications"]}),l()}catch(n){console.error("Error marking notification as read",n)}finally{h()}};return r.jsxs(r.Fragment,{children:[r.jsx(V,{id:"notification-button","aria-controls":a?"notification-menu":void 0,"aria-haspopup":"true","aria-expanded":a?"true":void 0,onClick:e=>{n(e.currentTarget)},children:r.jsx(U,{badgeContent:o,color:"error",children:r.jsx(X,{color:"primary"})})}),r.jsx(G,{id:"notification-menu",anchorEl:e,open:a,onClose:h,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},PaperProps:{sx:{minWidth:300,maxHeight:400}},MenuListProps:{"aria-labelledby":"notification-button"},children:s?r.jsx(Q,{sx:{p:1},children:r.jsx($,{size:20})}):d.length>0?[...d].sort(((e,n)=>e.isRead===n.isRead?0:e.isRead?1:-1)).map((e=>r.jsxs(Q,{sx:{display:"flex",flexDirection:"column",justifyContent:"space-between",alignItems:"flex-start",backgroundColor:e.isRead?"transparent":"action.selected"},children:[r.jsx(W,{variant:"body2",sx:{fontWeight:e.isRead?"normal":"bold",mr:1,flex:1},children:e.content}),r.jsxs(O,{display:"flex",justifyContent:"space-between",alignItems:"center",gap:2,children:[r.jsx(W,{variant:"body2",sx:{whiteSpace:"nowrap",fontSize:"0.7rem",color:"text.secondary"},children:En(e.createdDate.toString())}),r.jsx(c,{size:"small",variant:"outlined",color:"primary",disabled:e.isRead,onClick:()=>m(e.id),children:e.isRead?"Đã đọc":"Đánh dấu đã đọc"})]})]},e.id))):r.jsx(Q,{onClick:h,sx:{p:1},children:r.jsx(W,{variant:"body2",children:"Không có thông báo nào để hiển thị."})})})]})}function Bn(){return r.jsxs(O,{display:"flex",alignItems:"center",gap:2,children:[r.jsx(zn,{}),r.jsx(Y,{slots:{popoverContent:Kn},localeText:{signOutLabel:"Đăng xuất"}})]})}const Mn=J({username:ee().min(1,"Mã số giảng viên là bắt buộc").max(9,"Mã số giảng viên không hợp lệ"),password:ee().min(6,"Mật khẩu phải có ít nhất 6 ký tự")}),Vn=ne(ae)((({theme:e})=>({display:"flex",flexDirection:"column",alignSelf:"center",width:"100%",padding:e.spacing(6),gap:e.spacing(2),margin:"auto",boxShadow:"0px 5px 15px rgba(0,0,0,0.05)",[e.breakpoints.up("sm")]:{width:"450px"}}))),Un=ne(A)((({theme:e})=>({padding:e.spacing(2),[e.breakpoints.up("sm")]:{padding:e.spacing(4)},"&::before":{content:'""',display:"block",position:"absolute",zIndex:-1,inset:0,backgroundImage:"radial-gradient(ellipse at 50% 50%, hsl(210, 100%, 97%), hsl(0, 0%, 100%))",backgroundRepeat:"no-repeat",...e.applyStyles("dark",{backgroundImage:"radial-gradient(at 50% 50%, hsla(210, 100%, 16%, 0.5), hsl(220, 30%, 5%))"})}})));function Xn(){const{register:e,handleSubmit:n,formState:{errors:a}}=te({resolver:ue(Mn),mode:"onTouched",shouldUnregister:!0}),{refreshUserInfo:i}=Tn(),[s,l]=u.useState(!1),[d,o]=u.useState(null),[h,m]=u.useState(!1),g=I(),x=t(),p="true"===new URLSearchParams(x.search).get("registered");return r.jsxs(r.Fragment,{children:[r.jsx(re,{enableColorScheme:!0}),r.jsx(Un,{direction:"column",justifyContent:"space-between",sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:r.jsx("form",{onSubmit:n((async e=>{l(!0),o(null);try{const n=await(async e=>(await fn.post("/auth/login",e)).data)({username:e.username,password:e.password});if(n.success){const e=n.data.token;localStorage.setItem("token",e),localStorage.setItem("expiration",n.data.expiration),await i(),g("/")}}catch(n){n.response?.data?.message?o(n.response.data.message):o("Đăng nhập thất bại: "+n.message)}finally{l(!1)}})),children:r.jsxs(Vn,{variant:"outlined",children:[r.jsx("img",{src:"/logo.png",height:36,width:36,alt:"logo"}),r.jsx(W,{component:"h1",variant:"h4",fontWeight:600,children:"Đăng nhập"}),p&&r.jsx(ie,{severity:"success",children:"Đăng ký thành công"}),d&&r.jsx(ie,{severity:"error",children:d}),r.jsxs(se,{fullWidth:!0,children:[r.jsx(le,{htmlFor:"username",children:"Mã số giảng viên"}),r.jsx(de,{fullWidth:!0,id:"username",placeholder:"Nhập mã số giảng viên",...e("username"),error:!!a.username,helperText:a.username?.message})]},"username"),r.jsxs(se,{fullWidth:!0,children:[r.jsx(le,{htmlFor:"password",children:"Mật khẩu"}),r.jsx(de,{fullWidth:!0,id:"password",placeholder:"Nhập mật khẩu",type:h?"text":"password",...e("password"),error:!!a.password,helperText:a.password?.message,InputProps:{endAdornment:r.jsx(oe,{position:"end",children:r.jsx(V,{onClick:()=>{m((e=>!e))},edge:"end","aria-label":"toggle password visibility",children:h?r.jsx(ce,{}):r.jsx(he,{})})})}})]},"password"),r.jsx(O,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:2,marginTop:3},children:r.jsx(c,{type:"submit",fullWidth:!0,variant:"contained",disabled:s,children:s?r.jsx($,{size:24}):"Đăng nhập"})}),r.jsx(D,{sx:{marginY:2}}),r.jsxs(W,{sx:{textAlign:"center"},children:["Chưa có tài khoản?"," ",r.jsx(K,{href:"/dang-ky",variant:"body2",sx:{alignSelf:"center"},children:"Đăng ký"})]})]})})})]})}const Gn=async()=>(await fn.get("/departments")).data,Qn=async e=>(await fn.get(`/departments/by-manager/${e}`)).data,$n=async()=>(await fn.get("/fields")).data;var On=(e=>(e[e.Unknown=0]="Unknown",e[e.CN=1]="CN",e[e.ThS=2]="ThS",e[e.TS=3]="TS",e[e.PGS_TS=4]="PGS_TS",e[e.GS_TS=5]="GS_TS",e))(On||{}),Yn=(e=>(e[e.Unknown=0]="Unknown",e[e.ChuyenVien=1]="ChuyenVien",e[e.ChuyenVienChinh=2]="ChuyenVienChinh",e[e.ChuyenVienCaoCap=3]="ChuyenVienCaoCap",e[e.TroGiang=4]="TroGiang",e[e.GiangVien=5]="GiangVien",e[e.GiangVienChinh=6]="GiangVienChinh",e[e.GiangVienCaoCap=7]="GiangVienCaoCap",e[e.GiaoVien=8]="GiaoVien",e))(Yn||{});const Zn=ne(ae)((({theme:e})=>({display:"flex",flexDirection:"column",alignSelf:"center",width:"100%",padding:e.spacing(6),gap:e.spacing(2),margin:"auto",boxShadow:"0px 5px 15px rgba(0,0,0,0.05)",[e.breakpoints.up("sm")]:{width:"450px"}}))),_n=ne(A)((({theme:e})=>({padding:e.spacing(2),[e.breakpoints.up("sm")]:{padding:e.spacing(4)},"&::before":{content:'""',display:"block",position:"absolute",zIndex:-1,inset:0,backgroundImage:"radial-gradient(ellipse at 50% 50%, hsl(210, 100%, 97%), hsl(0, 0%, 100%))",backgroundRepeat:"no-repeat",...e.applyStyles("dark",{backgroundImage:"radial-gradient(at 50% 50%, hsla(210, 100%, 16%, 0.5), hsl(220, 30%, 5%))"})}}))),Jn=J({username:ee().regex(/^\d{9}$/,"Mã số giảng viên phải gồm 9 số"),password:ee().min(6,"Mật khẩu phải có ít nhất 6 ký tự"),confirmPassword:ee().min(6,"Vui lòng xác nhận mật khẩu")}).refine((e=>e.password===e.confirmPassword),{message:"Mật khẩu không khớp",path:["confirmPassword"]}),ea=J({email:ee().email("Email không hợp lệ"),fullname:ee().min(2,"Họ và tên là bắt buộc"),phoneNumber:ee().regex(/^(0|\+84)(3[2-9]|5[689]|7[06-9]|8[1-9]|9[0-9])\d{7}$/,"Vui lòng nhập số điện thoại"),specialization:ee().min(1,"Chuyên ngành là bắt buộc"),academicTitle:ee().min(1,"Vui lòng chọn học hàm / học vị"),officerRank:ee().min(1,"Vui lòng chọn ngạch viên chức"),departmentId:ee().min(1,"Vui lòng chọn phòng ban"),fieldId:ee().min(1,"Vui lòng chọn lĩnh vực")}),na=()=>{const[e,n]=u.useState(1),[a,t]=u.useState([]),[i,s]=u.useState([]),[l,d]=u.useState(null),[o,h]=u.useState(!1),[m,g]=u.useState(!1),[x,p]=u.useState(!1),j=1===e?0:50,y=te({resolver:ue(Jn),defaultValues:{username:"",password:"",confirmPassword:""}}),f=te({resolver:ue(ea),defaultValues:{email:"",fullname:"",phoneNumber:"",specialization:"",academicTitle:"",officerRank:"",departmentId:"",fieldId:""}});u.useEffect((()=>{!async function(){const e=await Gn();t(e.data||[]);const n=await $n();s(n.data||[])}()}),[]);const v=()=>{g(!m)},w=()=>{p(!x)};return r.jsxs(r.Fragment,{children:[r.jsx(re,{enableColorScheme:!0}),r.jsx(_n,{direction:"column",justifyContent:"space-between",sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2,minHeight:"100vh"},children:r.jsxs(Zn,{variant:"outlined",children:[r.jsx("img",{src:"/logo.png",height:36,width:36,alt:"logo"}),r.jsx(W,{component:"h1",variant:"h4",fontWeight:600,children:"Đăng ký"}),r.jsx(me,{variant:"determinate",value:j,sx:{width:"100%",maxWidth:450}}),l&&r.jsx(ie,{severity:"error",children:l}),1===e?r.jsx("form",{onSubmit:y.handleSubmit((()=>{n(2)})),children:r.jsxs(A,{spacing:3,sx:{mt:2},children:[r.jsx(ge,{name:"username",control:y.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(le,{htmlFor:"username",children:"Mã số giảng viên"}),r.jsx(de,{...e,id:"username",placeholder:"Nhập mã số giảng viên",fullWidth:!0,error:!!n.error,helperText:n.error?.message})]})},"username"),r.jsx(ge,{name:"password",control:y.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(le,{htmlFor:"password",children:"Mật khẩu"}),r.jsx(de,{...e,id:"password",placeholder:"Nhập mật khẩu",type:m?"text":"password",fullWidth:!0,error:!!n.error,helperText:n.error?.message,InputProps:{endAdornment:r.jsx(oe,{position:"end",children:r.jsx(V,{onClick:v,edge:"end",children:m?r.jsx(ce,{}):r.jsx(he,{})})})}})]})},"password"),r.jsx(ge,{name:"confirmPassword",control:y.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(le,{htmlFor:"confirmPassword",children:"Xác nhận mật khẩu"}),r.jsx(de,{...e,id:"confirmPassword",placeholder:"Nhập lại mật khẩu",type:x?"text":"password",fullWidth:!0,error:!!n.error,helperText:n.error?.message,InputProps:{endAdornment:r.jsx(oe,{position:"end",children:r.jsx(V,{onClick:w,edge:"end",children:x?r.jsx(ce,{}):r.jsx(he,{})})})}})]})},"confirmPassword"),r.jsx(c,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,disabled:o,children:"Tiếp tục"})]})}):r.jsx("form",{onSubmit:f.handleSubmit((async e=>{h(!0),d(null);try{const n=y.getValues(),a={username:n.username,password:n.password,email:e.email,fullname:e.fullname,phoneNumber:e.phoneNumber,specialization:e.specialization,academicTitle:e.academicTitle||"",officerRank:e.officerRank||"",departmentId:e.departmentId,fieldId:e.fieldId},t=await(async e=>(await fn.post("/auth/register",e)).data)(a);t.success?window.location.href="/dang-nhap?registered=true":d(t.message||"Đăng ký không thành công. Vui lòng thử lại.")}catch(n){d("Có lỗi xảy ra. Vui lòng thử lại sau.")}finally{h(!1)}})),children:r.jsxs(A,{spacing:3,sx:{mt:2},children:[r.jsx(ge,{name:"fullname",control:f.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(le,{htmlFor:"fullname",children:"Họ và tên"}),r.jsx(de,{...e,id:"fullname",placeholder:"Nhập họ và tên",fullWidth:!0,error:!!n.error,helperText:n.error?.message})]})},"fullname"),r.jsx(ge,{name:"email",control:f.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(le,{htmlFor:"email",children:"Email"}),r.jsx(de,{...e,id:"email",placeholder:"Nhập email",type:"email",fullWidth:!0,error:!!n.error,helperText:n.error?.message})]})},"email"),r.jsx(ge,{name:"phoneNumber",control:f.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(le,{htmlFor:"phoneNumber",children:"SĐT"}),r.jsx(de,{...e,id:"phoneNumber",placeholder:"Nhập số điện thoại",fullWidth:!0,error:!!n.error,helperText:n.error?.message})]})},"phoneNumber"),r.jsx(ge,{name:"specialization",control:f.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(le,{htmlFor:"specialization",children:"Chuyên ngành"}),r.jsx(de,{...e,id:"specialization",placeholder:"Nhập chuyên ngành",fullWidth:!0,error:!!n.error,helperText:n.error?.message})]})},"specialization"),r.jsx(ge,{name:"fieldId",control:f.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(xe,{children:"Ngành"}),r.jsx(pe,{...e,label:"Ngành",children:i.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))}),n.error&&r.jsx(W,{color:"error",variant:"caption",children:n.error.message})]})},"fieldId"),r.jsx(ge,{name:"departmentId",control:f.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(xe,{children:"Đơn vị công tác"}),r.jsx(pe,{...e,label:"Đơn vị công tác",children:a.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))}),n.error&&r.jsx(W,{color:"error",variant:"caption",children:n.error.message})]})},"departmentId"),r.jsx(ge,{name:"academicTitle",control:f.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(xe,{children:"Học hàm / học vị"}),r.jsx(pe,{...e,label:"Học hàm / học vị",children:Object.entries(On).filter((([e])=>isNaN(Number(e)))).map((([e])=>r.jsx(Q,{value:e,children:Wn(e)},e)))}),n.error&&r.jsx(W,{color:"error",variant:"caption",children:n.error.message})]})},"academicTitle"),r.jsx(ge,{name:"officerRank",control:f.control,render:({field:e,fieldState:n})=>r.jsxs(se,{fullWidth:!0,error:!!n.error,children:[r.jsx(xe,{children:"Ngạch viên chức"}),r.jsx(pe,{...e,label:"Ngạch viên chức",children:Object.entries(Yn).filter((([e])=>isNaN(Number(e)))).map((([e])=>r.jsx(Q,{value:e,children:Rn(e)},e)))}),n.error&&r.jsx(W,{color:"error",variant:"caption",children:n.error.message})]})},"officerRank"),r.jsxs(A,{direction:"row",spacing:2,children:[r.jsx(c,{variant:"outlined",onClick:()=>{n(1)},fullWidth:!0,disabled:o,children:"Quay lại"}),r.jsx(c,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,disabled:o,children:o?r.jsx($,{size:24}):"Đăng ký"})]})]})}),r.jsx(D,{sx:{marginY:2}}),r.jsxs(W,{sx:{textAlign:"center"},children:["Đã có tài khoản?"," ",r.jsx(K,{href:"/dang-nhap",variant:"body2",sx:{alignSelf:"center"},children:"Đăng nhập"})]})]})})]})};function aa(){const{data:e,isLoading:n,isSuccess:a,error:t}=B({queryKey:["global-notifications"],queryFn:Hn});return u.useEffect((()=>{a&&e&&T.success(e.message,{toastId:"fetch-global-notifications-success"})}),[]),u.useEffect((()=>{t&&T.error("Có lỗi đã xảy ra: "+t.message)}),[t]),n?r.jsx($,{}):e?.data&&Array.isArray(e.data)?r.jsx(r.Fragment,{children:e.data.map((e=>r.jsx(ie,{severity:"info",sx:{mb:2},children:r.jsx(W,{variant:"body1",children:e.content})},e.id)))}):r.jsx("div",{children:"Không có thông báo nào để hiển thị."})}function ta(){const e=I();return r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",gap:2,mb:4,children:[r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/factors"),size:"large",sx:{width:250},children:"Hệ số chấm điểm"}),r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/author-roles"),size:"large",sx:{width:250},children:"Vai trò tác giả"}),r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/purposes"),size:"large",sx:{width:250},children:"Mục đích quy đổi"}),r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/system-config"),size:"large",sx:{width:250},children:"Cấu hình hệ thống"})]}),r.jsxs(O,{display:"flex",gap:2,mb:4,children:[r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/work-types"),size:"large",sx:{width:250},children:"Loại công trình"}),r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/work-levels"),size:"large",sx:{width:250},children:"Cấp công trình"}),r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/scimago-fields"),size:"large",sx:{width:250},children:"Ngành SCImago"})]}),r.jsxs(O,{display:"flex",gap:2,mb:4,children:[r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/fields"),size:"large",sx:{width:250},children:"Ngành"}),r.jsx(c,{variant:"outlined",onClick:()=>e("/settings/departments"),size:"large",sx:{width:250},children:"Đơn vị"})]})]})}const ra=({columns:e,data:n})=>r.jsx(je,{rows:n,columns:e,initialState:{pagination:{paginationModel:{page:0,pageSize:10}}},pageSizeOptions:[10,15,25],disableRowSelectionOnClick:!0,localeText:ye.components.MuiDataGrid.defaultProps.localeText}),ia=async()=>(await fn.get("/authorroles")).data,sa=async e=>(await fn.get(`/authorroles/work-type/${e}`)).data,la=async()=>(await fn.get("/worktypes")).data,da=J({name:ee().min(2,"Tên vai trò tác giả phải có ít nhất 2 ký tự"),workTypeId:ee().uuid("Vui lòng chọn loại công trình"),isMainAuthor:fe()});function oa({open:e,handleClose:n,data:a}){const t=z(),{data:d,isLoading:h}=B({queryKey:["workTypes"],queryFn:la}),{control:m,handleSubmit:g,setValue:x,reset:p,formState:{errors:j}}=te({resolver:ue(da),defaultValues:{name:"",workTypeId:"",isMainAuthor:!1}});u.useEffect((()=>{a?(x("name",a.name),x("workTypeId",a.workTypeId),x("isMainAuthor",a.isMainAuthor)):p()}),[a,x,p]);const y=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/authorroles/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/authorroles",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["authorRoles"]}),T.success(a?.id?"Vai trò tác giả đã được cập nhật":"Vai trò tác giả đã được thêm"),n()},onError:e=>{console.error("API Error:",e),T.error("Đã xảy ra lỗi: "+e.message)}});return r.jsxs(i,{open:e,onClose:n,maxWidth:"sm",fullWidth:!0,children:[r.jsx(s,{children:a?"Cập nhật Vai trò tác giả":"Thêm Vai trò tác giả"}),r.jsx(l,{children:r.jsxs(R,{container:!0,spacing:2,sx:{mt:1},children:[r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"name",control:m,render:({field:e})=>r.jsx(de,{...e,label:"Tên vai trò tác giả",error:!!j.name,helperText:j.name?.message,fullWidth:!0,disabled:y.isPending})})}),r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"workTypeId",control:m,render:({field:e})=>r.jsx(de,{...e,select:!0,label:"Loại công trình",error:!!j.workTypeId,helperText:j.workTypeId?.message,fullWidth:!0,disabled:y.isPending||h,children:h?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):d?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})})}),r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"isMainAuthor",control:m,render:({field:e})=>r.jsx(we,{control:r.jsx(be,{checked:e.value,onChange:e.onChange,disabled:y.isPending}),label:"Là tác giả chính"})})})]})}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:y.isPending,children:"Hủy"}),r.jsx(c,{onClick:g((async e=>{await y.mutateAsync(e)})),variant:"contained",color:"primary",disabled:y.isPending||h,children:y.isPending?r.jsx($,{size:24}):a?"Cập nhật":"Thêm mới"})]})]})}function ca(){const e=z(),[n,a]=u.useState(""),{data:t,isLoading:d}=B({queryKey:["workTypes"],queryFn:la}),{data:h,error:m,isPending:g,isSuccess:x,dataUpdatedAt:p}=B({queryKey:["authorRoles",n],queryFn:()=>n?sa(n):ia()});u.useEffect((()=>{x&&h&&T.success(h.message,{toastId:"fetch-author-roles-success"})}),[p,x,h]),u.useEffect((()=>{m&&T.error("Có lỗi đã xảy ra: "+m.message)}),[m]);const[j,y]=u.useState(!1),[f,v]=u.useState(null),w=e=>{v(e),y(!0)},[b,k]=u.useState(!1),[C,I]=u.useState(null),S=()=>{I(null),k(!1)},N=ve({mutationFn:e=>(async e=>(await fn.delete(`/authorroles/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa vai trò tác giả thành công!"),e.invalidateQueries({queryKey:["authorRoles"]}),k(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),q=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=Array.from(e.api.getAllRowIds()).findIndex((n=>n===e.row.id));return r.jsx("div",{children:n+1})}},{field:"name",headerName:"Tên vai trò tác giả",type:"string",width:300},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:300},{field:"isMainAuthor",headerName:"Tác giả chính",width:150,renderCell:e=>e.row.isMainAuthor?r.jsx(Ce,{icon:r.jsx(Ie,{}),label:"Tác giả chính",color:"success",variant:"outlined"}):r.jsx(Ce,{icon:r.jsx(Te,{}),label:"Thành viên",color:"default",variant:"outlined"})},{field:"actions",headerName:"Thao tác",width:200,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,void w(n);var n},sx:{marginRight:1},disabled:N.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,I(n),void k(!0);var n},disabled:N.isPending,children:"Xóa"})]})}];return g&&d?r.jsx($,{}):m?r.jsxs("p",{children:["Lỗi: ",m.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{marginBottom:2},children:[r.jsx(W,{variant:"h4",children:"Quản lý vai trò tác giả"}),r.jsxs(O,{display:"flex",alignItems:"center",gap:2,children:[r.jsxs(se,{sx:{minWidth:220},children:[r.jsx(xe,{id:"work-type-filter-label",children:"Lọc theo loại công trình"}),r.jsxs(pe,{labelId:"work-type-filter-label",id:"work-type-filter",value:n,onChange:e=>{a(e.target.value)},label:"Lọc theo loại công trình",children:[r.jsx(Q,{value:"",children:"Tất cả"}),t?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]}),r.jsx(c,{variant:"contained",onClick:()=>w(null),children:"Thêm vai trò tác giả"})]})]}),r.jsx(ke,{sx:{width:"100%",overflow:"hidden"},children:r.jsx(ra,{columns:q,data:h?.data||[]})}),r.jsx(oa,{open:j,handleClose:()=>y(!1),data:f}),r.jsxs(i,{open:b,onClose:S,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa vai trò tác giả này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:S,disabled:N.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{C&&N.mutate(C)},color:"error",variant:"contained",disabled:N.isPending,children:N.isPending?r.jsx($,{size:24}):"Xóa"})]})]})]})}const ha=J({name:ee().min(2,"Tên phòng ban phải có ít nhất 2 ký tự")});function ua({open:e,handleClose:n,data:a}){const t=z(),{register:d,handleSubmit:h,setValue:m,reset:g,formState:{errors:x,isSubmitting:p}}=te({resolver:ue(ha),defaultValues:{name:""}});u.useEffect((()=>{a?m("name",a.name):g()}),[a,e,m,g]);const j=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/departments/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/departments",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["departments"]}),T.success(a?.id?"Phòng ban đã được cập nhật":"Phòng ban đã được thêm"),n()},onError:e=>{console.error("API Error:",e)}});return r.jsxs(i,{open:e,onClose:n,children:[r.jsx(s,{children:a?"Cập nhật Phòng Ban":"Thêm Phòng Ban"}),r.jsx(l,{children:r.jsx(de,{label:"Tên phòng ban",...d("name"),error:!!x.name,helperText:x.name?.message,fullWidth:!0,margin:"dense",disabled:p})}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:p,children:"Hủy"}),r.jsx(c,{onClick:h((async e=>{await j.mutateAsync(e)})),variant:"contained",color:"primary",disabled:p,children:p?"Đang lưu...":"Lưu"})]})]})}function ma(){const e=z(),{data:n,error:a,isPending:t,isSuccess:d,dataUpdatedAt:h}=B({queryKey:["departments"],queryFn:Gn});u.useEffect((()=>{d&&n&&T.success(n.message,{toastId:"fetch-departments-success"})}),[h]),u.useEffect((()=>{a&&T.error("Có lỗi đã xảy ra: "+a.message)}),[a]);const[m,g]=u.useState(!1),[x,p]=u.useState(null),j=e=>{p(e),g(!0)},[y,f]=u.useState(!1),[v,w]=u.useState(null),b=()=>{w(null),f(!1)},k=ve({mutationFn:e=>(async e=>(await fn.delete(`/departments/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa đơn vị thành công!"),e.invalidateQueries({queryKey:["departments"]}),f(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),C=[{field:"name",headerName:"Tên đơn vị",type:"string",width:500},{field:"actions",headerName:"",width:500,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,void j(n);var n},sx:{marginRight:1},disabled:k.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,w(n),void f(!0);var n},disabled:k.isPending,children:"Xóa"})]})}];return t?r.jsx($,{}):a?r.jsxs("p",{children:["Error: ",a.message]}):r.jsxs(r.Fragment,{children:[r.jsx(O,{display:"flex",flexDirection:"column-reverse",alignItems:"flex-end",sx:{marginBottom:2},children:r.jsx(c,{variant:"contained",onClick:()=>j(null),children:"Thêm đơn vị"})}),r.jsx(ke,{sx:{width:1010,marginX:"auto"},children:r.jsx(ra,{columns:C,data:n?.data||[]})}),r.jsx(ua,{open:m,handleClose:()=>g(!1),data:x}),r.jsxs(i,{open:y,onClose:b,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa đơn vị này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:b,disabled:k.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{v&&k.mutate(v)},color:"error",variant:"contained",disabled:k.isPending,children:k.isPending?"Đang xóa...":"Xóa"})]})]})]})}var ga=(e=>(e[e.BaiBaoTopMuoi=1]="BaiBaoTopMuoi",e[e.BaiBaoTopBaMuoi=2]="BaiBaoTopBaMuoi",e[e.BaiBaoTopNamMuoi=3]="BaiBaoTopNamMuoi",e[e.BaiBaoTopConLai=4]="BaiBaoTopConLai",e[e.BaiBaoMotDiem=5]="BaiBaoMotDiem",e[e.BaiBaoNuaDiem=6]="BaiBaoNuaDiem",e[e.BaiBaoKhongBayNamDiem=7]="BaiBaoKhongBayNamDiem",e[e.HDSVDatGiaiKK=8]="HDSVDatGiaiKK",e[e.HDSVDatGiaiBa=9]="HDSVDatGiaiBa",e[e.HDSVDatGiaiNhi=10]="HDSVDatGiaiNhi",e[e.HDSVDatGiaiNhat=11]="HDSVDatGiaiNhat",e[e.HDSVConLai=12]="HDSVConLai",e[e.TacPhamNgheThuatCapTruong=13]="TacPhamNgheThuatCapTruong",e[e.TacPhamNgheThuatCapTinhThanhPho=14]="TacPhamNgheThuatCapTinhThanhPho",e[e.TacPhamNgheThuatCapQuocGia=15]="TacPhamNgheThuatCapQuocGia",e[e.TacPhamNgheThuatCapQuocTe=16]="TacPhamNgheThuatCapQuocTe",e[e.ThanhTichHuanLuyenCapQuocGia=17]="ThanhTichHuanLuyenCapQuocGia",e[e.ThanhTichHuanLuyenCapQuocTe=18]="ThanhTichHuanLuyenCapQuocTe",e[e.GiaiPhapHuuIchCapTinhThanhPho=19]="GiaiPhapHuuIchCapTinhThanhPho",e[e.GiaiPhapHuuIchCapQuocGia=20]="GiaiPhapHuuIchCapQuocGia",e[e.GiaiPhapHuuIchCapQuocTe=21]="GiaiPhapHuuIchCapQuocTe",e[e.KetQuaNghienCuu=22]="KetQuaNghienCuu",e[e.Sach=23]="Sach",e))(ga||{});const xa=e=>{if(null==e)return"-";switch(e){case ga.BaiBaoTopMuoi:return"Top 10%";case ga.BaiBaoTopBaMuoi:return"Top 30%";case ga.BaiBaoTopNamMuoi:return"Top 50%";case ga.BaiBaoTopConLai:return"Top còn lại";case ga.BaiBaoMotDiem:return"Bài báo 1 điểm";case ga.BaiBaoNuaDiem:return"Bài báo 0.5 điểm";case ga.BaiBaoKhongBayNamDiem:return"Bài báo 0.75 điểm";case ga.HDSVDatGiaiKK:return"HDSV đạt giải KK";case ga.HDSVDatGiaiBa:return"HDSV đạt giải Ba";case ga.HDSVDatGiaiNhi:return"HDSV đạt giải Nhì";case ga.HDSVDatGiaiNhat:return"HDSV đạt giải Nhất";case ga.HDSVConLai:return"HDSV còn lại";case ga.TacPhamNgheThuatCapTruong:return"Tác phẩm nghệ thuật cấp trường";case ga.TacPhamNgheThuatCapTinhThanhPho:return"Tác phẩm nghệ thuật cấp tỉnh/thành phố";case ga.TacPhamNgheThuatCapQuocGia:return"Tác phẩm nghệ thuật cấp quốc gia";case ga.TacPhamNgheThuatCapQuocTe:return"Tác phẩm nghệ thuật cấp quốc tế";case ga.ThanhTichHuanLuyenCapQuocGia:return"Thành tích huấn luyện cấp quốc gia";case ga.ThanhTichHuanLuyenCapQuocTe:return"Thành tích huấn luyện cấp quốc tế";case ga.GiaiPhapHuuIchCapTinhThanhPho:return"Giải pháp hữu ích cấp tỉnh/thành phố";case ga.GiaiPhapHuuIchCapQuocGia:return"Giải pháp hữu ích cấp quốc gia";case ga.GiaiPhapHuuIchCapQuocTe:return"Giải pháp hữu ích cấp quốc tế";case ga.KetQuaNghienCuu:return"Kết quả nghiên cứu";case ga.Sach:return"Sách";default:return"-"}},pa=e=>{if(null==e)return"Chưa có mức điểm";switch(e){case ga.BaiBaoTopMuoi:return"Bài báo khoa học thuộc top 10% tạp chí hàng đầu";case ga.BaiBaoTopBaMuoi:return"Bài báo khoa học thuộc top 30% tạp chí hàng đầu";case ga.BaiBaoTopNamMuoi:return"Bài báo khoa học thuộc top 50% tạp chí hàng đầu";case ga.BaiBaoTopConLai:return"Bài báo khoa học thuộc top còn lại tạp chí hàng đầu";case ga.BaiBaoMotDiem:return"Bài báo 1 điểm";case ga.BaiBaoNuaDiem:return"Bài báo 0.5 điểm";case ga.BaiBaoKhongBayNamDiem:return"Bài báo 0.75 điểm";case ga.HDSVDatGiaiKK:return"Hướng dẫn đề tài NCKH đạt giải Khuyến khích";case ga.HDSVDatGiaiBa:return"Hướng dẫn đề tài NCKH đạt giải Ba";case ga.HDSVDatGiaiNhi:return"Hướng dẫn đề tài NCKH đạt giải Nhì";case ga.HDSVDatGiaiNhat:return"Hướng dẫn đề tài NCKH đạt giải Nhất";case ga.HDSVConLai:return"Hướng dẫn sinh viên NCKH còn lại";case ga.TacPhamNgheThuatCapTruong:return"Tác phẩm nghệ thuật cấp trường";case ga.TacPhamNgheThuatCapTinhThanhPho:return"Tác phẩm nghệ thuật cấp tỉnh/thành phố";case ga.TacPhamNgheThuatCapQuocGia:return"Tác phẩm nghệ thuật cấp quốc gia";case ga.TacPhamNgheThuatCapQuocTe:return"Tác phẩm nghệ thuật cấp quốc tế";case ga.ThanhTichHuanLuyenCapQuocGia:return"Thành tích huấn luyện cấp quốc gia";case ga.ThanhTichHuanLuyenCapQuocTe:return"Thành tích huấn luyện cấp quốc tế";case ga.GiaiPhapHuuIchCapTinhThanhPho:return"Giải pháp hữu ích cấp tỉnh/thành phố";case ga.GiaiPhapHuuIchCapQuocGia:return"Giải pháp hữu ích cấp quốc gia";case ga.GiaiPhapHuuIchCapQuocTe:return"Giải pháp hữu ích cấp quốc tế";case ga.KetQuaNghienCuu:return"Kết quả nghiên cứu";case ga.Sach:return"Sách";default:return"-"}},ja=async()=>(await fn.get("/worklevels")).data,ya=async e=>(await fn.get(`/worklevels/work-type/${e}`)).data,fa=async()=>(await fn.get("/purposes")).data,va=async e=>(await fn.get(`/purposes/work-type/${e}`)).data,wa=J({name:ee().min(1,"Tên hệ số không được để trống"),workTypeId:ee().uuid("Vui lòng chọn loại công trình"),workLevelId:ee().uuid("Vui lòng chọn cấp công trình").optional().nullable(),purposeId:ee().uuid("Vui lòng chọn mục đích quy đổi"),authorRoleId:ee().uuid("Vui lòng chọn vai trò tác giả").optional().nullable(),scoreLevel:Se().int().min(1,"Vui lòng chọn mức điểm"),convertHour:Se().min(0,"Giờ quy đổi phải là số dương"),maxAllowed:Se().min(0,"Số tối đa phải là số dương")});function ba({open:e,handleClose:n,data:a}){const t=z(),[d,h]=u.useState(""),{data:m,isLoading:g}=B({queryKey:["workTypes"],queryFn:la}),{data:x,isLoading:p}=B({queryKey:["workLevels",d],queryFn:()=>ya(d),enabled:!!d}),{data:j,isLoading:y}=B({queryKey:["purposes",d],queryFn:()=>va(d),enabled:!!d}),{data:f,isLoading:v}=B({queryKey:["authorRoles",d],queryFn:()=>sa(d),enabled:!!d}),{control:w,handleSubmit:b,setValue:k,reset:C,watch:I,formState:{errors:S}}=te({resolver:ue(wa),defaultValues:{name:"",workTypeId:"",workLevelId:null,purposeId:"",authorRoleId:null,scoreLevel:ga.BaiBaoTopMuoi,convertHour:0,maxAllowed:0}}),N=I("workTypeId");u.useEffect((()=>{N!==d&&h(N)}),[N,d]),u.useEffect((()=>{a?(k("name",a.name||""),k("workTypeId",a.workTypeId),k("workLevelId",a.workLevelId),k("purposeId",a.purposeId),k("authorRoleId",a.authorRoleId||null),k("scoreLevel",a.scoreLevel),k("convertHour",a.convertHour),k("maxAllowed",a.maxAllowed),h(a.workTypeId)):C()}),[a,k,C]),u.useEffect((()=>{d&&!a&&(k("workLevelId",null),k("purposeId",""),k("authorRoleId",null))}),[d,k,a]);const q=ve({mutationFn:async e=>{const n={...e,workLevelId:e.workLevelId||void 0,authorRoleId:e.authorRoleId||void 0,name:e.name};return a?.id?(async(e,n)=>(await fn.put(`/factors/${e}`,n)).data)(a.id,n):(async e=>(await fn.post("/factors",e)).data)(n)},onSuccess:()=>{t.invalidateQueries({queryKey:["factors"]}),T.success(a?.id?"Hệ số quy đổi đã được cập nhật":"Hệ số quy đổi đã được thêm"),n()},onError:e=>{console.error("API Error:",e),T.error("Đã xảy ra lỗi: "+e.message)}});return r.jsxs(i,{open:e,onClose:n,maxWidth:"md",fullWidth:!0,children:[r.jsx(s,{children:a?"Cập nhật Hệ số quy đổi":"Thêm Hệ số quy đổi"}),r.jsx(l,{children:r.jsxs(R,{container:!0,spacing:2,sx:{mt:1},children:[r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"name",control:w,render:({field:e})=>r.jsx(de,{...e,label:"Tên hệ số",error:!!S.name,helperText:S.name?.message,fullWidth:!0,disabled:q.isPending})})}),r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"workTypeId",control:w,render:({field:e})=>r.jsx(de,{...e,select:!0,label:"Loại công trình",error:!!S.workTypeId,helperText:S.workTypeId?.message,fullWidth:!0,disabled:q.isPending||g,children:g?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):m?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})})}),r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(ge,{name:"workLevelId",control:w,render:({field:e})=>r.jsxs(de,{...e,select:!0,label:"Cấp công trình",error:!!S.workLevelId,helperText:S.workLevelId?.message,fullWidth:!0,disabled:!d||q.isPending||p,value:e.value||"",children:[r.jsx(Q,{value:"",children:"Không chọn"}),p?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):x?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})})}),r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(ge,{name:"purposeId",control:w,render:({field:e})=>r.jsx(de,{...e,select:!0,label:"Mục đích quy đổi",error:!!S.purposeId,helperText:S.purposeId?.message,fullWidth:!0,disabled:!d||q.isPending||y,children:y?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):j?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})})}),r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(ge,{name:"authorRoleId",control:w,render:({field:e})=>r.jsxs(de,{...e,select:!0,label:"Vai trò tác giả",error:!!S.authorRoleId,helperText:S.authorRoleId?.message,fullWidth:!0,disabled:!d||q.isPending||v,value:e.value||"",children:[r.jsx(Q,{value:"",children:"Không chọn"}),v?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):f?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})})}),r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(ge,{name:"scoreLevel",control:w,render:({field:e})=>r.jsx(de,{...e,select:!0,label:"Mức điểm",error:!!S.scoreLevel,helperText:S.scoreLevel?.message,fullWidth:!0,disabled:q.isPending,onChange:n=>e.onChange(Number(n.target.value)),value:e.value,children:Object.values(ga).filter((e=>"number"==typeof e)).map((e=>r.jsx(Q,{value:e,children:pa(e)},e)))})})}),r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(ge,{name:"convertHour",control:w,render:({field:e})=>r.jsx(de,{...e,label:"Giờ quy đổi",type:"number",error:!!S.convertHour,helperText:S.convertHour?.message,fullWidth:!0,disabled:q.isPending,inputProps:{step:.5,min:0},onChange:n=>e.onChange(Number(n.target.value))})})}),r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(ge,{name:"maxAllowed",control:w,render:({field:e})=>r.jsx(de,{...e,label:"Số công trình tối đa được phép quy đổi",type:"number",error:!!S.maxAllowed,helperText:S.maxAllowed?.message,fullWidth:!0,disabled:q.isPending,inputProps:{step:1,min:0},onChange:n=>e.onChange(Number(n.target.value))})})})]})}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:q.isPending,children:"Hủy"}),r.jsx(c,{onClick:b((async e=>{await q.mutateAsync(e)})),variant:"contained",color:"primary",disabled:q.isPending||g||!!d&&(p||y||v),children:q.isPending?r.jsx($,{size:24}):a?"Cập nhật":"Thêm mới"})]})]})}function ka(){const e=z(),[n,a]=u.useState(""),{data:t,isLoading:d}=B({queryKey:["workTypes"],queryFn:la}),{data:h,error:m,isPending:g,isSuccess:x,dataUpdatedAt:p}=B({queryKey:["factors",n],queryFn:()=>n?(async e=>(await fn.get(`/factors/work-type/${e}`)).data)(n):(async()=>(await fn.get("/factors")).data)()});u.useEffect((()=>{x&&h&&T.success(h.message,{toastId:"fetch-factors-success"})}),[p,x,h]),u.useEffect((()=>{m&&T.error("Có lỗi đã xảy ra: "+m.message)}),[m]);const[j,y]=u.useState(!1),[f,v]=u.useState(null),w=e=>{v(e),y(!0)},[b,k]=u.useState(!1),[C,I]=u.useState(null),S=()=>{I(null),k(!1)},N=ve({mutationFn:e=>(async e=>(await fn.delete(`/factors/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa hệ số quy đổi thành công!"),e.invalidateQueries({queryKey:["factors"]}),k(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),q=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=Array.from(e.api.getAllRowIds()).findIndex((n=>n===e.row.id));return r.jsx("div",{children:n+1})}},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:180},{field:"workLevelName",headerName:"Cấp công trình",type:"string",width:150},{field:"purposeName",headerName:"Mục đích quy đổi",type:"string",width:150},{field:"name",headerName:"Tên hệ số",type:"string",width:200},{field:"scoreLevel",headerName:"Mức điểm",width:160,renderCell:e=>r.jsx("div",{children:xa(e.row.scoreLevel)})},{field:"convertHour",headerName:"Giờ quy đổi",type:"number",width:120},{field:"maxAllowed",headerName:"Giới hạn đánh dấu",type:"number",width:150},{field:"actions",headerName:"Thao tác",width:200,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,void w(n);var n},sx:{marginRight:1},disabled:N.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,I(n),void k(!0);var n},disabled:N.isPending,children:"Xóa"})]})}];return g&&d?r.jsx($,{}):m?r.jsxs("p",{children:["Lỗi: ",m.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{marginBottom:2},children:[r.jsx(W,{variant:"h4",children:"Quản lý hệ số quy đổi"}),r.jsxs(O,{display:"flex",alignItems:"center",gap:2,children:[r.jsxs(se,{sx:{minWidth:220},children:[r.jsx(xe,{id:"work-type-filter-label",children:"Lọc theo loại công trình"}),r.jsxs(pe,{labelId:"work-type-filter-label",id:"work-type-filter",value:n,onChange:e=>{a(e.target.value)},label:"Lọc theo loại công trình",children:[r.jsx(Q,{value:"",children:"Tất cả"}),t?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]}),r.jsx(c,{variant:"contained",onClick:()=>w(null),children:"Thêm hệ số quy đổi"})]})]}),r.jsx(ke,{sx:{width:"100%",overflow:"hidden"},children:r.jsx(ra,{columns:q,data:h?.data||[]})}),r.jsx(ba,{open:j,handleClose:()=>y(!1),data:f}),r.jsxs(i,{open:b,onClose:S,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa hệ số quy đổi này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:S,disabled:N.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{C&&N.mutate(C)},color:"error",variant:"contained",disabled:N.isPending,children:N.isPending?r.jsx($,{size:24}):"Xóa"})]})]})]})}const Ca=J({name:ee().min(2,"Tên ngành phải có ít nhất 2 ký tự")});function Ia({open:e,handleClose:n,data:a}){const t=z(),{register:d,handleSubmit:h,setValue:m,reset:g,formState:{errors:x,isSubmitting:p}}=te({resolver:ue(Ca),defaultValues:{name:""}});u.useEffect((()=>{a?m("name",a.name):g()}),[a,e,m,g]);const j=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/fields/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/fields",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["fields"]}),T.success(a?.id?"Ngành đã được cập nhật":"Ngành đã được thêm"),n()},onError:e=>{console.error("API Error:",e)}});return r.jsxs(i,{open:e,onClose:n,children:[r.jsx(s,{children:a?"Cập nhật Ngành":"Thêm Ngành"}),r.jsx(l,{children:r.jsx(de,{label:"Tên ngành",...d("name"),error:!!x.name,helperText:x.name?.message,fullWidth:!0,margin:"dense",disabled:p})}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:p,children:"Hủy"}),r.jsx(c,{onClick:h((async e=>{await j.mutateAsync(e)})),variant:"contained",color:"primary",disabled:p,children:p?"Đang lưu...":"Lưu"})]})]})}function Ta(){const e=z(),{data:n,error:a,isPending:t,isSuccess:d,dataUpdatedAt:h}=B({queryKey:["fields"],queryFn:$n});u.useEffect((()=>{d&&n&&T.success(n.message,{toastId:"fetch-fields-success"})}),[h]),u.useEffect((()=>{a&&T.error("Có lỗi đã xảy ra: "+a.message)}),[a]);const[m,g]=u.useState(!1),[x,p]=u.useState(null),j=e=>{p(e),g(!0)},[y,f]=u.useState(!1),[v,w]=u.useState(null),b=()=>{w(null),f(!1)},k=ve({mutationFn:e=>(async e=>(await fn.delete(`/fields/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa ngành thành công!"),e.invalidateQueries({queryKey:["fields"]}),f(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),C=[{field:"name",headerName:"Tên ngành",type:"string",width:500},{field:"actions",headerName:"",width:500,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,void j(n);var n},sx:{marginRight:1},disabled:k.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,w(n),void f(!0);var n},disabled:k.isPending,children:"Xóa"})]})}];return t?r.jsx($,{}):a?r.jsxs("p",{children:["Error: ",a.message]}):r.jsxs(r.Fragment,{children:[r.jsx(O,{display:"flex",flexDirection:"column-reverse",alignItems:"flex-end",sx:{marginBottom:2},children:r.jsx(c,{variant:"contained",onClick:()=>j(null),children:"Thêm ngành"})}),r.jsx(ke,{sx:{width:1010,marginX:"auto"},children:r.jsx(ra,{columns:C,data:n?.data||[]})}),r.jsx(Ia,{open:m,handleClose:()=>g(!1),data:x}),r.jsxs(i,{open:y,onClose:b,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa ngành này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:b,disabled:k.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{v&&k.mutate(v)},color:"error",variant:"contained",disabled:k.isPending,children:k.isPending?"Đang xóa...":"Xóa"})]})]})]})}const Sa=async e=>(await fn.get("/works/filter",{params:e})).data,Na=e=>{if(!e)return"-";try{const n="string"==typeof e?new Date(e):e;return Ne(n,"MM/yyyy",{locale:qe})}catch{return"-"}};var qa=(e=>(e[e.HopLe=0]="HopLe",e[e.KhongHopLe=1]="KhongHopLe",e[e.ChuaXuLy=2]="ChuaXuLy",e))(qa||{});const La=async()=>(await fn.get("/scimagofields")).data,Pa=async e=>(await fn.get(`/scimagofields/work-type/${e}`)).data;function Aa(){const e=B({queryKey:["workTypes"],queryFn:la}),n=B({queryKey:["workLevels"],queryFn:ja}),a=B({queryKey:["authorRoles"],queryFn:ia}),t=B({queryKey:["purposes"],queryFn:fa}),r=B({queryKey:["scimagoFields"],queryFn:La}),i=B({queryKey:["fields"],queryFn:$n}),s=e.isLoading||n.isLoading||a.isLoading||t.isLoading||r.isLoading||i.isLoading,l=e.data?.data&&n.data?.data&&a.data?.data&&t.data?.data&&r.data?.data&&i.data?.data;return{workTypes:e.data?.data||[],workLevels:n.data?.data||[],authorRoles:a.data?.data||[],purposes:t.data?.data||[],scimagoFields:r.data?.data||[],fields:i.data?.data||[],isLoading:s,isDataReady:l}}function Wa({userId:e,worksData:n,refetchWorks:a,isAuthorPage:t=!1}){const r=z(),[i,s]=u.useState(null),[l,d]=u.useState(!1),[o,c]=u.useState(!1),[h,m]=u.useState(!1),[g,x]=u.useState(qa.ChuaXuLy),[p,j]=u.useState(""),[y,f]=u.useState(0),v=ve({mutationFn:e=>t?(async(e,n)=>(await fn.patch(`/works/${e}`,n)).data)(e.workId,e.data):(async(e,n,a)=>(await fn.patch(`/works/${e}/admin-update/${n}`,a)).data)(e.workId,e.userId,e.data),onSuccess:n=>{console.log("Dữ liệu trả về từ API:",n),console.log("Cập nhật thành công, đang invalidate queries"),t?r.invalidateQueries({queryKey:["works","my-works"]}):e&&r.invalidateQueries({queryKey:["works","user",e]})},onError:e=>{T.error("Lỗi khi cập nhật công trình: "+e.message)}}),w=ve({mutationFn:e=>(async e=>(await fn.post("/works",e)).data)(e),onSuccess:()=>{T.success("Đã thêm công trình mới thành công"),r.invalidateQueries({queryKey:["works","my-works"]}),d(!1),a&&setTimeout((()=>{a()}),100)},onError:e=>{T.error("Lỗi khi thêm công trình mới: "+e.message)}});return{selectedWork:i,openUpdateDialog:l,openStatusDialog:o,openNoteDialog:h,newStatus:g,newNote:p,activeTab:y,updateWorkMutation:v,createWorkMutation:w,handleOpenUpdateDialog:e=>{if(e){const n=localStorage.getItem("userId")||"",a=e.authors&&e.authors.length>0?{authorRoleId:e.authors[0].authorRoleId,purposeId:e.authors[0].purposeId,position:e.authors[0].position||1,scoreLevel:e.authors[0].scoreLevel,scImagoFieldId:e.authors[0].scImagoFieldId||"",fieldId:e.authors[0].fieldId||"",proofStatus:e.authors[0].proofStatus,note:e.authors[0].note||""}:e.author||{authorRoleId:"",purposeId:"",position:1,scoreLevel:void 0,scImagoFieldId:"",fieldId:"",proofStatus:qa.ChuaXuLy,note:""},t={...e,details:e.details||{},totalAuthors:e.totalAuthors||1,totalMainAuthors:e.totalMainAuthors||1,author:a,coAuthorUserIds:Array.isArray(e.coAuthorUserIds)?e.coAuthorUserIds.filter((e=>e.toString()!==n)).map((e=>e.toString())):[]};s(t)}else s(null);f(0),d(!0)},handleCloseUpdateDialog:()=>{s(null),d(!1)},handleOpenStatusDialog:e=>{s(e),e.authors&&e.authors.length>0&&x(e.authors[0].proofStatus||qa.ChuaXuLy),c(!0)},handleCloseStatusDialog:()=>{s(null),c(!1)},handleOpenNoteDialog:e=>{s(e),e.authors&&e.authors.length>0&&j(e.authors[0].note||""),m(!0)},handleCloseNoteDialog:()=>{s(null),j(""),m(!1)},handleStatusChange:e=>{x(e)},handleNoteChange:e=>{j(e)},handleStatusSubmit:()=>{if(i&&i.authors&&i.authors.length>0&&e){console.log("Cập nhật trạng thái:",g);const t={workRequest:null,authorRequest:{proofStatus:g}};v.mutate({workId:i.id,userId:e,data:t},{onSuccess:e=>{if(e.data&&n){const t=n?.data?.map((n=>n.id===e.data.id?e.data:n))||[];n&&(n.data=t),T.success("Cập nhật trạng thái thành công"),c(!1),a&&a()}}})}},handleNoteSubmit:()=>{if(i&&i.authors&&i.authors.length>0&&e){console.log("Cập nhật ghi chú:",p);const t=i.authors[0].proofStatus,r={workRequest:null,authorRequest:{note:p,proofStatus:t}};v.mutate({workId:i.id,userId:e,data:r},{onSuccess:e=>{if(e.data&&n){const t=n?.data?.map((n=>n.id===e.data.id?e.data:n))||[];n&&(n.data=t),T.success("Cập nhật ghi chú thành công"),m(!1),a&&a()}}})}},handleUpdateSubmit:r=>{let s;if(r.timePublished)try{s=new Date(r.timePublished).toISOString().split("T")[0]}catch(u){console.error("Lỗi khi chuyển đổi ngày tháng:",u)}const l=r.author.sCImagoFieldId||r.author.scImagoFieldId,o=Array.isArray(r.coAuthorUserIds)?r.coAuthorUserIds.filter((e=>e)):[],c=""===r.author.authorRoleId?null:r.author.authorRoleId,h={workRequest:{title:r.title?.trim(),timePublished:s,totalAuthors:r.totalAuthors?Number(r.totalAuthors):void 0,totalMainAuthors:r.totalMainAuthors?Number(r.totalMainAuthors):void 0,source:Number(r.source),workTypeId:r.workTypeId,workLevelId:r.workLevelId||null,details:r.details||{},coAuthorUserIds:o},authorRequest:{authorRoleId:c,purposeId:r.author.purposeId,position:r.author.position?parseInt(String(r.author.position)):void 0,scoreLevel:r.author.scoreLevel?Number(r.author.scoreLevel):null,scImagoFieldId:l||null,fieldId:r.author.fieldId||null,proofStatus:r.author.proofStatus,note:r.author.note}};if(i&&i.id)v.mutate({workId:i.id,userId:e||"",data:h},{onSuccess:e=>{if(e.data&&n){const t=n?.data?.map((n=>n.id===e.data.id?e.data:n))||[];n&&(n.data=t),T.success("Cập nhật công trình thành công"),d(!1),a&&a()}}});else if(t){const e={title:h.workRequest.title,timePublished:h.workRequest.timePublished,totalAuthors:h.workRequest.totalAuthors,totalMainAuthors:h.workRequest.totalMainAuthors,source:h.workRequest.source,workTypeId:h.workRequest.workTypeId,workLevelId:h.workRequest.workLevelId,details:h.workRequest.details,coAuthorUserIds:h.workRequest.coAuthorUserIds,author:{authorRoleId:h.authorRequest.authorRoleId,purposeId:h.authorRequest.purposeId,position:h.authorRequest.position,scoreLevel:h.authorRequest.scoreLevel,scImagoFieldId:h.authorRequest.scImagoFieldId,fieldId:h.authorRequest.fieldId}};w.mutate(e)}},setActiveTab:f}}var Da=(e=>(e[e.QuanLyNhap=0]="QuanLyNhap",e[e.NguoiDungKeKhai=1]="NguoiDungKeKhai",e))(Da||{});const Ra={"bài báo khoa học":{WoS:[{key:"Tên tạp chí khoa học",label:"Tên tạp chí khoa học",required:!0},{key:"Tên tạp chí khoa học",label:"Tên tạp chí khoa học",required:!0},{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!1},{key:"Số trang",label:"Số trang",required:!1},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!1},{key:"Cơ quản xuất bản",label:"Cơ quan xuất bản",required:!1},{key:"Loại WoS",label:"Loại WoS",required:!0},{key:"Xếp hạng tạp chí",label:"Xếp hạng tạp chí",required:!1}],Scopus:[{key:"Tên tạp chí khoa học",label:"Tên tạp chí khoa học",required:!0},{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!1},{key:"Số trang",label:"Số trang",required:!1},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!1},{key:"Cơ quản xuất bản",label:"Cơ quan xuất bản",required:!1},{key:"Xếp hạng tạp chí",label:"Xếp hạng tạp chí",required:!1}],default:[{key:"Tên tạp chí khoa học",label:"Tên tạp chí khoa học",required:!0},{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!1},{key:"Số trang",label:"Số trang",required:!1},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!1},{key:"Cơ quản xuất bản",label:"Cơ quan xuất bản",required:!1}]},"báo cáo khoa học":{WoS:[{key:"Tên ấn phẩm",label:"Tên ấn phẩm",required:!0},{key:"Tên ấn phẩm",label:"Tên ấn phẩm",required:!0},{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!1},{key:"Số trang",label:"Số trang",required:!1},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!1},{key:"Cơ quản xuất bản",label:"Cơ quan xuất bản",required:!1},{key:"Loại WoS",label:"Loại WoS",required:!0},{key:"Xếp hạng tạp chí",label:"Xếp hạng tạp chí",required:!1}],Scopus:[{key:"Tên ấn phẩm",label:"Tên ấn phẩm",required:!0},{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!1},{key:"Số trang",label:"Số trang",required:!1},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!1},{key:"Cơ quản xuất bản",label:"Cơ quan xuất bản",required:!1},{key:"Xếp hạng tạp chí",label:"Xếp hạng tạp chí",required:!1}],default:[{key:"Tên ấn phẩm",label:"Tên ấn phẩm",required:!0},{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!1},{key:"Số trang",label:"Số trang",required:!1},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!1},{key:"Cơ quản xuất bản",label:"Cơ quan xuất bản",required:!1}]},"đề tài":{default:[{key:"Mã số đề tài",label:"Mã số đề tài",required:!0},{key:"Sản phẩm thuộc đề tài",label:"Sản phẩm thuộc đề tài",required:!0},{key:"Xếp loại",label:"Xếp loại",required:!1}]},"giáo trình":{default:[{key:"Mã số giáo trình",label:"Mã số giáo trình",required:!0},{key:"Xếp loại",label:"Xếp loại",required:!1}]},"tài liệu giảng dạy":{default:[{key:"Mã số tài liệu",label:"Mã số tài liệu",required:!0},{key:"Xếp loại",label:"Xếp loại",required:!1}]},"hội thảo, hội nghị":{default:[{key:"Chi tiết",label:"Chi tiết",required:!0}]},"hướng dẫn sv nckh":{default:[{key:"Mã số đề tài của sinh viên",label:"Mã số đề tài của sinh viên",required:!0}]},"chương sách":{default:[{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!0},{key:"Số trang",label:"Số trang",required:!0},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!0},{key:"Cơ quan xuất bản",label:"Cơ quan xuất bản",required:!0},{key:"Dạng tài liệu",label:"Dạng tài liệu",required:!0}]},"chuyên khảo":{default:[{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!0},{key:"Số trang",label:"Số trang",required:!0},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!0},{key:"Cơ quan xuất bản",label:"Cơ quan xuất bản",required:!0},{key:"Dạng tài liệu",label:"Dạng tài liệu",required:!0}]},"giáo trình - sách":{default:[{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!0},{key:"Số trang",label:"Số trang",required:!0},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!0},{key:"Cơ quan xuất bản",label:"Cơ quan xuất bản",required:!0},{key:"Dạng tài liệu",label:"Dạng tài liệu",required:!0}]},"tài liệu hướng dẫn":{default:[{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!0},{key:"Số trang",label:"Số trang",required:!0},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!0},{key:"Cơ quan xuất bản",label:"Cơ quan xuất bản",required:!0},{key:"Dạng tài liệu",label:"Dạng tài liệu",required:!0}]},"tham khảo":{default:[{key:"Tập, số phát hành",label:"Tập, số phát hành",required:!0},{key:"Số trang",label:"Số trang",required:!0},{key:"Chỉ số xuất bản",label:"Chỉ số xuất bản",required:!0},{key:"Cơ quan xuất bản",label:"Cơ quan xuất bản",required:!0},{key:"Dạng tài liệu",label:"Dạng tài liệu",required:!0}]},"khác":{default:[{key:"Chi tiết",label:"Chi tiết",required:!0}]}},Ka=J({title:ee().min(2,"Tên công trình phải có ít nhất 2 ký tự"),timePublished:Pe().optional().nullable(),totalAuthors:Ae.number().min(1,"Số tác giả phải lớn hơn 0").optional().nullable(),totalMainAuthors:Ae.number().min(1,"Số tác giả chính phải lớn hơn 0").optional().nullable(),details:Pe().optional(),source:Se(),workTypeId:ee().uuid("ID loại công trình không hợp lệ"),workLevelId:ee().uuid("ID cấp độ công trình không hợp lệ").optional().nullable(),coAuthorUserIds:Le(ee().uuid("ID đồng tác giả không hợp lệ")).optional().default([]),author:J({authorRoleId:ee().uuid("ID vai trò tác giả không hợp lệ").optional().nullable(),purposeId:ee().uuid("ID mục đích không hợp lệ"),position:Se().min(1,"Vị trí tác giả phải lớn hơn 0").optional().nullable(),scoreLevel:Se().min(0,"Mức điểm không hợp lệ").optional().nullable(),sCImagoFieldId:ee().uuid("ID lĩnh vực SCImago không hợp lệ").optional().nullable(),fieldId:ee().uuid("ID lĩnh vực không hợp lệ").optional().nullable()})});function Ha({initialData:e,onSubmit:n,isLoading:a,workTypes:t,fields:i,activeTab:s,setActiveTab:l}){const[d,o]=u.useState(""),[h,m]=u.useState([]),[g,x]=u.useState({}),[p,j]=u.useState(!1),[y,f]=u.useState([]),{user:v}=Tn(),w=v?.id,{control:b,handleSubmit:k,formState:{errors:C},reset:I,setValue:T,watch:S}=te({resolver:ue(Ka),mode:"onSubmit",defaultValues:e?{...e,timePublished:e.timePublished?new Date(e.timePublished):null,details:e.details||{},source:e.source,coAuthorUserIds:e.coAuthorUserIds?.filter((e=>e.toString()!==w))||[],author:{authorRoleId:e.author?.authorRoleId||null,purposeId:e.author?.purposeId||"",position:e.author?.position||1,scoreLevel:e.author?.scoreLevel??null,sCImagoFieldId:e.author?.scImagoFieldId||null,fieldId:e.author?.fieldId||null}}:{title:"",timePublished:null,totalAuthors:null,totalMainAuthors:null,details:{},source:Da.NguoiDungKeKhai,workTypeId:"",workLevelId:null,coAuthorUserIds:[],author:{authorRoleId:null,purposeId:"",position:1,scoreLevel:null,sCImagoFieldId:null,fieldId:null}}}),{workTypes:N,workLevels:q}=Aa(),L=S("workTypeId"),P=S("workLevelId"),A=S("author.authorRoleId"),W=S("author.purposeId");u.useEffect((()=>{x(e?.details?e.details:{})}),[e]);const D=u.useMemo((()=>N.find((e=>e.id===L))?.name),[L,N]),K=u.useMemo((()=>q.find((e=>e.id===P))?.name),[P,q]),H=u.useMemo((()=>{if(!D)return[];const e=Ra[D.toLowerCase()];return e?e[K]||e.default:[]}),[D,K]),{data:F}=B({queryKey:["workLevels",L],queryFn:()=>ya(L),enabled:!!L}),{data:E}=B({queryKey:["authorRoles",L],queryFn:()=>sa(L),enabled:!!L}),{data:z}=B({queryKey:["purposes",L],queryFn:()=>va(L),enabled:!!L}),{data:M}=B({queryKey:["scimagoFields",L],queryFn:()=>Pa(L),enabled:!!L}),{data:V,isLoading:U}=B({queryKey:["searchUsers",d],queryFn:async()=>{const e=await(async e=>(await fn.get(`/users/search?searchTerm=${encodeURIComponent(e)}`)).data)(d);return console.log("Kết quả tìm kiếm người dùng:",e),e},enabled:d.length>0}),X=u.useMemo((()=>V?.data?V.data.filter((e=>e.id!==w)):[]),[V?.data,w]);u.useEffect((()=>{e&&(console.log("initialData đã thay đổi:",e),console.log("coAuthorUserIds:",e.coAuthorUserIds),I({...e,timePublished:e.timePublished?new Date(e.timePublished):null,details:e.details||{},source:e.source,coAuthorUserIds:e.coAuthorUserIds?.filter((e=>e.toString()!==w))||[],author:{authorRoleId:e.author?.authorRoleId||null,purposeId:e.author?.purposeId||"",position:e.author?.position||1,scoreLevel:e.author?.scoreLevel??null,sCImagoFieldId:e.author?.scImagoFieldId||null,fieldId:e.author?.fieldId||null}}),(async()=>{if(e.coAuthorUserIds&&e.coAuthorUserIds.length>0){j(!0);try{const n=[];for(const a of e.coAuthorUserIds)if(a.toString()!==w){const e=await vn(a);e.success&&e.data&&n.push(e.data)}m(n)}catch(n){console.error("Lỗi khi tải dữ liệu đồng tác giả:",n)}finally{j(!1)}}else m([])})())}),[e,I,w]),u.useEffect((()=>{L?(async()=>{try{const e=await(async(e,n,a,t)=>{try{const r=new URLSearchParams;return r.append("workTypeId",e),n&&r.append("workLevelId",n),a&&r.append("authorRoleId",a),t&&r.append("purposeId",t),(await fn.get(`/scorelevels?${r.toString()}`)).data.data}catch(r){return console.error("Lỗi khi lấy danh sách score levels:",r),[]}})(L,P||void 0,A||void 0,W||void 0);console.log("Đã lấy được danh sách mức điểm:",e),f(e),0===e.length&&T("author.scoreLevel",null)}catch(e){console.error("Lỗi khi lấy danh sách mức điểm:",e),f([]),T("author.scoreLevel",null)}})():f([])}),[L,P,A,W,T]);const[G,O]=u.useState(!0);u.useEffect((()=>{L&&(F?.data&&Array.isArray(F.data)?(O(F.data.length>0),0===F.data.length&&T("workLevelId",null)):O(!0))}),[L,F,T]),u.useEffect((()=>{L&&!e&&(T("workLevelId",null),T("author.authorRoleId",null),T("author.purposeId",""),T("author.sCImagoFieldId",null))}),[L,T,e]),u.useEffect((()=>{if(!h)return;console.log("Cập nhật coAuthorUserIds với:",h);const e=h.map((e=>e.id));console.log("Danh sách ID đồng tác giả cập nhật:",e),T("coAuthorUserIds",e,{shouldValidate:!0})}),[h,T]),u.useEffect((()=>{const e=S("totalAuthors"),n=S("totalMainAuthors");null!==e&&"string"==typeof e&&T("totalAuthors",Number(e)),null!==n&&"string"==typeof n&&T("totalMainAuthors",Number(n))}),[S,T]),u.useEffect((()=>{if(e?.details)try{x(e.details)}catch(n){console.error("Lỗi khi parse details:",n),x({})}else x({})}),[e]);const Y=(e,n)=>{console.log("Đã chọn đồng tác giả:",n);const a=n.filter((e=>e.id!==w));m(a);const t=a.map((e=>e.id));console.log("Danh sách ID đồng tác giả cập nhật:",t),T("coAuthorUserIds",t,{shouldValidate:!0})};return r.jsx("form",{onSubmit:k(n,(e=>{console.warn("Validation failed:",e);const n=["title","timePublished","totalAuthors","totalMainAuthors","workTypeId","workLevelId","coAuthorUserIds","details"],a=["author"],t=Object.keys(e).some((e=>n.includes(e))),r=Object.keys(e).some((e=>a.includes(e)));t&&0!==s?(alert("Có lỗi ở tab Thông tin công trình. Vui lòng kiểm tra lại."),l(0)):r&&1!==s&&(alert("Có lỗi ở tab Tác giả. Vui lòng kiểm tra lại."),l(1))})),children:r.jsxs(R,{container:!0,spacing:2,children:[0===s&&r.jsxs(r.Fragment,{children:[r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"title",control:b,render:({field:n})=>r.jsx(de,{...n,label:"Tên công trình",fullWidth:!0,error:!!C.title,helperText:C.title?.message?.toString(),disabled:e?.isLocked})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"timePublished",control:b,render:({field:n})=>r.jsx(We,{dateAdapter:De,adapterLocale:qe,children:r.jsx(Re,{label:"Thời gian xuất bản",value:n.value?new Date(n.value):null,onChange:e=>n.onChange(e),disabled:e?.isLocked,slotProps:{textField:{fullWidth:!0,error:!!C.timePublished,helperText:C.timePublished?.message?.toString()}}})})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"workTypeId",control:b,render:({field:n})=>r.jsx(de,{...n,select:!0,label:"Loại công trình",fullWidth:!0,error:!!C.workTypeId,helperText:C.workTypeId?.message?.toString(),disabled:e?.isLocked,children:t.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"workLevelId",control:b,render:({field:n})=>r.jsx(de,{...n,select:!0,label:"Cấp công trình",fullWidth:!0,error:!!C.workLevelId,helperText:C.workLevelId?.message?.toString(),disabled:!L||!G||e?.isLocked,children:F?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"totalAuthors",control:b,render:({field:{value:n,onChange:a,onBlur:t,...i}})=>r.jsx(de,{...i,label:"Tổng số tác giả",type:"number",inputProps:{min:1,step:1},fullWidth:!0,error:!!C.totalAuthors,helperText:C.totalAuthors?.message?.toString(),value:null===n?"":n,onChange:e=>{const n=e.target.value;a(""===n?null:Number(n))},onBlur:t,disabled:e?.isLocked})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"totalMainAuthors",control:b,render:({field:{value:n,onChange:a,onBlur:t,...i}})=>r.jsx(de,{...i,label:"Số tác giả chính",type:"number",inputProps:{min:1,step:1},fullWidth:!0,error:!!C.totalMainAuthors,helperText:C.totalMainAuthors?.message?.toString(),value:null===n?"":n,onChange:e=>{const n=e.target.value;a(""===n?null:Number(n))},onBlur:t,disabled:e?.isLocked})})}),r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"coAuthorUserIds",control:b,render:()=>r.jsx(Ke,{multiple:!0,id:"coAuthorUserIds",options:X,getOptionLabel:e=>"string"==typeof e?e:`${e.fullName} - ${e.userName}${e.departmentName?` - ${e.departmentName}`:""}`,isOptionEqualToValue:(e,n)=>e.id===n.id,value:h,onChange:Y,loading:U||p,disabled:e?.isLocked,renderTags:(e,n)=>e.map(((e,a)=>{const t=n({index:a});return r.jsx(Ce,{...t,label:`${e.fullName} - ${e.userName}${e.departmentName?` - ${e.departmentName}`:""}`,size:"medium"})})),renderInput:e=>r.jsx(de,{...e,label:"Đồng tác giả",variant:"outlined",onChange:e=>o(e.target.value),placeholder:"Tìm kiếm đồng tác giả",error:!!C.coAuthorUserIds,helperText:C.coAuthorUserIds?.message||"Thêm các đồng tác giả (không bao gồm bạn)",InputProps:{...e.InputProps,endAdornment:r.jsxs(r.Fragment,{children:[U||p?r.jsx($,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}})})})}),H.length>0&&r.jsx(R,{item:!0,xs:12,children:r.jsx(R,{container:!0,spacing:2,children:H.map((n=>r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(de,{label:n.label,fullWidth:!0,value:g[n.key]||"",onChange:e=>((e,n)=>{const a={...g,[e]:n};x(a),T("details",a)})(n.key,e.target.value),required:n.required,error:n.required&&(!g[n.key]||""===g[n.key].trim()),helperText:!n.required||g[n.key]&&""!==g[n.key].trim()?"":"Trường này là bắt buộc",disabled:e?.isLocked})},n.key)))})})]}),1===s&&r.jsxs(r.Fragment,{children:[r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"author.authorRoleId",control:b,render:({field:{value:e,onChange:n,...a}})=>r.jsxs(de,{...a,select:!0,label:"Vai trò tác giả",fullWidth:!0,error:!!C.author?.authorRoleId,helperText:C.author?.authorRoleId?.message?.toString(),disabled:!L,value:e??"",onChange:e=>{const a=""===e.target.value?null:e.target.value;n(a)},children:[r.jsx(Q,{value:"",children:"Chọn vai trò tác giả"}),E?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"author.purposeId",control:b,render:({field:e})=>r.jsx(de,{...e,select:!0,label:"Mục đích quy đổi",fullWidth:!0,error:!!C.author?.purposeId,helperText:C.author?.purposeId?.message?.toString(),disabled:!L,children:z?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"author.position",control:b,render:({field:{value:e,onChange:n,...a}})=>r.jsx(de,{...a,label:"Vị trí tác giả",type:"number",fullWidth:!0,error:!!C.author?.position,helperText:C.author?.position?.message?.toString(),value:null===e?"":e,onChange:e=>{const a=e.target.value;n(""===a?null:Number(a))}})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"author.scoreLevel",control:b,render:({field:{value:e,onChange:n,...a}})=>r.jsxs(de,{...a,select:!0,label:"Mức điểm",fullWidth:!0,error:!!C.author?.scoreLevel,helperText:C.author?.scoreLevel?.message?.toString(),disabled:0===y.length,value:e??"",onChange:e=>{const a=""===e.target.value?null:Number(e.target.value);n(a)},children:[r.jsx(Q,{value:"",children:"Chọn mức điểm"}),y.map((e=>r.jsx(Q,{value:e,children:pa(e)},e)))]})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"author.sCImagoFieldId",control:b,render:({field:{value:e,onChange:n,...a}})=>r.jsxs(de,{...a,select:!0,label:"Ngành SCImago",fullWidth:!0,error:!!C.author?.sCImagoFieldId,helperText:C.author?.sCImagoFieldId?.message?.toString(),disabled:!L,value:e??"",onChange:e=>{const a=""===e.target.value?null:e.target.value;n(a)},children:[r.jsx(Q,{value:"",children:"Chọn ngành SCImago"}),M?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})})}),r.jsx(R,{item:!0,xs:6,children:r.jsx(ge,{name:"author.fieldId",control:b,render:({field:{value:e,onChange:n,...a}})=>r.jsxs(de,{...a,select:!0,label:"Ngành tính điểm",fullWidth:!0,error:!!C.author?.fieldId,helperText:C.author?.fieldId?.message?.toString(),value:e??"",onChange:e=>{const a=""===e.target.value?null:e.target.value;n(a)},disabled:!1,children:[r.jsx(Q,{value:"",children:"Chọn ngành tính điểm"}),i.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})})})]}),r.jsx(R,{item:!0,xs:12,sx:{mt:2},children:r.jsx(c,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,disabled:a,children:a?r.jsx($,{size:24}):e?"Cập nhật":"Thêm mới"})})]})})}function Fa({open:e,onClose:n,selectedWork:a,activeTab:t,setActiveTab:d,onSubmit:h,isPending:m,workTypes:g,workLevels:x,authorRoles:p,purposes:j,scimagoFields:y,fields:f}){const{user:v}=Tn(),w=a?.authors?.find((e=>e.userId===v?.id)),b=w?.proofStatus,k=a?.isLocked;return u.useEffect((()=>{k&&0!==b&&d(1)}),[k,b,d]),r.jsxs(i,{open:e,onClose:n,fullWidth:!0,maxWidth:"md",children:[r.jsx(s,{children:a?"Cập nhật công trình":"Thêm công trình mới"}),r.jsxs(l,{children:[r.jsx(O,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:r.jsxs(He,{value:t,onChange:(e,n)=>{k&&0!==b&&0===n||d(n)},children:[r.jsx(Fe,{label:"Thông tin công trình",disabled:k&&0!==b,sx:{color:k&&0!==b?"text.disabled":"inherit","&.Mui-disabled":{color:"text.disabled"}}}),r.jsx(Fe,{label:"Thông tin tác giả"})]})}),g.length>0?r.jsx(Ha,{initialData:a,onSubmit:h,isLoading:m,workTypes:g,workLevels:x,authorRoles:p,purposes:j,scimagoFields:y,fields:f,activeTab:t,setActiveTab:d}):r.jsx(O,{sx:{display:"flex",justifyContent:"center",p:3},children:r.jsx($,{})})]}),r.jsx(o,{children:r.jsx(c,{onClick:n,color:"inherit",children:"Đóng"})})]})}const Ea=async()=>(await fn.get("/systemConfigs/check")).data,za=async()=>(await fn.get("/academicYears")).data,Ba=async()=>(await fn.get("/academicYears/current")).data;function Ma(){const e=z(),[n,a]=u.useState({}),{user:t}=Tn(),{isSystemOpen:d,canEditWork:h,canDeleteWork:m}=function(){const{data:e,isLoading:n}=B({queryKey:["systemConfig"],queryFn:Ea}),a=e?.data,t=u.useMemo((()=>{if(!a)return!1;const e=E.now().setZone("Asia/Saigon"),n=E.fromISO(a.openTime,{zone:"utc"}).setZone("Asia/Saigon"),t=E.fromISO(a.closeTime,{zone:"utc"}).setZone("Asia/Saigon");return e>=n&&e<=t}),[a]);return{systemConfig:a,isLoading:n,isSystemOpen:t,canEditWork:(e,n)=>n||t?0!==e:1===e,canDeleteWork:(e,n,a=!1)=>!a&&(n||t?0!==e:1===e)}}(),{data:g}=B({queryKey:["current-academic-year"],queryFn:Ba}),{data:x,error:p,isPending:j,refetch:y}=B({queryKey:["works","my-works"],queryFn:async()=>Sa({academicYearId:g?.data?.id,isCurrentUser:!0}),enabled:!!g?.data?.id,staleTime:0}),f=Aa(),{selectedWork:v,openUpdateDialog:w,activeTab:b,createWorkMutation:k,updateWorkMutation:C,handleOpenUpdateDialog:I,handleCloseUpdateDialog:S,handleUpdateSubmit:N,setActiveTab:q}=Wa({userId:t?.id??"",worksData:x,refetchWorks:y,isAuthorPage:!0});u.useEffect((()=>{x?.data&&x.data.length>0&&(async()=>{const e={};for(const a of x.data)if(a.coAuthorUserIds&&a.coAuthorUserIds.length>0){const t=[];for(const e of a.coAuthorUserIds)try{const n=await vn(e);n.success&&n.data&&t.push(n.data)}catch(n){console.error("Lỗi khi lấy thông tin đồng tác giả:",n)}e[a.id]=t}a(e)})()}),[x]),u.useEffect((()=>{x&&x.message&&T.success(x.message,{toastId:"fetch-works-success"})}),[x]),u.useEffect((()=>{p&&T.error("Có lỗi đã xảy ra: "+p.message,{toastId:"fetch-works-error"})}),[p]);const[L,P]=u.useState(!1),[A,D]=u.useState(null),R=e=>{D(e),P(!0)},K=()=>{D(null),P(!1)},H=ve({mutationFn:e=>(async e=>(await fn.delete(`/works/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa công trình thành công!"),e.invalidateQueries({queryKey:["works","my-works"]}),setTimeout((()=>{y()}),100),P(!1)},onError:e=>{T.error("Lỗi khi xóa công trình: "+e.message)}}),F=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=e.api.getAllRowIds().indexOf(e.id);return r.jsx("div",{children:n+1})}},{field:"title",headerName:"Tên công trình",type:"string",width:250},{field:"timePublished",headerName:"Thời gian xuất bản",type:"string",width:150,renderCell:e=>e.value?r.jsx("div",{children:Na(e.value)}):r.jsx("div",{children:"-"})},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:170},{field:"workLevelName",headerName:"Cấp công trình",type:"string",width:150},{field:"details",headerName:"Thông tin chi tiết",type:"string",width:300,renderCell:e=>{if(!e.row.details)return r.jsx("div",{children:"-"});const n=e.row.details,a=Object.entries(n).map((([e,n])=>`${e}: ${String(n)}`)).join("\n");return r.jsx(Be,{title:r.jsx("div",{style:{whiteSpace:"pre-line",fontSize:"0.8rem"},children:a}),arrow:!0,children:r.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",width:"100%"},children:Object.entries(n).map((([e,n],a)=>r.jsxs("span",{children:[a>0&&"; ",r.jsx("b",{children:e}),": ",String(n)]},a)))})})}},{field:"totalAuthors",headerName:"Số tác giả",type:"number",width:140,align:"center",headerAlign:"left"},{field:"totalMainAuthors",headerName:"Số tác giả chính",type:"number",width:140,align:"center",headerAlign:"left"},{field:"coAuthors",headerName:"Đồng tác giả",type:"string",width:140,renderCell:e=>{const a=e.row.id,t=n[a]||[];if(0===t.length)return r.jsx("div",{children:"-"});const i=`${t.length} tác giả`;return r.jsx(Be,{title:r.jsxs("div",{children:[r.jsx(W,{variant:"subtitle2",children:"Danh sách đồng tác giả:"}),t.map(((e,n)=>r.jsxs(W,{variant:"body2",children:["• ",e.fullName," - ",e.userName," - ",e.departmentName||"Chưa có phòng ban"]},n)))]}),children:r.jsx("div",{children:i})})}},{field:"authorRoleName",headerName:"Vai trò tác giả",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:a?a.authorRoleName:"-"})}},{field:"position",headerName:"Vị trí",type:"string",width:80,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:null!=a?.position?a.position:"-"})}},{field:"purposeName",headerName:"Mục đích quy đổi",type:"string",width:180,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:a?a.purposeName:"-"})}},{field:"fieldName",headerName:"Ngành tính điểm",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:a?a.fieldName:"-"})}},{field:"scImagoFieldName",headerName:"Ngành SCImago",type:"string",width:180,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:a?a.scImagoFieldName:"-"})}},{field:"scoreLevel",headerName:"Mức điểm",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return a&&void 0!==a.scoreLevel&&null!==a.scoreLevel?r.jsx("div",{children:xa(a.scoreLevel)}):r.jsx("div",{children:"-"})}},{field:"workHour",headerName:"Giờ công trình",type:"string",width:120,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:null!=a?.workHour?a.workHour:"-"})}},{field:"authorHour",headerName:"Giờ tác giả",type:"string",width:120,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:null!=a?.authorHour?a.authorHour:"-"})}},{field:"note",headerName:"Ghi chú",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id)),i=a?.note||"";return i?r.jsx(Be,{title:r.jsx("div",{style:{whiteSpace:"pre-line",fontSize:"0.8rem"},children:i}),arrow:!0,children:r.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",width:"100%"},children:i})}):r.jsx("div",{children:"-"})}},{field:"proofStatus",headerName:"Trạng thái",type:"string",width:140,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id)),i=a?.proofStatus;return null==i?r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:"-"}):i===qa.HopLe?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Ie,{color:"success"}),"Hợp lệ"]}):i===qa.KhongHopLe?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Te,{color:"error"}),"Không hợp lệ"]}):i===qa.ChuaXuLy?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Me,{color:"action"}),"Chưa xử lý"]}):r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:"-"})}},{field:"actions",headerName:"Thao tác",width:200,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id)),i=a?.proofStatus,s=n.isLocked,l=n.authors?.some((e=>e.userId!==t?.id&&0===e.proofStatus));if(s&&0===i)return r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>I(n),disabled:!0,sx:{mr:1},children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>R(n.id),disabled:!0,children:"Xóa"})]});if(s)return r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>I(n),disabled:!1,sx:{mr:1},children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>R(n.id),disabled:!m(i,s,l),children:"Xóa"})]});const d=h(i,s);return r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>I(n),disabled:!d,sx:{mr:1},children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>R(n.id),disabled:!m(i,s,l),children:"Xóa"})]})}}];return j?r.jsx($,{}):p?r.jsxs("p",{children:["Lỗi: ",p.message]}):r.jsxs(Ee,{maxWidth:"xl",children:[r.jsxs(O,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[r.jsx(W,{variant:"h6",children:"Danh sách công trình"}),r.jsx(O,{sx:{display:"flex",gap:2},children:r.jsx(c,{variant:"contained",color:"primary",onClick:()=>I(void 0),startIcon:r.jsx(ze,{}),disabled:!d,children:"Thêm công trình"})})]}),j?r.jsx(O,{sx:{display:"flex",justifyContent:"center",mt:4},children:r.jsx($,{})}):r.jsx(ra,{columns:F,data:x.data||[]}),r.jsx(Fa,{open:w,onClose:S,selectedWork:v,activeTab:b,setActiveTab:q,onSubmit:N,isPending:k.isPending||C.isPending,workTypes:f.workTypes,workLevels:f.workLevels,authorRoles:f.authorRoles,purposes:f.purposes,scimagoFields:f.scimagoFields,fields:f.fields}),r.jsxs(i,{open:L,onClose:K,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa công trình này không?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:K,color:"inherit",children:"Hủy"}),r.jsx(c,{onClick:async()=>{if(A)try{await H.mutateAsync(A)}catch(e){}},color:"error",variant:"contained",disabled:H.isPending,children:H.isPending?r.jsx($,{size:24}):"Xóa"})]})]})]})}const Va=h.create({baseURL:"/api",headers:{"Content-Type":"application/json"},timeout:3e4});Va.interceptors.request.use((e=>{const n=localStorage.getItem("token");return n&&(e.headers.Authorization=`Bearer ${n}`),e}),(e=>Promise.reject(e)));const Ua=()=>{const[e,n]=u.useState(!1),[a,t]=u.useState(null),[i,s]=u.useState([]),[l,d]=u.useState([]),[o,h]=u.useState([]),[m,g]=u.useState(null),[x,p]=u.useState(null),[j,y]=u.useState({userId:"",departmentId:"",academicYearId:"",proofStatus:void 0,source:void 0,onlyRegisteredWorks:!1,onlyRegisterableWorks:!1,isCurrentUser:!0});u.useEffect((()=>{(async()=>{try{const[e,n]=await Promise.all([za(),Gn()]);d(e.data||[]),h(n.data||[])}catch(e){t("Lỗi khi tải dữ liệu ban đầu"),console.error("Error fetching initial data:",e)}})()}),[]);const f=e=>{const{name:n,checked:a}=e.target;y((e=>({...e,[n]:a})))},v=e=>{const{name:n,value:a}=e.target;y("proofStatus"===n||"source"===n?e=>({...e,[n]:""===a?void 0:Number(a)}):e=>({...e,[n]:a}))},w=async e=>{n(!0),t(null),p(null);try{const n=await(async e=>{console.log("Gọi API getWorkById:",e);const n=await Va.get(`/works/${e}`);return console.log("Response from getWorkById:",n.data),n.data})(e);g(n.data),p(JSON.stringify({success:n.success,message:n.message,data:{id:n.data?.id,title:n.data?.title,authorsCount:n.data?.authors?.length||0,coAuthorUserIds:n.data?.coAuthorUserIds||[]}},null,2))}catch(a){console.error("Error fetching work details:",a),t("Lỗi khi tải chi tiết công trình")}finally{n(!1)}},b=e=>e?new Date(e).toLocaleDateString("vi-VN"):"N/A",k=e=>{if(void 0===e)return"Không xác định";switch(e){case qa.ChuaXuLy:return"Chưa xử lý";case qa.HopLe:return"Hợp lệ";case qa.KhongHopLe:return"Không hợp lệ";default:return"Không xác định"}},C=e=>{if(void 0===e)return"Không xác định";switch(e){case Da.NguoiDungKeKhai:return"Người dùng kê khai";case Da.QuanLyNhap:return"Quản lý nhập";default:return"Không xác định"}};return r.jsxs(Ee,{maxWidth:"xl",sx:{mt:4,mb:4},children:[r.jsx(W,{variant:"h4",gutterBottom:!0,children:"Kiểm thử API Works Controller"}),r.jsx(O,{mb:4,children:r.jsx(ie,{severity:"info",children:"Trang này sử dụng để kiểm thử các API của WorksController. Nếu bạn đã đăng nhập với token hợp lệ, các API sẽ tự động sử dụng thông tin người dùng hiện tại."})}),r.jsxs(R,{container:!0,spacing:3,children:[r.jsx(R,{item:!0,xs:12,md:4,children:r.jsxs(ke,{sx:{p:2,height:"100%"},children:[r.jsx(W,{variant:"h6",gutterBottom:!0,children:"Bộ lọc"}),r.jsx(we,{control:r.jsx(be,{checked:j.isCurrentUser,onChange:f,name:"isCurrentUser"}),label:"Sử dụng người dùng hiện tại"}),!j.isCurrentUser&&r.jsx(de,{fullWidth:!0,margin:"normal",label:"User ID",name:"userId",value:j.userId||"",onChange:e=>{const{name:n,value:a}=e.target;y((e=>({...e,[n]:a})))},size:"small",disabled:j.isCurrentUser}),r.jsxs(se,{fullWidth:!0,margin:"normal",size:"small",children:[r.jsx(xe,{children:"Khoa/Phòng ban"}),r.jsxs(pe,{name:"departmentId",value:j.departmentId||"",onChange:v,label:"Khoa/Phòng ban",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),o.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]}),r.jsxs(se,{fullWidth:!0,margin:"normal",size:"small",children:[r.jsx(xe,{children:"Năm học"}),r.jsxs(pe,{name:"academicYearId",value:j.academicYearId||"",onChange:v,label:"Năm học",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),l.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]}),r.jsxs(se,{fullWidth:!0,margin:"normal",size:"small",children:[r.jsx(xe,{children:"Trạng thái minh chứng"}),r.jsxs(pe,{name:"proofStatus",value:void 0!==j.proofStatus?j.proofStatus:"",onChange:v,label:"Trạng thái minh chứng",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),r.jsx(Q,{value:qa.ChuaXuLy,children:"Chưa xử lý"}),r.jsx(Q,{value:qa.HopLe,children:"Hợp lệ"}),r.jsx(Q,{value:qa.KhongHopLe,children:"Không hợp lệ"})]})]}),r.jsxs(se,{fullWidth:!0,margin:"normal",size:"small",children:[r.jsx(xe,{children:"Nguồn"}),r.jsxs(pe,{name:"source",value:void 0!==j.source?j.source:"",onChange:v,label:"Nguồn",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),r.jsx(Q,{value:Da.NguoiDungKeKhai,children:"Người dùng kê khai"}),r.jsx(Q,{value:Da.QuanLyNhap,children:"Quản lý nhập"})]})]}),r.jsx(we,{control:r.jsx(be,{checked:j.onlyRegisteredWorks,onChange:f,name:"onlyRegisteredWorks"}),label:"Chỉ lấy công trình đăng ký quy đổi"}),r.jsx(we,{control:r.jsx(be,{checked:j.onlyRegisterableWorks,onChange:f,name:"onlyRegisterableWorks"}),label:"Chỉ lấy công trình có thể đăng ký quy đổi"}),r.jsxs(O,{mt:3,children:[r.jsx(c,{variant:"contained",color:"primary",fullWidth:!0,onClick:async()=>{n(!0),t(null),p(null);try{const e=await(async e=>{const n=new URLSearchParams;return e.userId&&n.append("userId",e.userId),e.departmentId&&n.append("departmentId",e.departmentId),e.academicYearId&&n.append("academicYearId",e.academicYearId),void 0!==e.proofStatus&&n.append("proofStatus",e.proofStatus.toString()),void 0!==e.source&&n.append("source",e.source.toString()),n.append("onlyRegisteredWorks",e.onlyRegisteredWorks.toString()),n.append("onlyRegisterableWorks",e.onlyRegisterableWorks.toString()),n.append("isCurrentUser",e.isCurrentUser.toString()),console.log("Gọi API với params:",n.toString()),(await Va.get(`/works/filter?${n.toString()}`)).data})(j);s(e.data||[]),p(JSON.stringify({success:e.success,message:e.message,count:e.data?.length||0},null,2))}catch(e){console.error("Error fetching works:",e),t("Lỗi khi tải danh sách công trình")}finally{n(!1)}},disabled:e,children:e?r.jsx($,{size:24}):"Tìm kiếm theo bộ lọc"}),r.jsxs(O,{display:"flex",mt:2,gap:2,children:[r.jsx(c,{variant:"outlined",color:"primary",onClick:async()=>{n(!0),t(null),p(null);try{const e=await(async()=>(await Va.get("/works/my-works")).data)();s(e.data||[]),p(JSON.stringify({success:e.success,message:e.message,count:e.data?.length||0},null,2))}catch(e){console.error("Error fetching my works:",e),t("Lỗi khi tải danh sách công trình của tôi")}finally{n(!1)}},disabled:e,fullWidth:!0,children:"Lấy công trình của tôi"}),r.jsx(c,{variant:"outlined",color:"secondary",onClick:async()=>{n(!0),t(null),p(null);try{const e=await(async()=>(await Va.get("/works/all-my-works")).data)();s(e.data||[]),p(JSON.stringify({success:e.success,message:e.message,count:e.data?.length||0},null,2))}catch(e){console.error("Error fetching all my works:",e),t("Lỗi khi tải tất cả công trình của tôi")}finally{n(!1)}},disabled:e,fullWidth:!0,children:"Tất cả công trình"})]})]})]})}),r.jsxs(R,{item:!0,xs:12,md:8,children:[r.jsxs(ke,{sx:{p:2,mb:3},children:[r.jsxs(W,{variant:"h6",gutterBottom:!0,display:"flex",alignItems:"center",justifyContent:"space-between",children:[r.jsxs("span",{children:["Kết quả (",i.length," công trình)"]}),e&&r.jsx($,{size:24})]}),a&&r.jsx(ie,{severity:"error",sx:{mb:2},children:a}),x&&r.jsx(ie,{severity:"success",sx:{mb:2},children:r.jsx("pre",{style:{whiteSpace:"pre-wrap",margin:0},children:x})}),0!==i.length||e?r.jsx(Ve,{children:r.jsxs(Ue,{size:"small",children:[r.jsx(Xe,{children:r.jsxs(Ge,{children:[r.jsx(Qe,{children:"STT"}),r.jsx(Qe,{children:"Tiêu đề"}),r.jsx(Qe,{children:"Loại công trình"}),r.jsx(Qe,{children:"Năm học"}),r.jsx(Qe,{children:"Nguồn"}),r.jsx(Qe,{children:"Đồng tác giả"}),r.jsx(Qe,{children:"Thao tác"})]})}),r.jsx($e,{children:i.map(((e,n)=>r.jsxs(Ge,{hover:!0,children:[r.jsx(Qe,{children:n+1}),r.jsx(Qe,{children:e.title}),r.jsx(Qe,{children:e.workTypeName||"N/A"}),r.jsx(Qe,{children:e.academicYearName||"N/A"}),r.jsx(Qe,{children:C(e.source)}),r.jsx(Qe,{children:e.coAuthorUserIds?.length||0}),r.jsx(Qe,{children:r.jsx(c,{size:"small",onClick:()=>w(e.id),children:"Chi tiết"})})]},e.id)))})]})}):r.jsx(ie,{severity:"info",children:"Không có công trình nào được tìm thấy. Vui lòng thay đổi bộ lọc hoặc thử lại."})]}),m&&r.jsxs(ke,{sx:{p:2},children:[r.jsx(W,{variant:"h6",gutterBottom:!0,children:"Chi tiết công trình"}),r.jsxs(R,{container:!0,spacing:2,children:[r.jsx(R,{item:!0,xs:12,children:r.jsx(W,{variant:"h5",children:m.title})}),r.jsxs(R,{item:!0,xs:12,sm:6,children:[r.jsx(W,{variant:"subtitle2",children:"Loại công trình:"}),r.jsx(W,{variant:"body2",children:m.workTypeName||"N/A"})]}),r.jsxs(R,{item:!0,xs:12,sm:6,children:[r.jsx(W,{variant:"subtitle2",children:"Cấp công trình:"}),r.jsx(W,{variant:"body2",children:m.workLevelName||"N/A"})]}),r.jsxs(R,{item:!0,xs:12,sm:6,children:[r.jsx(W,{variant:"subtitle2",children:"Năm học:"}),r.jsx(W,{variant:"body2",children:m.academicYearName||"N/A"})]}),r.jsxs(R,{item:!0,xs:12,sm:6,children:[r.jsx(W,{variant:"subtitle2",children:"Ngày xuất bản:"}),r.jsx(W,{variant:"body2",children:b(m.timePublished)})]}),r.jsxs(R,{item:!0,xs:12,sm:6,children:[r.jsx(W,{variant:"subtitle2",children:"Nguồn:"}),r.jsx(W,{variant:"body2",children:C(m.source)})]}),r.jsxs(R,{item:!0,xs:12,sm:6,children:[r.jsx(W,{variant:"subtitle2",children:"Ngày tạo:"}),r.jsx(W,{variant:"body2",children:b(m.createdDate)})]}),r.jsxs(R,{item:!0,xs:12,children:[r.jsx(D,{sx:{my:2}}),r.jsx(W,{variant:"subtitle1",fontWeight:"bold",children:"Thông tin tác giả và đồng tác giả"})]}),r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(ae,{variant:"outlined",children:r.jsxs(Oe,{children:[r.jsxs(W,{variant:"subtitle2",gutterBottom:!0,children:["Đồng tác giả (",m.coAuthorUserIds?.length||0,"):"]}),m.coAuthorUserIds&&m.coAuthorUserIds.length>0?r.jsx(Ye,{dense:!0,children:m.coAuthorUserIds.map(((e,n)=>r.jsx(Ze,{divider:n<m.coAuthorUserIds.length-1,children:r.jsx(_e,{primary:`Đồng tác giả ${n+1}`,secondary:e})},e)))}):r.jsx(W,{variant:"body2",color:"text.secondary",children:"Không có đồng tác giả"})]})})}),r.jsx(R,{item:!0,xs:12,sm:6,children:r.jsx(ae,{variant:"outlined",children:r.jsxs(Oe,{children:[r.jsxs(W,{variant:"subtitle2",gutterBottom:!0,children:["Tác giả (",m.authors?.length||0,"):"]}),m.authors&&m.authors.length>0?r.jsx(Ye,{dense:!0,children:m.authors.map(((e,n)=>r.jsxs(Ze,{divider:n<m.authors.length-1,children:[r.jsx(_e,{primary:e.authorRoleName||"Chưa có tên vai trò",secondary:`UserId: ${e.userId||"N/A"}, Trạng thái: ${k(e.proofStatus)}`}),e.authorRoleName?.includes("Chính")&&r.jsx(Ce,{size:"small",color:"primary",label:"Tác giả chính"})]},e.id)))}):r.jsx(W,{variant:"body2",color:"text.secondary",children:"Không có thông tin tác giả"})]})})})]}),r.jsx(O,{mt:2,children:r.jsx(c,{variant:"outlined",onClick:()=>g(null),children:"Đóng chi tiết"})})]})]})]}),r.jsx(Je,{open:!!a,autoHideDuration:6e3,onClose:()=>t(null),message:a})]})},Xa=J({name:ee().min(2,"Tên mục đích quy đổi phải có ít nhất 2 ký tự"),workTypeId:ee().uuid("Vui lòng chọn loại công trình")});function Ga({open:e,handleClose:n,data:a}){const t=z(),{data:d,isLoading:h}=B({queryKey:["workTypes"],queryFn:la}),{register:m,handleSubmit:g,setValue:x,reset:p,formState:{errors:j,isSubmitting:y}}=te({resolver:ue(Xa),defaultValues:{name:"",workTypeId:""}});u.useEffect((()=>{a?(x("name",a.name),x("workTypeId",a.workTypeId||"")):p()}),[a,e,x,p]);const f=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/purposes/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/purposes",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["purposes"]}),T.success(a?.id?"Mục đích quy đổi đã được cập nhật":"Mục đích quy đổi đã được thêm"),n()},onError:e=>{console.error("API Error:",e),T.error("Đã xảy ra lỗi: "+e.message)}});return r.jsxs(i,{open:e,onClose:n,maxWidth:"sm",fullWidth:!0,children:[r.jsx(s,{children:a?"Cập nhật Mục đích quy đổi":"Thêm Mục đích quy đổi"}),r.jsxs(l,{children:[r.jsx(de,{label:"Tên mục đích quy đổi",...m("name"),error:!!j.name,helperText:j.name?.message,fullWidth:!0,margin:"dense",disabled:y}),r.jsx(de,{select:!0,label:"Loại công trình",...m("workTypeId"),error:!!j.workTypeId,helperText:j.workTypeId?.message,fullWidth:!0,margin:"dense",disabled:y||h,children:h?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):d?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})]}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:y,children:"Hủy"}),r.jsx(c,{onClick:g((async e=>{await f.mutateAsync(e)})),variant:"contained",color:"primary",disabled:y||h,children:y?r.jsx($,{size:24}):a?"Cập nhật":"Thêm mới"})]})]})}function Qa(){const e=z(),[n,a]=u.useState(""),{data:t,isLoading:d}=B({queryKey:["workTypes"],queryFn:la}),{data:h,error:m,isPending:g,isSuccess:x,dataUpdatedAt:p}=B({queryKey:["purposes",n],queryFn:()=>n?va(n):fa()});u.useEffect((()=>{x&&h&&T.success(h.message,{toastId:"fetch-purposes-success"})}),[p,x,h]),u.useEffect((()=>{m&&T.error("Có lỗi đã xảy ra: "+m.message)}),[m]);const[j,y]=u.useState(!1),[f,v]=u.useState(null),w=e=>{v(e),y(!0)},[b,k]=u.useState(!1),[C,I]=u.useState(null),S=()=>{I(null),k(!1)},N=ve({mutationFn:e=>(async e=>(await fn.delete(`/purposes/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa mục đích quy đổi thành công!"),e.invalidateQueries({queryKey:["purposes"]}),k(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),q=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=Array.from(e.api.getAllRowIds()).findIndex((n=>n===e.row.id));return r.jsx("div",{children:n+1})}},{field:"name",headerName:"Tên mục đích quy đổi",type:"string",width:400},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:400},{field:"actions",headerName:"Thao tác",width:200,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,void w(n);var n},sx:{marginRight:1},disabled:N.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,I(n),void k(!0);var n},disabled:N.isPending,children:"Xóa"})]})}];return g&&d?r.jsx($,{}):m?r.jsxs("p",{children:["Lỗi: ",m.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{marginBottom:2},children:[r.jsx(W,{variant:"h4",children:"Quản lý mục đích quy đổi"}),r.jsxs(O,{display:"flex",alignItems:"center",gap:2,children:[r.jsxs(se,{sx:{minWidth:220},children:[r.jsx(xe,{id:"work-type-filter-label",children:"Lọc theo loại công trình"}),r.jsxs(pe,{labelId:"work-type-filter-label",id:"work-type-filter",value:n,onChange:e=>{a(e.target.value)},label:"Lọc theo loại công trình",children:[r.jsx(Q,{value:"",children:"Tất cả"}),t?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]}),r.jsx(c,{variant:"contained",onClick:()=>w(null),children:"Thêm mục đích quy đổi"})]})]}),r.jsx(ke,{sx:{width:"100%",overflow:"hidden"},children:r.jsx(ra,{columns:q,data:h?.data||[]})}),r.jsx(Ga,{open:j,handleClose:()=>y(!1),data:f}),r.jsxs(i,{open:b,onClose:S,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa mục đích quy đổi này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:S,disabled:N.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{C&&N.mutate(C)},color:"error",variant:"contained",disabled:N.isPending,children:N.isPending?r.jsx($,{size:24}):"Xóa"})]})]})]})}const $a=J({name:ee().min(2,"Tên ngành SCImago phải có ít nhất 2 ký tự"),workTypeId:ee().uuid("Vui lòng chọn loại công trình")});function Oa({open:e,handleClose:n,data:a}){const t=z(),{data:d,isLoading:h}=B({queryKey:["workTypes"],queryFn:la}),{register:m,handleSubmit:g,setValue:x,reset:p,formState:{errors:j,isSubmitting:y}}=te({resolver:ue($a),defaultValues:{name:"",workTypeId:""}});u.useEffect((()=>{a?(x("name",a.name),x("workTypeId",a.workTypeId||"")):p()}),[a,e,x,p]);const f=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/scimagofields/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/scimagofields",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["scimagoFields"]}),T.success(a?.id?"Ngành SCImago đã được cập nhật":"Ngành SCImago đã được thêm"),n()},onError:e=>{console.error("API Error:",e),T.error("Đã xảy ra lỗi: "+e.message)}});return r.jsxs(i,{open:e,onClose:n,maxWidth:"sm",fullWidth:!0,children:[r.jsx(s,{children:a?"Cập nhật Ngành SCImago":"Thêm Ngành SCImago"}),r.jsxs(l,{children:[r.jsx(de,{label:"Tên ngành SCImago",...m("name"),error:!!j.name,helperText:j.name?.message,fullWidth:!0,margin:"dense",disabled:y}),r.jsx(de,{select:!0,label:"Loại công trình",...m("workTypeId"),error:!!j.workTypeId,helperText:j.workTypeId?.message,fullWidth:!0,margin:"dense",disabled:y||h,children:h?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):d?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})]}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:y,children:"Hủy"}),r.jsx(c,{onClick:g((async e=>{await f.mutateAsync(e)})),variant:"contained",color:"primary",disabled:y||h,children:y?r.jsx($,{size:24}):a?"Cập nhật":"Thêm mới"})]})]})}function Ya(){const e=z(),[n,a]=u.useState(""),{data:t,isLoading:d}=B({queryKey:["workTypes"],queryFn:la}),{data:h,error:m,isPending:g,isSuccess:x,dataUpdatedAt:p}=B({queryKey:["scimagoFields",n],queryFn:()=>n?Pa(n):La()});u.useEffect((()=>{x&&h&&T.success(h.message,{toastId:"fetch-scimago-fields-success"})}),[p,x,h]),u.useEffect((()=>{m&&T.error("Có lỗi đã xảy ra: "+m.message)}),[m]);const[j,y]=u.useState(!1),[f,v]=u.useState(null),w=e=>{v(e),y(!0)},[b,k]=u.useState(!1),[C,I]=u.useState(null),S=()=>{I(null),k(!1)},N=ve({mutationFn:e=>(async e=>(await fn.delete(`/scimagofields/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa ngành SCImago thành công!"),e.invalidateQueries({queryKey:["scimagoFields"]}),k(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),q=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=Array.from(e.api.getAllRowIds()).findIndex((n=>n===e.row.id));return r.jsx("div",{children:n+1})}},{field:"name",headerName:"Tên ngành SCImago",type:"string",width:400},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:400},{field:"actions",headerName:"Thao tác",width:200,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,void w(n);var n},sx:{marginRight:1},disabled:N.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,I(n),void k(!0);var n},disabled:N.isPending,children:"Xóa"})]})}];return g&&d?r.jsx($,{}):m?r.jsxs("p",{children:["Lỗi: ",m.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{marginBottom:2},children:[r.jsx(W,{variant:"h4",children:"Quản lý ngành SCImago"}),r.jsxs(O,{display:"flex",alignItems:"center",gap:2,children:[r.jsxs(se,{sx:{minWidth:220},children:[r.jsx(xe,{id:"work-type-filter-label",children:"Lọc theo loại công trình"}),r.jsxs(pe,{labelId:"work-type-filter-label",id:"work-type-filter",value:n,onChange:e=>{a(e.target.value)},label:"Lọc theo loại công trình",children:[r.jsx(Q,{value:"",children:"Tất cả"}),t?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]}),r.jsx(c,{variant:"contained",onClick:()=>w(null),children:"Thêm ngành SCImago"})]})]}),r.jsx(ke,{sx:{width:"100%",overflow:"hidden"},children:r.jsx(ra,{columns:q,data:h?.data||[]})}),r.jsx(Oa,{open:j,handleClose:()=>y(!1),data:f}),r.jsxs(i,{open:b,onClose:S,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa ngành SCImago này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:S,disabled:N.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{C&&N.mutate(C)},color:"error",variant:"contained",disabled:N.isPending,children:N.isPending?r.jsx($,{size:24}):"Xóa"})]})]})]})}const Za=J({name:ee().min(2,"Tên cấp công trình phải có ít nhất 2 ký tự"),workTypeId:ee().uuid("Vui lòng chọn loại công trình")});function _a({open:e,handleClose:n,data:a}){const t=z(),{data:d,isLoading:h}=B({queryKey:["workTypes"],queryFn:la}),{control:m,handleSubmit:g,setValue:x,reset:p,formState:{errors:j}}=te({resolver:ue(Za),defaultValues:{name:"",workTypeId:""}});u.useEffect((()=>{a?(x("name",a.name),x("workTypeId",a.workTypeId)):p()}),[a,x,p]);const y=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/worklevels/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/worklevels",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["workLevels"]}),T.success(a?.id?"Cấp công trình đã được cập nhật":"Cấp công trình đã được thêm"),n()},onError:e=>{console.error("API Error:",e),T.error("Đã xảy ra lỗi: "+e.message)}}),f=async e=>{await y.mutateAsync(e)};return r.jsxs(i,{open:e,onClose:n,maxWidth:"sm",fullWidth:!0,children:[r.jsx(s,{children:a?"Cập nhật cấp công trình":"Thêm cấp công trình"}),r.jsx(l,{children:r.jsx("form",{onSubmit:g(f),children:r.jsxs(R,{container:!0,spacing:2,sx:{mt:1},children:[r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"name",control:m,render:({field:e})=>r.jsx(de,{...e,label:"Tên cấp công trình",error:!!j.name,helperText:j.name?.message,fullWidth:!0,disabled:y.isPending})})}),r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"workTypeId",control:m,render:({field:e})=>r.jsx(de,{...e,select:!0,label:"Loại công trình",error:!!j.workTypeId,helperText:j.workTypeId?.message,fullWidth:!0,disabled:y.isPending||h,children:h?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):d?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})})})]})})}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:y.isPending,children:"Hủy"}),r.jsx(c,{onClick:g(f),disabled:y.isPending,variant:"contained",color:"primary",children:y.isPending?r.jsx($,{size:24}):a?"Cập nhật":"Thêm mới"})]})]})}function Ja(){const e=z(),[n,a]=u.useState(""),{data:t,isLoading:d}=B({queryKey:["workTypes"],queryFn:la}),{data:h,error:m,isPending:g,isSuccess:x,dataUpdatedAt:p}=B({queryKey:["workLevels",n],queryFn:()=>n?ya(n):ja()});u.useEffect((()=>{x&&h&&T.success(h.message,{toastId:"fetch-work-levels-success"})}),[p,x,h]),u.useEffect((()=>{m&&T.error("Có lỗi đã xảy ra: "+m.message)}),[m]);const[j,y]=u.useState(!1),[f,v]=u.useState(null),w=e=>{v(e),y(!0)},[b,k]=u.useState(!1),[C,I]=u.useState(null),S=()=>{I(null),k(!1)},N=ve({mutationFn:e=>(async e=>(await fn.delete(`/worklevels/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa cấp công trình thành công!"),e.invalidateQueries({queryKey:["workLevels"]}),k(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),q=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=Array.from(e.api.getAllRowIds()).findIndex((n=>n===e.row.id));return r.jsx("div",{children:n+1})}},{field:"name",headerName:"Tên cấp công trình",type:"string",width:300},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:300},{field:"actions",headerName:"Thao tác",width:200,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,void w(n);var n},sx:{marginRight:1},disabled:N.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,I(n),void k(!0);var n},disabled:N.isPending,children:"Xóa"})]})}];return g&&d?r.jsx($,{}):m?r.jsxs("p",{children:["Lỗi: ",m.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{marginBottom:2},children:[r.jsx(W,{variant:"h4",children:"Quản lý cấp công trình"}),r.jsxs(O,{display:"flex",alignItems:"center",gap:2,children:[r.jsxs(se,{sx:{minWidth:220},children:[r.jsx(xe,{id:"work-type-filter-label",children:"Lọc theo loại công trình"}),r.jsxs(pe,{labelId:"work-type-filter-label",id:"work-type-filter",value:n,onChange:e=>{a(e.target.value)},label:"Lọc theo loại công trình",children:[r.jsx(Q,{value:"",children:"Tất cả"}),t?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]}),r.jsx(c,{variant:"contained",onClick:()=>w(null),children:"Thêm cấp công trình"})]})]}),r.jsx(ke,{sx:{width:"100%",overflow:"hidden"},children:r.jsx(ra,{columns:q,data:h?.data||[]})}),r.jsx(_a,{open:j,handleClose:()=>y(!1),data:f}),r.jsxs(i,{open:b,onClose:S,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa cấp công trình này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:S,disabled:N.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{C&&N.mutate(C)},disabled:N.isPending,color:"error",variant:"contained",children:N.isPending?r.jsx($,{size:24}):"Xóa"})]})]})]})}const et=J({name:ee().min(2,"Tên loại công trình phải có ít nhất 2 ký tự")});function nt({open:e,handleClose:n,data:a}){const t=z(),{control:d,handleSubmit:h,setValue:m,reset:g,formState:{errors:x}}=te({resolver:ue(et),defaultValues:{name:""}});u.useEffect((()=>{a?m("name",a.name):g()}),[a,m,g]);const p=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/worktypes/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/worktypes",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["workTypes"]}),T.success(a?.id?"Loại công trình đã được cập nhật":"Loại công trình đã được thêm"),n()},onError:e=>{console.error("API Error:",e),T.error("Đã xảy ra lỗi: "+e.message)}});return r.jsxs(i,{open:e,onClose:n,maxWidth:"sm",fullWidth:!0,children:[r.jsx(s,{children:a?"Cập nhật loại công trình":"Thêm loại công trình"}),r.jsx(l,{children:r.jsxs(R,{container:!0,spacing:2,sx:{mt:1},children:[r.jsx(R,{item:!0,xs:12,children:r.jsx(ge,{name:"name",control:d,render:({field:e})=>r.jsx(de,{...e,label:"Tên loại công trình",error:!!x.name,helperText:x.name?.message,fullWidth:!0,disabled:p.isPending})})}),a&&r.jsxs(R,{item:!0,xs:12,children:[r.jsx(W,{fontSize:12,fontStyle:"italic",sx:{fontWeight:"300"},children:"- Chỉnh sửa tên loại công trình chỉ ảnh hưởng đến tên hiển thị"}),r.jsx(W,{fontSize:12,fontStyle:"italic",sx:{fontWeight:"300"},children:"- Các cấp công trình, mục đích, và vai trò tác giả thuộc loại này không bị ảnh hưởng"})]})]})}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:p.isPending,children:"Hủy"}),r.jsx(c,{onClick:h((async e=>{await p.mutateAsync(e)})),variant:"contained",color:"primary",disabled:p.isPending,children:p.isPending?r.jsx($,{size:24}):a?"Cập nhật":"Thêm mới"})]})]})}function at(){const e=z(),{data:n,error:a,isPending:t,isSuccess:d,dataUpdatedAt:h}=B({queryKey:["workTypes","details"],queryFn:async()=>{const e=await(async()=>(await fn.get("/worktypes/with-details")).data)();return e?.data&&(console.log("WorkTypes with details:",e.data),e.data.forEach((e=>{console.log(`WorkType ${e.name} has ${e.scImagoFieldCount} Scimago fields:`,e.scImagoFields)}))),e}});u.useEffect((()=>{d&&n?.message&&T.success(n.message)}),[h,d,n]),u.useEffect((()=>{a&&T.error("Có lỗi đã xảy ra: "+a.message)}),[a]);const[m,g]=u.useState(!1),[x,p]=u.useState(null),j=e=>{p(e),g(!0)},[y,f]=u.useState(!1),[v,w]=u.useState(null),b=()=>{w(null),f(!1)},k=ve({mutationFn:e=>(async e=>(await fn.delete(`/worktypes/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa loại công trình thành công!"),e.invalidateQueries({queryKey:["workTypes"]}),f(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),C=(e,n)=>`${e} ${n}`,I=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=Array.from(e.api.getAllRowIds()).findIndex((n=>n===e.row.id));return r.jsx("div",{children:n+1})}},{field:"name",headerName:"Tên loại công trình",type:"string",width:200},{field:"workLevelCount",headerName:"Cấp công trình",width:130,renderCell:e=>{const n=e.row.workLevelCount||0;return r.jsx(Be,{title:(a=e.row.workLevels,a&&0!==a.length?a.map((e=>e.name)).join("; "):"Không có cấp công trình nào"),arrow:!0,children:r.jsx("span",{children:C(n,"cấp")})});var a}},{field:"purposeCount",headerName:"Mục đích quy đổi",width:150,renderCell:e=>{const n=e.row.purposeCount||0;return r.jsx(Be,{title:(a=e.row.purposes,a&&0!==a.length?a.map((e=>e.name)).join("; "):"Không có mục đích quy đổi nào"),arrow:!0,children:r.jsx("span",{children:C(n,"mục đích")})});var a}},{field:"authorRoleCount",headerName:"Vai trò tác giả",width:140,renderCell:e=>{const n=e.row.authorRoleCount||0;return r.jsx(Be,{title:(a=e.row.authorRoles,a&&0!==a.length?a.map((e=>e.name)).join("; "):"Không có vai trò tác giả nào"),arrow:!0,children:r.jsx("span",{children:C(n,"vai trò")})});var a}},{field:"factorCount",headerName:"Hệ số quy đổi",width:140,renderCell:e=>{const n=e.row.factorCount||0;return r.jsx("span",{children:C(n,"hệ số")})}},{field:"scImagoFieldCount",headerName:"Ngành SCImago",width:140,renderCell:e=>{const n=e.row.scImagoFieldCount||0;return r.jsx("span",{children:C(n,"ngành")})}},{field:"actions",headerName:"Thao tác",width:200,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,void j(n);var n},sx:{marginRight:1},disabled:k.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,w(n),void f(!0);var n},disabled:k.isPending,children:"Xóa"})]})}];return t?r.jsx($,{}):a?r.jsxs("p",{children:["Error: ",a.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",justifyContent:"space-between",alignItems:"center",sx:{marginBottom:2},children:[r.jsx(W,{variant:"h4",children:"Quản lý loại công trình"}),r.jsx(c,{variant:"contained",onClick:()=>j(null),children:"Thêm loại công trình"})]}),r.jsx(ke,{sx:{width:"100%",overflow:"hidden"},children:r.jsx(ra,{columns:I,data:n?.data||[]})}),r.jsx(nt,{open:m,handleClose:()=>g(!1),data:x}),r.jsxs(i,{open:y,onClose:b,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa loại công trình này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:b,disabled:k.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{v&&k.mutate(v)},color:"error",variant:"contained",disabled:k.isPending,children:k.isPending?r.jsx($,{size:24}):"Xóa"})]})]})]})}const tt=async()=>(await fn.get("/assignments")).data;function rt({open:e,handleClose:n,manager:a,onSuccess:t}){const{control:d,handleSubmit:h,reset:m}=te({defaultValues:{assignments:[]}}),{fields:g,append:x,remove:p}=en({control:d,name:"assignments"}),[j,y]=u.useState([]),[f,v]=u.useState(!1),[w,b]=u.useState(!1);return u.useEffect((()=>{if(e){async function n(){try{const e=await Gn();y(e.data||[])}catch(e){T.error("Lỗi khi tải đơn vị: "+e.message)}try{const e=await(async e=>(await fn.get(`/assignments/user/${e}`)).data)(a.managerId);if(!e||!e.data||Array.isArray(e.data)&&0===e.data.length)m({assignments:[]}),b(!0);else{const n=e.data.map((e=>({departmentId:e.departmentId})));m({assignments:n}),b(!1)}}catch(e){m({assignments:[]}),b(!0)}v(!1)}v(!0),n()}}),[e,a.managerId,m]),r.jsxs(i,{open:e,onClose:n,fullWidth:!0,children:[r.jsx(s,{children:"Phân công cho quản lý"}),r.jsx(l,{children:f?r.jsx(O,{sx:{display:"flex",justifyContent:"center",my:4},children:r.jsx($,{})}):r.jsxs(r.Fragment,{children:[r.jsx(de,{label:"Họ và tên",value:a.managerFullName,fullWidth:!0,margin:"dense",disabled:!0}),r.jsx(de,{label:"Đơn vị công tác",value:a.managerDepartmentName,fullWidth:!0,margin:"dense",disabled:!0}),g.map(((e,n)=>r.jsxs(O,{sx:{display:"flex",alignItems:"center",mt:2},children:[r.jsx(ge,{control:d,name:`assignments.${n}.departmentId`,defaultValue:e.departmentId,render:({field:e})=>r.jsxs(de,{select:!0,label:"Chọn đơn vị",value:e.value,onChange:e.onChange,fullWidth:!0,margin:"dense",children:[r.jsx(Q,{value:"",children:"-- Chọn đơn vị --"}),j.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})}),r.jsx(V,{onClick:()=>p(n),sx:{ml:1},"aria-label":"delete",children:r.jsx(nn,{})})]},e.id))),r.jsx(c,{onClick:()=>x({departmentId:""}),sx:{mt:2},variant:"outlined",disabled:f,children:"Thêm đơn vị"})]})}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,children:"Hủy"}),r.jsx(c,{onClick:h((async e=>{const r=e.assignments.map((e=>e.departmentId)).filter(Boolean);if(0!==r.length)try{w?(await(async e=>(await fn.post("/assignments",e)).data)({managerId:a.managerId,departmentIds:r}),T.success("Phân công thành công")):(await(async e=>(await fn.put("/assignments",e)).data)({managerId:a.managerId,departmentIds:r}),T.success("Cập nhật phân công thành công")),t(),n()}catch(i){T.error("Lỗi khi lưu phân công: "+i.message)}else T.error("Vui lòng chọn ít nhất 1 đơn vị")})),variant:"contained",children:"Lưu"})]})]})}function it(){const e=z(),{data:n,error:a,isPending:t,isSuccess:d,dataUpdatedAt:h,refetch:m}=B({queryKey:["assignments"],queryFn:tt});u.useEffect((()=>{d&&n&&T.success(n.message||"Lấy dữ liệu phân công thành công",{toastId:"fetch-assignments-success"})}),[h,d,n]),u.useEffect((()=>{a&&T.error("Có lỗi xảy ra: "+a.message)}),[a]);const g=n?.data?function(e){const n=new Map;return e.forEach((e=>{const{managerId:a,managerFullName:t,managerDepartmentName:r,departmentId:i,assignedDepartmentName:s}=e;n.has(a)||n.set(a,{managerId:a,managerFullName:t,managerDepartmentName:r,assignedDepartments:[],assignedCount:0}),"00000000-0000-0000-0000-000000000000"!==i&&"Chưa phân công"!==s&&n.get(a).assignedDepartments.push({departmentId:i,assignedDepartmentName:s})})),Array.from(n.values()).map((e=>({...e,assignedCount:e.assignedDepartments.length})))}(n.data):[],[x,p]=u.useState(!1),[j,y]=u.useState(null),[f,v]=u.useState(!1),[w,b]=u.useState(null),k=ve({mutationFn:e=>(async e=>(await fn.delete(`/assignments/user/${e}`)).data)(e),onSuccess:()=>{T.success("Đã bỏ phân công thành công"),e.invalidateQueries({queryKey:["assignments"]}),m()},onError:e=>{T.error("Có lỗi xảy ra khi bỏ phân công: "+e.message)}}),C=[{field:"managerFullName",headerName:"Họ và tên quản lý",width:200},{field:"managerDepartmentName",headerName:"Đơn vị công tác",width:200},{field:"assignedCount",headerName:"Số phân công",width:150},{field:"actions",headerName:"",width:300,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",size:"small",onClick:()=>{return n=e.row,y(n),void p(!0);var n},children:"Phân công"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.managerId,b(n),void v(!0);var n},disabled:0===e.row.assignedCount,sx:{ml:1},children:"Bỏ phân công"})]})}];if(t)return r.jsx($,{});if(a)return r.jsxs(W,{variant:"body1",children:["Error: ",a.message]});const I=g.map((e=>({id:e.managerId,...e})));return r.jsxs(r.Fragment,{children:[r.jsx(ke,{sx:{width:"100%",marginX:"auto",padding:2},children:r.jsx(ra,{columns:C,data:I})}),j&&r.jsx(rt,{open:x,handleClose:()=>{p(!1),y(null)},manager:j,onSuccess:()=>{e.invalidateQueries({queryKey:["assignments"]}),m()}}),r.jsxs(i,{open:f,onClose:()=>v(!1),children:[r.jsx(s,{children:"Xác nhận bỏ phân công"}),r.jsx(l,{children:r.jsxs(W,{children:["Bạn có chắc chắn muốn bỏ ",r.jsx("strong",{children:"tất cả"})," phân công cho quản lý này?"]})}),r.jsxs(o,{children:[r.jsx(c,{onClick:()=>v(!1),children:"Hủy"}),r.jsx(c,{onClick:()=>{w&&(k.mutate(w),v(!1))},color:"error",variant:"contained",children:k.isPending?"Đang xóa...":"Xóa"})]})]})]})}const st=J({name:ee().min(2,"Tên năm học phải có ít nhất 2 ký tự"),startDate:ee(),endDate:ee()}).refine((e=>new Date(e.endDate)>new Date(e.startDate)),{message:"Ngày kết thúc phải sau ngày bắt đầu",path:["endDate"]});function lt({open:e,handleClose:n,data:a}){const t=z(),{register:d,handleSubmit:h,setValue:m,reset:g,formState:{errors:x,isSubmitting:p}}=te({resolver:ue(st),defaultValues:{name:"",startDate:"",endDate:""}});u.useEffect((()=>{a?(m("name",a.name),m("startDate",new Date(a.startDate).toISOString().split("T")[0]),m("endDate",new Date(a.endDate).toISOString().split("T")[0])):g()}),[a,e,m,g]);const j=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/academicYears/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/academicYears",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["academic-years"]}),T.success(a?.id?"Cập nhật thành công":"Thêm mới thành công"),n()},onError:e=>{T.error("Lỗi khi lưu: "+e.message)}});return r.jsxs(i,{open:e,onClose:n,children:[r.jsx(s,{children:a?"Cập nhật Năm Học":"Thêm Năm Học"}),r.jsxs(l,{children:[r.jsx(de,{label:"Tên năm học",...d("name"),error:!!x.name,helperText:x.name?.message,fullWidth:!0,margin:"dense"}),r.jsx(de,{label:"Ngày bắt đầu",type:"date",...d("startDate"),fullWidth:!0,margin:"dense",InputLabelProps:{shrink:!0},error:!!x.startDate,helperText:x.startDate?.message}),r.jsx(de,{label:"Ngày kết thúc",type:"date",...d("endDate"),fullWidth:!0,margin:"dense",InputLabelProps:{shrink:!0},error:!!x.endDate,helperText:x.endDate?.message})]}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:p,children:"Hủy"}),r.jsx(c,{onClick:h((async e=>{await j.mutateAsync({name:e.name,startDate:e.startDate,endDate:e.endDate})})),variant:"contained",disabled:p,children:p?"Đang lưu...":"Lưu"})]})]})}function dt(){const e=z(),{data:n,error:a,isPending:t,isSuccess:d,dataUpdatedAt:h,refetch:m}=B({queryKey:["academic-years"],queryFn:za});u.useEffect((()=>{d&&n&&T.success(n.message,{toastId:"fetch-academic-years-success"})}),[h]),u.useEffect((()=>{a&&T.error("Có lỗi xảy ra: "+a.message)}),[a]);const[g,x]=u.useState(!1),[p,j]=u.useState(null),y=e=>{j(e),x(!0)},[f,v]=u.useState(!1),[w,b]=u.useState(null),k=()=>{b(null),v(!1)},C=ve({mutationFn:e=>(async e=>(await fn.delete(`/academicYears/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa năm học thành công!"),e.invalidateQueries({queryKey:["academic-years"]}),v(!1),m()},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),I=[{field:"name",headerName:"Tên năm học",width:200},{field:"startDate",headerName:"Bắt đầu",valueFormatter:e=>new Date(e).toLocaleDateString(),width:150},{field:"endDate",headerName:"Kết thúc",valueFormatter:e=>new Date(e).toLocaleDateString(),width:150},{field:"actions",headerName:"Hành động",width:300,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>y(e.row),sx:{marginRight:1},children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,b(n),void v(!0);var n},children:"Xóa"})]})}];return t?r.jsx($,{}):a?r.jsxs("p",{children:["Error: ",a.message]}):r.jsxs(r.Fragment,{children:[r.jsx(O,{display:"flex",justifyContent:"flex-end",mb:2,children:r.jsx(c,{variant:"contained",onClick:()=>y(null),children:"Thêm năm học"})}),r.jsx(ke,{sx:{width:1010,marginX:"auto"},children:r.jsx(ra,{columns:I,data:(n?.data||[]).slice().sort(((e,n)=>n.name.localeCompare(e.name)))})}),r.jsx(lt,{open:g,handleClose:()=>{x(!1),m()},data:p}),r.jsxs(i,{open:f,onClose:k,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa năm học này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:k,children:"Hủy"}),r.jsx(c,{onClick:()=>{w&&C.mutate(w)},color:"error",variant:"contained",children:C.isPending?"Đang xóa...":"Xóa"})]})]})]})}const ot=an.object({name:an.string().min(2,"Tên cấu hình là bắt buộc"),openTime:an.string().min(1,"Thời gian mở là bắt buộc"),openDate:an.string().min(1,"Ngày mở là bắt buộc"),closeTime:an.string().min(1,"Thời gian đóng là bắt buộc"),closeDate:an.string().min(1,"Ngày đóng là bắt buộc"),academicYearId:an.string()}).refine((e=>{const n=new Date(`${e.openDate}T${e.openTime}`);return new Date(`${e.closeDate}T${e.closeTime}`)>n}),{message:"Thời gian kết thúc phải sau Thời gian bắt đầu",path:["closeDate"]});function ct({open:e,handleClose:n,data:a}){const t=z(),{data:d,isLoading:h}=B({queryKey:["academic-years"],queryFn:za}),{register:m,handleSubmit:g,setValue:x,reset:p,control:j,formState:{errors:y,isSubmitting:f}}=te({resolver:ue(ot),defaultValues:{name:"",openTime:"",closeTime:"",academicYearId:""}}),[v,w]=u.useState(null);u.useEffect((()=>{(async()=>{const e=await Ba();e&&e.data&&(w(e.data),x("academicYearId",e.data.id))})()}),[x]),u.useEffect((()=>{if(a){const e=E.fromISO(a.openTime,{zone:"utc"}).setZone("Asia/Saigon"),n=E.fromISO(a.closeTime,{zone:"utc"}).setZone("Asia/Saigon");x("name",a.name),x("openDate",e.toFormat("yyyy-LL-dd")),x("openTime",e.toFormat("HH:mm")),x("closeDate",n.toFormat("yyyy-LL-dd")),x("closeTime",n.toFormat("HH:mm")),x("academicYearId",v?.id??a.academicYearId)}else p(),v&&x("academicYearId",v.id)}),[a,e,x,p,v]);const b=ve({mutationFn:async e=>a?.id?(async(e,n)=>(await fn.put(`/systemConfigs/${e}`,n)).data)(a.id,e):(async e=>(await fn.post("/systemConfigs",e)).data)(e),onSuccess:()=>{t.invalidateQueries({queryKey:["system-configs"]}),T.success(a?.id?"Cập nhật thành công":"Thêm mới thành công"),n()},onError:e=>{T.error("Lỗi khi lưu: "+e.message)}});return r.jsxs(i,{open:e,onClose:n,children:[r.jsx(s,{children:a?"Cập nhật Cấu hình":"Thêm Cấu hình"}),r.jsxs(l,{children:[r.jsx(de,{label:"Tên Cấu hình",...m("name"),error:!!y.name,helperText:y.name?.message,fullWidth:!0,margin:"dense"}),r.jsx(D,{sx:{marginY:2}}),r.jsxs(O,{display:"flex",gap:2,alignItems:"center",marginBottom:2,children:[r.jsx(W,{minWidth:120,children:"Thời gian mở"}),r.jsx(ge,{control:j,name:"openTime",render:({field:e})=>r.jsx(de,{...e,type:"time",error:!!y.openTime,helperText:y.openTime?.message,fullWidth:!0,margin:"dense"})}),r.jsx(ge,{control:j,name:"openDate",render:({field:e})=>r.jsx(de,{...e,type:"date",error:!!y.openDate,helperText:y.openDate?.message,fullWidth:!0,margin:"dense"})})]}),r.jsxs(O,{display:"flex",gap:2,alignItems:"center",marginBottom:2,children:[r.jsx(W,{minWidth:120,children:"Thời gian đóng"}),r.jsx(ge,{control:j,name:"closeTime",render:({field:e})=>r.jsx(de,{...e,type:"time",error:!!y.closeTime,helperText:y.closeTime?.message,fullWidth:!0,margin:"dense"})}),r.jsx(ge,{control:j,name:"closeDate",render:({field:e})=>r.jsx(de,{...e,type:"date",error:!!y.closeDate,helperText:y.closeDate?.message,fullWidth:!0,margin:"dense"})})]}),r.jsx(D,{sx:{marginY:2}}),r.jsx(ge,{control:j,name:"academicYearId",render:({field:e})=>r.jsx(de,{...e,select:!0,label:"Năm học",error:!!y.academicYearId,helperText:y.academicYearId?.message,fullWidth:!0,disabled:!0,children:h?r.jsx(Q,{disabled:!0,children:"Đang tải..."}):d?.data?.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))})})]}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:f,children:"Hủy"}),r.jsx(c,{onClick:g((async e=>{const n=v?.id;n?await b.mutateAsync({name:e.name,openTime:ht(e.openDate,e.openTime),closeTime:ht(e.closeDate,e.closeTime),academicYearId:n}):T.error("Không tìm thấy năm học hiện tại, vui lòng thử lại sau.")})),variant:"contained",disabled:f,children:f?"Đang lưu...":"Lưu"})]})]})}const ht=(e,n)=>E.fromFormat(`${e} ${n}`,"yyyy-LL-dd HH:mm",{zone:"Asia/Saigon"}).toUTC().toISO();function ut(){const e=z(),[n,a]=u.useState(null);u.useEffect((()=>{(async()=>{const e=await Ba();e&&e.data&&a(e.data)})()}),[]);const{data:t,error:d,isPending:h,isSuccess:m,dataUpdatedAt:g,refetch:x}=B({queryKey:["system-configs"],queryFn:()=>(async e=>(await fn.get(`/systemConfigs/year/${e}`)).data)(n?.id||""),enabled:!!n?.id});u.useEffect((()=>{m&&t&&T.success(t.message,{toastId:"fetch-system-configs-success"})}),[g]),u.useEffect((()=>{d&&T.error("Có lỗi xảy ra: "+d.message)}),[d]);const p=u.useMemo((()=>!(!t||!t.data)&&t.data.some((e=>(e=>{const n=E.now().setZone("Asia/Saigon"),a=E.fromISO(e.openTime,{zone:"utc"}).setZone("Asia/Saigon"),t=E.fromISO(e.closeTime,{zone:"utc"}).setZone("Asia/Saigon");return n>=a&&n<=t})(e)))),[t]),[j,y]=u.useState(!1),[f,v]=u.useState(null),w=e=>{v(e),y(!0)},[b,k]=u.useState(!1),[C,I]=u.useState(null),S=()=>{I(null),k(!1)},N=ve({mutationFn:e=>(async e=>(await fn.delete(`/systemConfigs/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa cấu hình thành công!"),e.invalidateQueries({queryKey:["system-configs"]}),x(),k(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),[q,L]=u.useState(!1),[P,A]=u.useState(null),D=()=>{L(!1),A(null)},R=ve({mutationFn:()=>(async(e,n)=>(await fn.post(`/systemConfigs/notify/${n}`,e)).data)(P,P?.id),onSuccess:()=>{T.success("Đã tạo thông báo thành công."),L(!1),A(null),e.invalidateQueries({queryKey:["system-configs"]}),x()},onError:e=>{T.error("Lỗi khi tạo thông báo: "+e.message)}}),K=[{field:"name",headerName:"Tên cấu hình",width:200},{field:"academicYearName",headerName:"Năm học",width:200},{field:"openTime",headerName:"Thời gian mở",width:200,valueFormatter:e=>En(e)},{field:"closeTime",headerName:"Thời gian đóng",width:200,valueFormatter:e=>En(e)},{field:"isNotified",headerName:"Đã thông báo",type:"boolean",width:120},{field:"actions",headerName:"Hành động",width:400,renderCell:e=>{const n=e.row.isNotified;return r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>w(e.row),sx:{marginRight:1},disabled:n,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,I(n),void k(!0);var n},sx:{marginRight:1},disabled:n,children:"Xóa"}),r.jsx(c,{variant:"contained",color:"secondary",size:"small",onClick:()=>{return n=e.row,A(n),void L(!0);var n},disabled:n,children:"Thông báo"})]})}}];return h?r.jsx($,{}):d?r.jsxs("p",{children:["Error: ",d.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",justifyContent:"space-between",mb:2,children:[r.jsxs(W,{variant:"body1",children:["Năm học hiện tại:"," ",r.jsx(W,{component:"span",variant:"body1",sx:{fontWeight:"bold"},color:"primary",children:n?.name})]}),r.jsx(c,{variant:"contained",onClick:()=>w(null),children:"Thêm cấu hình"})]}),r.jsx(ke,{sx:{width:1010,marginX:"auto"},children:r.jsx(ra,{columns:K,data:t?.data||[]})}),void 0!==p&&r.jsx(O,{my:4,children:r.jsxs(W,{fontSize:24,variant:"body1",children:["Trạng thái hệ thống:"," ",r.jsx(W,{fontSize:24,component:"span",fontWeight:500,color:p?"primary":"red",children:p?"Đang mở":"Đang đóng"})]})}),r.jsx(ct,{open:j,handleClose:()=>{y(!1),x()},data:f}),r.jsxs(i,{open:b,onClose:S,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa cấu hình này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:S,children:"Hủy"}),r.jsx(c,{onClick:()=>{C&&N.mutate(C)},color:"error",variant:"contained",children:N.isPending?"Đang xóa...":"Xóa"})]})]}),r.jsxs(i,{open:q,onClose:D,children:[r.jsx(s,{children:"Xác nhận gửi thông báo"}),r.jsx(l,{children:r.jsx(W,{children:"Sau khi thông báo, cấu hình này sẽ không thể chỉnh sửa hoặc xóa. Bạn có chắc chắn muốn tiếp tục?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:D,children:"Hủy"}),r.jsx(c,{onClick:()=>{P&&R.mutate()},variant:"contained",color:"secondary",children:R.isPending?"Đang gửi...":"Thông báo"})]})]})]})}const mt={User:"Người dùng",Manager:"Quản lý",Admin:"Admin"},gt=e=>mt[e]||"-";var xt=(e=>(e[e.User=1]="User",e[e.Manager=2]="Manager",e[e.Admin=3]="Admin",e))(xt||{});const pt=J({userName:ee().nonempty("Mã số viên chức không được để trống"),email:ee().email("Email không hợp lệ"),phoneNumber:ee().nonempty("Số điện thoại không được để trống"),fullName:ee().nonempty("Họ và tên không được để trống"),academicTitle:ee().nonempty("Học hàm không được để trống"),officerRank:ee().nonempty("Ngạch công chức không được để trống"),departmentId:ee().optional(),fieldId:ee().optional(),specialization:ee().optional(),role:ee().nonempty("Quyền hạn không được để trống"),isApproved:fe()});function jt({open:e,handleClose:n,data:a}){const t=z(),[d,h]=u.useState([]),[m,g]=u.useState([]);u.useEffect((()=>{!async function(){const e=await Gn();h(e.data||[]);const n=await $n();g(n.data||[])}()}),[]);const{register:x,handleSubmit:p,setValue:j,reset:y,control:f,formState:{errors:v,isSubmitting:w}}=te({resolver:ue(pt),defaultValues:{userName:"",email:"",phoneNumber:"",fullName:"",academicTitle:"",officerRank:"",departmentId:"",fieldId:"",specialization:"",role:"",isApproved:!1}});u.useEffect((()=>{a?(j("userName",a.userName||""),j("email",a.email||""),j("phoneNumber",a.phoneNumber||""),j("fullName",a.fullName||""),j("academicTitle",a.academicTitle??""),j("officerRank",a.officerRank??""),j("departmentId",a.departmentId??""),j("fieldId",a.fieldId??""),j("specialization",a.specialization||""),j("role",a.role??""),j("isApproved",a.isApproved??!1)):y()}),[a,e,j,y]);const b=ve({mutationFn:async e=>{if(a?.id)return(async(e,n)=>(await fn.put(`/users/admin/${e}`,n)).data)(a.id,e)},onSuccess:()=>{t.invalidateQueries({queryKey:["users"]}),T.success("Người dùng đã được cập nhật"),n()},onError:e=>{console.error("API Error:",e),T.error("Lỗi khi cập nhật người dùng: "+e.message)}});return r.jsxs(i,{open:e,onClose:n,fullWidth:!0,children:[r.jsx(s,{children:"Cập nhật Người Dùng"}),r.jsxs(l,{children:[r.jsx(de,{label:"Mã số viên chức",...x("userName"),error:!!v.userName,helperText:v.userName?.message,fullWidth:!0,margin:"dense",disabled:!0}),r.jsx(de,{label:"Email",...x("email"),error:!!v.email,helperText:v.email?.message,fullWidth:!0,margin:"dense",disabled:w}),r.jsx(de,{label:"Số điện thoại",...x("phoneNumber"),error:!!v.phoneNumber,helperText:v.phoneNumber?.message,fullWidth:!0,margin:"dense",disabled:w}),r.jsx(de,{label:"Họ và tên",...x("fullName"),error:!!v.fullName,helperText:v.fullName?.message,fullWidth:!0,margin:"dense",disabled:w}),r.jsx(ge,{name:"academicTitle",control:f,defaultValue:a?.academicTitle??"",render:({field:e})=>r.jsx(de,{select:!0,label:"Học hàm",...e,error:!!v.academicTitle,helperText:v.academicTitle?.message,fullWidth:!0,margin:"dense",disabled:w,children:Object.entries(On).filter((([e])=>isNaN(Number(e)))).map((([e])=>r.jsx(Q,{value:e,children:Wn(e)},e)))})}),r.jsx(ge,{name:"officerRank",control:f,render:({field:e})=>r.jsx(de,{select:!0,label:"Ngạch công chức",...e,error:!!v.officerRank,helperText:v.officerRank?.message,fullWidth:!0,margin:"dense",disabled:w,children:Object.entries(Yn).filter((([e])=>isNaN(Number(e)))).map((([e])=>r.jsx(Q,{value:e,children:Rn(e)},e)))})}),r.jsx(ge,{name:"departmentId",control:f,render:({field:e})=>r.jsxs(de,{select:!0,label:"Đơn vị công tác",...e,error:!!v.departmentId,helperText:v.departmentId?.message,fullWidth:!0,margin:"dense",disabled:w,children:[r.jsx(Q,{value:"",children:"-- Chọn đơn vị --"}),d.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})}),r.jsx(ge,{name:"fieldId",control:f,render:({field:e})=>r.jsxs(de,{select:!0,label:"Ngành",...e,error:!!v.fieldId,helperText:v.fieldId?.message,fullWidth:!0,margin:"dense",disabled:w,children:[r.jsx(Q,{value:"",children:"-- Chọn ngành --"}),m.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})}),r.jsx(de,{label:"Chuyên ngành",...x("specialization"),error:!!v.specialization,helperText:v.specialization?.message,fullWidth:!0,margin:"dense",disabled:w}),r.jsx(ge,{name:"role",control:f,render:({field:e})=>r.jsx(de,{select:!0,label:"Quyền hạn",...e,error:!!v.role,helperText:v.role?.message,fullWidth:!0,margin:"dense",disabled:w,children:Object.entries(xt).filter((([e])=>isNaN(Number(e)))).map((([e])=>r.jsx(Q,{value:e,children:gt(e)},e)))})}),r.jsx(ge,{name:"isApproved",control:f,render:({field:e})=>r.jsx(we,{control:r.jsx(be,{...e,checked:e.value,onChange:n=>e.onChange(n.target.checked),color:"primary",disabled:w}),label:"Cho phép truy cập hệ thống"})})]}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,disabled:w,children:"Hủy"}),r.jsx(c,{onClick:p((async e=>{await b.mutateAsync(e)})),variant:"contained",color:"primary",disabled:w,children:w?"Đang lưu...":"Lưu"})]})]})}function yt(){const e=z(),n=u.useRef(null),{data:a,error:t,isPending:d,isSuccess:h,dataUpdatedAt:m,refetch:g}=B({queryKey:["users"],queryFn:wn});u.useEffect((()=>{h&&a&&T.success(a.message,{toastId:"fetch-users-success"})}),[m]),u.useEffect((()=>{t&&T.error("Có lỗi đã xảy ra: "+t.message)}),[t]);const[x,p]=u.useState(!1),[j,y]=u.useState(null),[f,v]=u.useState(!1),[w,b]=u.useState(null),k=()=>{b(null),v(!1)},C=ve({mutationFn:e=>(async e=>(await fn.delete(`/users/${e}`)).data)(e),onSuccess:()=>{T.success("Xóa người dùng thành công!"),e.invalidateQueries({queryKey:["users"]}),g(),v(!1)},onError:e=>{T.error("Lỗi khi xóa: "+e.message)}}),I=[{field:"userName",headerName:"Mã số viên chức",type:"string",width:150},{field:"fullName",headerName:"Họ và tên",type:"string",width:200},{field:"email",headerName:"Email",type:"string",width:200},{field:"departmentName",headerName:"Đơn vị công tác",type:"string",width:180},{field:"fieldName",headerName:"Ngành",type:"string",width:180},{field:"phoneNumber",headerName:"Số điện thoại",type:"string",width:150},{field:"academicTitle",headerName:"Học hàm",type:"string",width:180,valueFormatter:e=>Wn(e)},{field:"officerRank",headerName:"Ngạch công chức",type:"string",width:180,valueFormatter:e=>Rn(e)},{field:"role",headerName:"Quyền hạn",type:"string",width:150,valueFormatter:e=>gt(e)},{field:"isApproved",headerName:"Đã duyệt",type:"boolean",width:120},{field:"actions",headerName:"",width:300,renderCell:e=>r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return n=e.row,y(n),void p(!0);var n},sx:{marginRight:1},disabled:C.isPending,children:"Sửa"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{return n=e.row.id,b(n),void v(!0);var n},disabled:C.isPending,children:"Xóa"})]})}];return d?r.jsx($,{}):t?r.jsxs("p",{children:["Error: ",t.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{sx:{marginBottom:2,display:"flex",justifyContent:"flex-end"},children:[r.jsx(c,{variant:"contained",color:"primary",onClick:()=>{n.current?.click()},children:"Nhập người dùng từ Excel"}),r.jsx("input",{type:"file",accept:".xls,.xlsx",style:{display:"none"},ref:n,onChange:async n=>{if(n.target.files&&n.target.files.length>0){const t=n.target.files[0];try{const n=await(async e=>{const n=new FormData;return n.append("file",e),(await fn.post("/users/import",n,{headers:{"Content-Type":"multipart/form-data"}})).data})(t);T.success(n.message),e.invalidateQueries({queryKey:["users"]}),g()}catch(a){T.error("Lỗi khi nhập file: "+a.message)}}}})]}),r.jsx(ke,{sx:{width:"100%",marginX:"auto",padding:2},children:r.jsx(ra,{columns:I,data:a?.data||[]})}),r.jsx(jt,{open:x,handleClose:()=>{p(!1),g()},data:j}),r.jsxs(i,{open:f,onClose:k,children:[r.jsx(s,{children:"Xác nhận xóa"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn xóa người dùng này?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:k,disabled:C.isPending,children:"Hủy"}),r.jsx(c,{onClick:()=>{w&&C.mutate(w)},color:"error",variant:"contained",disabled:C.isPending,children:C.isPending?"Đang xóa...":"Xóa"})]})]})]})}function ft({allowedRoles:e,children:n}){const{user:a,loading:t}=Tn();if(!t)return(()=>{const e=localStorage.getItem("token"),n=localStorage.getItem("expiration");return!(!e||!n)&&new Date(n).getTime()>Date.now()})()&&a?e&&!e.includes(a?.role)?r.jsx(tn,{to:"/unauthorized",replace:!0}):n?r.jsx(r.Fragment,{children:n}):r.jsx(L,{}):r.jsx(tn,{to:"/dang-nhap",replace:!0})}const vt=()=>{const e=I();return r.jsxs(Ee,{maxWidth:"md",sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",textAlign:"center"},children:[r.jsx(W,{variant:"h1",component:"h1",gutterBottom:!0,sx:{fontWeight:"bold"},children:"404"}),r.jsx(W,{variant:"h5",gutterBottom:!0,children:"Tài nguyên bạn yêu cầu không tồn tại."}),r.jsx(c,{variant:"contained",color:"primary",onClick:()=>{e("/")},children:"Trở về trang chủ"})]})},wt=()=>{const e=I();return r.jsxs(Ee,{maxWidth:"md",sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",textAlign:"center"},children:[r.jsx(W,{variant:"h1",component:"h1",gutterBottom:!0,sx:{fontWeight:"bold"},children:"401"}),r.jsx(W,{variant:"h5",gutterBottom:!0,children:"Bạn không có quyền truy cập tài nguyên này."}),r.jsx(c,{variant:"contained",color:"primary",onClick:()=>{e("/")},children:"Trở về trang chủ"})]})};function bt(){const e=z(),[n,a]=u.useState({}),{user:t}=Tn(),[d,h]=u.useState([]),[m,g]=u.useState(new Map),{data:x}=B({queryKey:["current-academic-year"],queryFn:Ba}),{data:p,error:j,isPending:y,refetch:f}=B({queryKey:["works","registerable-works"],queryFn:async()=>{const e={academicYearId:x?.data?.id,isCurrentUser:!0},n=await Sa(e);return console.log("Dữ liệu từ API:",n.data),n},enabled:!!x?.data?.id,staleTime:0});u.useEffect((()=>{p?.data&&p.data.length>0&&(async()=>{const e={};for(const a of p.data)if(a.coAuthorUserIds&&a.coAuthorUserIds.length>0){const t=[];for(const e of a.coAuthorUserIds)try{const n=await vn(e);n.success&&n.data&&t.push(n.data)}catch(n){console.error("Lỗi khi lấy thông tin đồng tác giả:",n)}e[a.id]=t}a(e)})()}),[p]),u.useEffect((()=>{p?.data&&(console.log("Cập nhật localWorks với dữ liệu:",p.data),h(p.data))}),[p]);const v=u.useCallback((e=>!!e&&(m.has(e.id)?m.get(e.id):(console.log("Kiểm tra trạng thái đăng ký của author:",e),null!=e.authorRegistration))),[m]);u.useEffect((()=>{p&&p.message&&T.success(p.message,{toastId:"fetch-works-success"})}),[p]),u.useEffect((()=>{j&&T.error("Có lỗi đã xảy ra: "+j.message,{toastId:"fetch-works-error"})}),[j]);const[w,b]=u.useState(!1),[k,C]=u.useState(null),I=()=>{C(null),b(!1)},S=ve({mutationFn:({authorId:e,registered:n})=>(async(e,n)=>(await fn.patch(`/works/authors/${e}/register`,n)).data)(e,n),onSuccess:(n,a)=>{const{authorId:t,registered:r}=a;T.success(r?"Đăng ký công trình thành công!":"Hủy đăng ký công trình thành công!"),h((e=>{const n=e.map((e=>{if(e.authors&&e.authors.length>0){const n=e.authors.findIndex((e=>e.id===t));if(n>=0){const a=[...e.authors];return a[n]={...a[n],registered:r},{...e,authors:a}}}return e}));return console.log("Dữ liệu sau khi cập nhật:",n),n})),e.invalidateQueries({queryKey:["works","registerable-works"]}),setTimeout((()=>{f(),g((e=>{const n=new Map(e);return n.delete(t),n}))}),300)},onError:(e,n)=>{const{authorId:a}=n;g((e=>{const n=new Map(e);return n.delete(a),n})),T.error("Lỗi khi cập nhật trạng thái đăng ký: "+e.message),f()}}),N=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=e.api.getAllRowIds().indexOf(e.id);return r.jsx("div",{children:n+1})}},{field:"title",headerName:"Tên công trình",type:"string",width:150},{field:"timePublished",headerName:"Thời gian xuất bản",type:"string",width:150,renderCell:e=>e.value?r.jsx("div",{children:Na(e.value)}):r.jsx("div",{children:"-"})},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:170},{field:"workLevelName",headerName:"Cấp công trình",type:"string",width:150},{field:"totalAuthors",headerName:"Số tác giả",type:"number",width:140,align:"center",headerAlign:"left"},{field:"coAuthors",headerName:"Đồng tác giả",type:"string",width:140,renderCell:e=>{const a=e.row.id,t=n[a]||[];if(0===t.length)return r.jsx("div",{children:"-"});const i=`${t.length} tác giả`;return r.jsx(Be,{title:r.jsxs("div",{children:[r.jsx(W,{variant:"subtitle2",children:"Danh sách đồng tác giả:"}),t.map(((e,n)=>r.jsxs(W,{variant:"body2",children:["• ",e.fullName," - ",e.userName," - ",e.departmentName||"Chưa có phòng ban"]},n)))]}),children:r.jsx("div",{children:i})})}},{field:"authorRoleName",headerName:"Vai trò tác giả",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:a?a.authorRoleName:"-"})}},{field:"position",headerName:"Vị trí",type:"string",width:80,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:null!=a?.position?a.position:"-"})}},{field:"purposeName",headerName:"Mục đích quy đổi",type:"string",width:180,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:a?a.purposeName:"-"})}},{field:"scoreLevel",headerName:"Mức điểm",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return a&&void 0!==a.scoreLevel&&null!==a.scoreLevel?r.jsx("div",{children:xa(a.scoreLevel)}):r.jsx("div",{children:"-"})}},{field:"authorHour",headerName:"Giờ tác giả",type:"string",width:120,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id));return r.jsx("div",{children:null!=a?.authorHour?a.authorHour:"-"})}},{field:"proofStatus",headerName:"Trạng thái",type:"string",width:140,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id)),i=a?.proofStatus;return null==i?r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:"-"}):i===qa.HopLe?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Ie,{color:"success"}),"Hợp lệ"]}):i===qa.KhongHopLe?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Te,{color:"error"}),"Không hợp lệ"]}):i===qa.ChuaXuLy?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Me,{color:"action"}),"Chưa xử lý"]}):r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:"-"})}},{field:"actions",headerName:"Thao tác",width:250,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===t?.id)),i=v(a),s=m.has(a?.id);return r.jsxs(O,{children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>(async e=>{const n=e.authors?.find((e=>e.userId===t?.id));if(n){g((e=>{const a=new Map(e);return a.set(n.id,!0),a}));try{await S.mutateAsync({authorId:n.id,registered:!0})}catch(a){}}else T.error("Không tìm thấy thông tin tác giả")})(n),disabled:i||s,sx:{marginRight:1,"&.Mui-disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",color:"rgba(0, 0, 0, 0.26)"}},children:s?r.jsx($,{size:24}):"Đăng ký"}),r.jsx(c,{variant:"contained",color:"error",size:"small",onClick:()=>{C(n.id),b(!0)},disabled:!i||s,sx:{"&.Mui-disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",color:"rgba(0, 0, 0, 0.26)"}},children:s?r.jsx($,{size:24}):"Hủy đăng ký"})]})}}];return y?r.jsx($,{}):j?r.jsxs("p",{children:["Lỗi: ",j.message]}):r.jsxs(Ee,{maxWidth:"xl",children:[r.jsxs(O,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[r.jsx(W,{variant:"h6",children:"Danh sách công trình có thể đăng ký"}),r.jsx(O,{sx:{display:"flex",gap:2}})]}),y?r.jsx(O,{sx:{display:"flex",justifyContent:"center",mt:4},children:r.jsx($,{})}):r.jsx(ra,{columns:N,data:d}),r.jsxs(i,{open:w,onClose:I,children:[r.jsx(s,{children:"Xác nhận hủy đăng ký"}),r.jsx(l,{children:r.jsx(W,{children:"Bạn có chắc chắn muốn hủy đăng ký công trình này không?"})}),r.jsxs(o,{children:[r.jsx(c,{onClick:I,color:"inherit",children:"Hủy"}),r.jsx(c,{onClick:()=>{k&&((async e=>{const n=d.find((n=>n.id===e)),a=n?.authors?.find((e=>e.userId===t?.id));if(a){g((e=>{const n=new Map(e);return n.set(a.id,!1),n}));try{await S.mutateAsync({authorId:a.id,registered:!1})}catch(r){}}else T.error("Không tìm thấy thông tin tác giả")})(k),I())},color:"error",variant:"contained",disabled:S.isPending,children:S.isPending?r.jsx($,{size:24}):"Hủy đăng ký"})]})]})]})}function kt({open:e,onClose:n,status:a,onStatusChange:t,onSubmit:d,isPending:h}){return r.jsxs(i,{open:e,onClose:n,children:[r.jsx(s,{children:"Cập nhật trạng thái công trình"}),r.jsxs(l,{children:[r.jsxs(se,{fullWidth:!0,margin:"normal",children:[r.jsx(xe,{id:"status-select-label",children:"Trạng thái"}),r.jsxs(pe,{labelId:"status-select-label",value:a,onChange:t,label:"Trạng thái",children:[r.jsx(Q,{value:qa.HopLe,children:"Hợp lệ"}),r.jsx(Q,{value:qa.KhongHopLe,children:"Không hợp lệ"}),r.jsx(Q,{value:qa.ChuaXuLy,children:"Chưa xử lý"})]})]}),r.jsx(W,{variant:"caption",color:"textSecondary",sx:{mt:1,display:"block"},children:"Dialog sẽ tự động đóng sau khi cập nhật thành công."})]}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,children:"Hủy"}),r.jsx(c,{onClick:d,variant:"contained",color:"primary",disabled:h,children:h?r.jsx($,{size:24}):"Cập nhật"})]})]})}function Ct({open:e,onClose:n,note:a,onNoteChange:t,onSubmit:d,isPending:h}){return r.jsxs(i,{open:e,onClose:n,fullWidth:!0,maxWidth:"sm",children:[r.jsx(s,{children:"Cập nhật ghi chú"}),r.jsxs(l,{children:[r.jsx(de,{fullWidth:!0,multiline:!0,rows:4,margin:"normal",label:"Ghi chú",value:a,onChange:t}),r.jsx(W,{variant:"caption",color:"textSecondary",sx:{mt:1,display:"block"},children:"Dialog sẽ tự động đóng sau khi cập nhật thành công."})]}),r.jsxs(o,{children:[r.jsx(c,{onClick:n,children:"Hủy"}),r.jsx(c,{onClick:d,variant:"contained",color:"primary",disabled:h,children:h?r.jsx($,{size:24}):"Cập nhật"})]})]})}function It(){const{userId:e}=rn(),n=I(),[a,t]=u.useState({}),i=Aa(),{data:s}=B({queryKey:["current-academic-year"],queryFn:Ba}),{data:l,isLoading:d,error:o}=B({queryKey:["users",e],queryFn:()=>vn(e||""),enabled:!!e}),{data:h,isLoading:m,error:g,refetch:x}=B({queryKey:["works","user",e],queryFn:async()=>Sa({userId:e,academicYearId:s?.data?.id,isCurrentUser:!1}),enabled:!!e&&!!s?.data?.id});u.useEffect((()=>{h?.data&&h.data.length>0&&(async()=>{const e={};for(const a of h.data)if(a.coAuthorUserIds&&a.coAuthorUserIds.length>0){const t=[];for(const e of a.coAuthorUserIds)try{const n=await vn(e);n.success&&n.data&&t.push(n.data)}catch(n){console.error("Lỗi khi lấy thông tin đồng tác giả:",n)}e[a.id]=t}t(e)})()}),[h]);const{selectedWork:p,openUpdateDialog:j,openStatusDialog:y,openNoteDialog:f,newStatus:v,newNote:w,activeTab:b,updateWorkMutation:k,createWorkMutation:C,handleOpenUpdateDialog:T,handleCloseUpdateDialog:S,handleOpenStatusDialog:N,handleCloseStatusDialog:q,handleOpenNoteDialog:L,handleCloseNoteDialog:P,handleStatusChange:A,handleNoteChange:D,handleStatusSubmit:R,handleNoteSubmit:K,handleUpdateSubmit:H,setActiveTab:F}=Wa({userId:e,worksData:h,refetchWorks:x,isAuthorPage:!1}),E=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=e.api.getAllRowIds().indexOf(e.id);return r.jsx("div",{children:n+1})}},{field:"title",headerName:"Tên công trình",type:"string",width:250},{field:"timePublished",headerName:"Thời gian xuất bản",type:"string",width:150,renderCell:e=>{if(!e.value)return r.jsx("div",{children:"-"});try{const n=Ne(new Date(e.value),"dd/MM/yyyy",{locale:qe});return r.jsx("div",{children:n})}catch(n){return r.jsx("div",{children:e.value})}}},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:150},{field:"workLevelName",headerName:"Cấp công trình",type:"string",width:150},{field:"details",headerName:"Thông tin chi tiết",type:"string",width:300,renderCell:e=>{if(!e.row.details)return r.jsx("div",{children:"-"});const n=e.row.details,a=Object.entries(n).map((([e,n])=>`${e}: ${String(n)}`)).join("\n");return r.jsx(Be,{title:r.jsx("div",{style:{whiteSpace:"pre-line",fontSize:"0.8rem"},children:a}),arrow:!0,children:r.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",width:"100%"},children:Object.entries(n).map((([e,n],a)=>r.jsxs("span",{children:[a>0&&"; ",r.jsx("b",{children:e}),": ",String(n)]},a)))})})}},{field:"totalAuthors",headerName:"Số tác giả",type:"number",width:140,align:"center",headerAlign:"left"},{field:"totalMainAuthors",headerName:"Số tác giả chính",type:"number",width:140,align:"center",headerAlign:"left"},{field:"coAuthors",headerName:"Đồng tác giả",type:"string",width:140,renderCell:e=>{const n=e.row.id,t=a[n]||[];if(0===t.length)return r.jsx("div",{children:"-"});const i=`${t.length} tác giả`;return r.jsx(Be,{title:r.jsxs("div",{children:[r.jsx(W,{variant:"subtitle2",children:"Danh sách đồng tác giả:"}),t.map(((e,n)=>r.jsxs(W,{variant:"body2",children:["• ",e.fullName," - ",e.userName," - ",e.departmentName||"Chưa có phòng ban"]},n)))]}),children:r.jsx("div",{children:i})})}},{field:"authorRoleName",headerName:"Vai trò tác giả",type:"string",width:150,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e));return r.jsx("div",{children:t?t.authorRoleName:"-"})}},{field:"position",headerName:"Vị trí",type:"string",width:80,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e));return r.jsx("div",{children:null!=t?.position?t.position:"-"})}},{field:"purposeName",headerName:"Mục đích quy đổi",type:"string",width:180,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e));return r.jsx("div",{children:t?t.purposeName:"-"})}},{field:"fieldName",headerName:"Ngành tính điểm",type:"string",width:150,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e));return r.jsx("div",{children:t?t.fieldName:"-"})}},{field:"scImagoFieldName",headerName:"Ngành SCImago",type:"string",width:180,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e));return r.jsx("div",{children:t?t.scImagoFieldName:"-"})}},{field:"scoreLevel",headerName:"Mức điểm",type:"string",width:120,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e));return t&&void 0!==t.scoreLevel&&null!==t.scoreLevel?r.jsx("div",{children:xa(t.scoreLevel)}):r.jsx("div",{children:"-"})}},{field:"workHour",headerName:"Giờ công trình",type:"string",width:120,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e));return r.jsx("div",{children:null!=t?.workHour?t.workHour:"-"})}},{field:"authorHour",headerName:"Giờ tác giả",type:"string",width:120,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e));return r.jsx("div",{children:null!=t?.authorHour?t.authorHour:"-"})}},{field:"note",headerName:"Ghi chú",type:"string",width:150,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e)),i=t?.note||"";return i?r.jsx(Be,{title:r.jsx("div",{style:{whiteSpace:"pre-line",fontSize:"0.8rem"},children:i}),arrow:!0,children:r.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",width:"100%"},children:i})}):r.jsx("div",{children:"-"})}},{field:"proofStatus",headerName:"Trạng thái",type:"string",width:140,renderCell:n=>{const a=n.row,t=a.authors?.find((n=>n.userId===e)),i=t?.proofStatus;return null==i?r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:"-"}):i===qa.HopLe?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Ie,{color:"success"}),"Hợp lệ"]}):i===qa.KhongHopLe?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Te,{color:"error"}),"Không hợp lệ"]}):i===qa.ChuaXuLy?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Me,{color:"action"}),"Chưa xử lý"]}):r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:"-"})}},{field:"actions",headerName:"Thao tác",width:350,renderCell:e=>r.jsxs(O,{display:"flex",gap:1,alignItems:"center",height:"100%",children:[r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>T(e.row),startIcon:r.jsx(ln,{}),children:"Cập nhật"}),r.jsx(c,{variant:"contained",color:"info",size:"small",onClick:()=>N(e.row),startIcon:r.jsx(dn,{}),children:"Trạng thái"}),r.jsx(c,{variant:"contained",color:"secondary",size:"small",onClick:()=>L(e.row),startIcon:r.jsx(on,{}),children:"Ghi chú"})]})}];if(d||m)return r.jsx(O,{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",children:r.jsx($,{})});if(o||g)return r.jsx(O,{p:3,children:r.jsxs(W,{color:"error",children:[o?"Lỗi khi tải thông tin người dùng: "+o.message:"",g?"Lỗi khi tải danh sách công trình: "+g.message:""]})});const z=l?.data,M=h?.data||[];return r.jsxs(Ee,{maxWidth:"xl",children:[r.jsxs(O,{sx:{display:"flex",alignItems:"center",mb:2},children:[r.jsx(c,{variant:"outlined",startIcon:r.jsx(sn,{}),onClick:()=>{n(-1)},sx:{mr:2},children:"Quay lại"}),r.jsxs(W,{variant:"h4",children:["Chấm điểm công trình - ",z?.fullName]})]}),r.jsx(O,{sx:{mb:3},children:r.jsxs(ke,{sx:{p:2},children:[r.jsx(W,{variant:"h6",gutterBottom:!0,children:"Thông tin người dùng"}),r.jsxs(O,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:[r.jsxs(W,{variant:"body1",children:[r.jsx("strong",{children:"Mã số viên chức:"})," ",z?.userName]}),r.jsxs(W,{variant:"body1",children:[r.jsx("strong",{children:"Họ và tên:"})," ",z?.fullName]}),r.jsxs(W,{variant:"body1",children:[r.jsx("strong",{children:"Đơn vị công tác:"})," ",z?.departmentName||"Chưa có phòng ban"]}),r.jsxs(W,{variant:"body1",children:[r.jsx("strong",{children:"Ngành:"})," ",z?.fieldName||"Chưa phân ngành"]})]})]})}),r.jsxs(O,{sx:{mb:2},children:[r.jsx(W,{variant:"h6",gutterBottom:!0,children:"Danh sách công trình"}),r.jsx(ke,{sx:{width:"100%",overflow:"hidden"},children:r.jsx(O,{sx:{height:600},children:r.jsx(ra,{columns:E,data:M})})})]}),r.jsx(kt,{open:y,onClose:q,status:v,onStatusChange:e=>A(Number(e.target.value)),onSubmit:R,isPending:k.isPending}),r.jsx(Ct,{open:f,onClose:P,note:w,onNoteChange:e=>D(e.target.value),onSubmit:K,isPending:k.isPending}),r.jsx(Fa,{open:j,onClose:S,selectedWork:p,activeTab:b,setActiveTab:F,onSubmit:H,isPending:C.isPending||k.isPending,workTypes:i.workTypes,workLevels:i.workLevels,authorRoles:i.authorRoles,purposes:i.purposes,scimagoFields:i.scimagoFields,fields:i.fields})]})}const Tt=J({fullName:ee().min(1,"Họ tên không được để trống"),email:ee().email("Email không hợp lệ"),phoneNumber:ee().min(1,"Số điện thoại không được để trống").max(10,"Số điện thoại không hợp lệ"),specialization:ee().min(1,"Chuyên ngành không được để trống"),departmentId:ee().min(1,"Đơn vị công tác không được để trống"),fieldId:ee().min(1,"Ngành không được để trống"),academicTitle:ee().min(1,"Học hàm không được để trống"),officerRank:ee().min(1,"Ngạch công chức không được để trống")}),St=J({currentPassword:ee().min(1,"Mật khẩu hiện tại không được để trống"),newPassword:ee().min(1,"Mật khẩu mới không được để trống"),confirmNewPassword:ee().min(1,"Xác nhận mật khẩu mới không được để trống")}).refine((e=>e.newPassword===e.confirmNewPassword),{message:"Mật khẩu mới không khớp",path:["confirmNewPassword"]});function Nt(){const[e,n]=u.useState(null),{setUser:a,refreshUserInfo:t}=Tn(),[i,s]=u.useState([]),[l,d]=u.useState([]),{control:o,register:h,handleSubmit:m,reset:g,formState:{errors:x,isSubmitting:p}}=te({resolver:ue(Tt)}),{register:j,handleSubmit:y,reset:f,formState:{errors:v,isSubmitting:w}}=te({resolver:ue(St)}),{data:b,isLoading:k}=B({queryKey:["user"],queryFn:bn});return u.useEffect((()=>{b?.success&&b.data&&(n(b.data),g({departmentId:"00000000-0000-0000-0000-000000000000"===b.data.departmentId?"":b.data.departmentId,fieldId:"00000000-0000-0000-0000-000000000000"===b.data.fieldId?"":b.data.fieldId,academicTitle:"Unknown"===b.data.academicTitle?"":b.data.academicTitle,officerRank:"Unknown"===b.data.officerRank?"":b.data.officerRank,fullName:b.data.fullName,email:"-"===b.data.email?"":b.data.email,phoneNumber:"-"===b.data.phoneNumber?"":b.data.phoneNumber,specialization:"-"===b.data.specialization?"":b.data.specialization}))}),[b,g]),u.useEffect((()=>{!async function(){const e=await Gn();s(e.data||[]);const n=await $n();d(n.data||[])}()}),[]),!e||k?r.jsx($,{}):r.jsxs(r.Fragment,{children:[r.jsx(W,{variant:"h4",fontWeight:500,sx:{my:3},children:"Cập nhật thông tin cá nhân"}),r.jsx(O,{maxWidth:"sm",children:r.jsxs("form",{onSubmit:m((async n=>{try{if(!e)return;if((await(async(e,n)=>(await fn.put(`/users/${e}`,n)).data)(e.id,n)).success){const n=(await vn(e.id)).data;a(n)}await t(),T.success("Cập nhật hồ sơ thành công")}catch(r){T.error("Lỗi khi cập nhật hồ sơ")}})),noValidate:!0,children:[r.jsx(de,{label:"Họ và tên",fullWidth:!0,margin:"dense",...h("fullName"),error:!!x.fullName,helperText:x.fullName?.message,disabled:p}),r.jsx(de,{label:"Email",fullWidth:!0,margin:"dense",...h("email"),error:!!x.email,helperText:x.email?.message,disabled:p}),r.jsx(de,{label:"Số điện thoại",fullWidth:!0,margin:"dense",...h("phoneNumber"),disabled:p}),r.jsx(de,{label:"Chuyên ngành",fullWidth:!0,margin:"dense",...h("specialization"),disabled:p}),r.jsx(ge,{name:"departmentId",control:o,render:({field:e})=>r.jsxs(de,{select:!0,label:"Đơn vị công tác",...e,error:!!x.departmentId,helperText:x.departmentId?.message,fullWidth:!0,margin:"dense",disabled:p,children:[r.jsx(Q,{value:"",children:"Chọn đơn vị"}),i.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})}),r.jsx(ge,{name:"fieldId",control:o,render:({field:e})=>r.jsxs(de,{select:!0,label:"Ngành",...e,error:!!x.fieldId,helperText:x.fieldId?.message,fullWidth:!0,margin:"dense",disabled:p,children:[r.jsx(Q,{value:"",children:"Chọn ngành"}),l.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})}),r.jsx(ge,{name:"academicTitle",control:o,render:({field:e})=>r.jsx(de,{select:!0,label:"Học hàm",...e,error:!!x.academicTitle,helperText:x.academicTitle?.message,fullWidth:!0,margin:"dense",disabled:p,children:Object.entries(On).filter((([e])=>isNaN(Number(e)))).map((([e])=>r.jsx(Q,{value:e,children:Wn(e)},e)))})}),r.jsx(ge,{name:"officerRank",control:o,render:({field:e})=>r.jsx(de,{select:!0,label:"Ngạch công chức",...e,error:!!x.officerRank,helperText:x.officerRank?.message,fullWidth:!0,margin:"dense",disabled:p,children:Object.entries(Yn).filter((([e])=>isNaN(Number(e)))).map((([e])=>r.jsx(Q,{value:e,children:Rn(e)},e)))})}),r.jsx(c,{variant:"contained",type:"submit",fullWidth:!0,sx:{mt:2},disabled:p,children:p?"Đang tải...":"Cập nhật thông tin"})]})}),r.jsx(D,{sx:{my:3}}),r.jsxs(O,{maxWidth:"sm",sx:{mt:3},children:[r.jsx(W,{variant:"h4",fontWeight:500,sx:{mb:2},children:"Đổi mật khẩu"}),r.jsxs("form",{onSubmit:y((async e=>{try{await(async(e,n)=>(await fn.post("/auth/change-password",{currentPassword:e,newPassword:n})).data)(e.currentPassword,e.newPassword),T.success("Đổi mật khẩu thành công"),f()}catch(n){T.error("Lỗi khi đổi mật khẩu")}})),noValidate:!0,children:[r.jsx(de,{label:"Mật khẩu hiện tại",fullWidth:!0,margin:"dense",type:"password",...j("currentPassword"),error:!!v.currentPassword,helperText:v.currentPassword?.message,disabled:w}),r.jsx(de,{label:"Mật khẩu mới",fullWidth:!0,margin:"dense",type:"password",...j("newPassword"),error:!!v.newPassword,helperText:v.newPassword?.message,disabled:w}),r.jsx(de,{label:"Xác nhận mật khẩu mới",fullWidth:!0,margin:"dense",type:"password",...j("confirmNewPassword"),error:!!v.confirmNewPassword,helperText:v.confirmNewPassword?.message,disabled:w}),r.jsx(c,{variant:"contained",type:"submit",fullWidth:!0,sx:{mt:2},disabled:w,children:w?"Đang tải...":"Đổi mật khẩu"})]})]})]})}function qt(){const e=I(),[n,a]=u.useState(""),{user:t}=Tn(),{data:i,isLoading:s,error:l}=B({queryKey:["departments",t?.role,t?.id],queryFn:async()=>"Manager"===t?.role?await Qn(t.id):await Gn(),enabled:!!t}),{data:d,isLoading:o,error:h}=B({queryKey:["users","department",n],queryFn:()=>kn(n),enabled:!!n}),m=[{field:"userName",headerName:"Mã số viên chức",width:150},{field:"fullName",headerName:"Họ và tên",width:250},{field:"departmentName",headerName:"Đơn vị công tác",width:250},{field:"fieldName",headerName:"Ngành",width:200,renderCell:e=>r.jsx("div",{children:e.row.fieldName||"Chưa phân ngành"})},{field:"actions",headerName:"Thao tác",width:170,renderCell:n=>r.jsx(c,{variant:"contained",color:"primary",size:"small",onClick:()=>{return a=n.row.id,void e(`/cham-diem/user/${a}`);var a},startIcon:r.jsx(cn,{}),children:"Xem công trình"})}];if(s)return r.jsx(O,{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",children:r.jsx($,{})});if(l)return r.jsx(O,{p:3,children:r.jsxs(W,{color:"error",children:["Lỗi khi tải danh sách phòng ban: ",l.message]})});const g=i?.data||[];return r.jsxs(Ee,{maxWidth:"xl",children:[r.jsxs(O,{sx:{mb:4},children:[r.jsx(W,{variant:"h5",gutterBottom:!0,children:"Danh sách người dùng theo phòng ban"}),r.jsxs(se,{fullWidth:!0,sx:{mt:2},children:[r.jsx(xe,{id:"department-select-label",children:"Chọn phòng ban"}),r.jsxs(pe,{labelId:"department-select-label",id:"department-select",value:n,label:"Chọn phòng ban",onChange:e=>{a(e.target.value)},children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Chọn phòng ban"})}),g.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]})]}),n?o?r.jsx(O,{display:"flex",justifyContent:"center",py:4,children:r.jsx($,{})}):h?r.jsxs(W,{color:"error",children:["Lỗi khi tải danh sách người dùng: ",h.message]}):r.jsxs(r.Fragment,{children:[r.jsx(W,{variant:"h6",mb:2,children:"Danh sách người dùng thuộc phòng ban"}),r.jsx(ke,{sx:{width:"100%",overflow:"hidden"},children:r.jsx(O,{sx:{height:500},children:r.jsx(ra,{columns:m,data:d?.data||[]})})})]}):r.jsx(W,{variant:"subtitle1",color:"text.secondary",textAlign:"center",py:4,children:"Vui lòng chọn phòng ban để xem danh sách người dùng"})]})}const Lt=async()=>(await fn.get("/cache/keys")).data,Pt=async()=>(await fn.delete("/cache/clear-all")).data;function At(){const e=z(),{data:n,error:a,isPending:t,isSuccess:i,dataUpdatedAt:s,refetch:l}=B({queryKey:["cache-keys"],queryFn:Lt});u.useEffect((()=>{i&&n&&T.success("Tải danh sách cache thành công",{toastId:"fetch-caches"})}),[s]),u.useEffect((()=>{a&&T.error("Lỗi khi fetch cache: "+a.message)}),[a]);const d=ve({mutationFn:e=>(async e=>(await fn.delete(`/cache/clear/${e}`)).data)(e),onSuccess:()=>{T.success("Đã xóa cache"),e.invalidateQueries({queryKey:["cache-keys"]}),l()},onError:e=>{T.error("Xóa thất bại: "+e.message)}}),o=ve({mutationFn:Pt,onSuccess:()=>{T.success("Xóa tất cả cache thành công"),e.invalidateQueries({queryKey:["cache-keys"]}),l()},onError:e=>{T.error("Xóa toàn bộ cache thất bại: "+e.message)}}),h=[{field:"key",headerName:"Cache Key",width:600},{field:"actions",headerName:"Hành động",width:200,renderCell:e=>r.jsx(c,{variant:"outlined",color:"error",size:"small",onClick:()=>d.mutate(e.row.key),disabled:d.isPending,children:"Xóa"})}];return t?r.jsx($,{}):a?r.jsxs("p",{children:["Error: ",a.message]}):r.jsxs(r.Fragment,{children:[r.jsxs(O,{display:"flex",justifyContent:"space-between",mb:2,children:[r.jsx(W,{variant:"h6",children:"Quản lý Cache"}),r.jsx(c,{variant:"contained",color:"error",onClick:()=>o.mutate(),disabled:o.isPending,children:o.isPending?"Đang xóa...":"Xóa tất cả"})]}),r.jsx(ke,{sx:{width:900,margin:"auto"},children:r.jsx(ra,{columns:h,data:(n?.data||[]).map((e=>({id:e,key:e})))})})]})}const Wt=()=>{const[e,n]=u.useState(!1),[a,t]=u.useState(null),[i,s]=u.useState([]),[l,d]=u.useState([]),{user:o}=Tn(),[h,m]=u.useState({academicYearId:"",proofStatus:void 0,source:void 0,onlyRegisteredWorks:!1,onlyRegisterableWorks:!1,isCurrentUser:!0});u.useEffect((()=>{(async()=>{try{const e=await za();d(e.data||[])}catch(e){t("Lỗi khi tải dữ liệu ban đầu"),console.error("Error fetching initial data:",e)}})()}),[]);const g=e=>{const{name:n,checked:a}=e.target;m((e=>({...e,[n]:a})))},x=e=>{const{name:n,value:a}=e.target;m("proofStatus"===n||"source"===n?e=>({...e,[n]:""===a?void 0:Number(a)}):e=>({...e,[n]:a}))},p=e=>{switch(e){case Da.NguoiDungKeKhai:return"Người dùng kê khai";case Da.QuanLyNhap:return"Quản lý nhập";default:return"N/A"}},j=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=e.api.getAllRowIds().indexOf(e.id);return r.jsx("div",{children:n+1})}},{field:"title",headerName:"Tên công trình",type:"string",width:250},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:170},{field:"workLevelName",headerName:"Cấp công trình",type:"string",width:150},{field:"source",headerName:"Nguồn",type:"string",width:150,renderCell:e=>r.jsx("div",{children:p(e.value)})},{field:"academicYearName",headerName:"Năm học",type:"string",width:150},{field:"proofStatus",headerName:"Trạng thái xác minh",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===o?.id));return a?(e=>{switch(e){case qa.HopLe:return r.jsx(Be,{title:"Hợp lệ",children:r.jsx(Ce,{icon:r.jsx(Ie,{}),label:"Hợp lệ",color:"success",size:"small"})});case qa.KhongHopLe:return r.jsx(Be,{title:"Không hợp lệ",children:r.jsx(Ce,{icon:r.jsx(Te,{}),label:"Không hợp lệ",color:"error",size:"small"})});case qa.ChuaXuLy:return r.jsx(Be,{title:"Chưa xử lý",children:r.jsx(Ce,{icon:r.jsx(Me,{}),label:"Chưa xử lý",color:"warning",size:"small"})});default:return null}})(a.proofStatus):null}},{field:"isRegistered",headerName:"Trạng thái đăng ký",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===o?.id)),t=null!=a?.authorRegistration;return r.jsx(Ce,{label:t?"Đã đăng ký":"Chưa đăng ký",color:t?"success":"default",size:"small"})}}];return r.jsxs(Ee,{maxWidth:"xl",sx:{mt:4,mb:4},children:[r.jsxs(ke,{sx:{p:3,mb:3,borderRadius:2,boxShadow:3},children:[r.jsxs(A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsxs(W,{variant:"h6",display:"flex",alignItems:"center",color:"primary",children:[r.jsx(hn,{sx:{mr:1}}),"Bộ lọc"]}),r.jsxs(A,{direction:"row",spacing:2,children:[r.jsx(c,{variant:"outlined",color:"primary",onClick:()=>{m({academicYearId:"",proofStatus:void 0,source:void 0,onlyRegisteredWorks:!1,onlyRegisterableWorks:!1,isCurrentUser:!0})},startIcon:r.jsx(un,{}),children:"Đặt lại"}),r.jsx(c,{variant:"contained",color:"primary",onClick:async()=>{n(!0),t(null);try{const e=await Sa(h);s(e.data||[])}catch(e){console.error("Error fetching works:",e),t("Lỗi khi tải danh sách công trình")}finally{n(!1)}},disabled:e,startIcon:e?r.jsx($,{size:20}):r.jsx(hn,{}),children:"Tìm kiếm"})]})]}),r.jsx(D,{sx:{mb:3}}),r.jsxs(R,{container:!0,spacing:3,children:[r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(se,{fullWidth:!0,size:"small",children:[r.jsx(xe,{children:"Năm học"}),r.jsxs(pe,{name:"academicYearId",value:h.academicYearId||"",onChange:x,label:"Năm học",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),l.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]})}),r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(se,{fullWidth:!0,size:"small",children:[r.jsx(xe,{children:"Trạng thái xác minh"}),r.jsxs(pe,{name:"proofStatus",value:void 0!==h.proofStatus?h.proofStatus:"",onChange:x,label:"Trạng thái xác minh",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),r.jsx(Q,{value:qa.HopLe,children:"Hợp lệ"}),r.jsx(Q,{value:qa.KhongHopLe,children:"Không hợp lệ"}),r.jsx(Q,{value:qa.ChuaXuLy,children:"Chưa xử lý"})]})]})}),r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(se,{fullWidth:!0,size:"small",children:[r.jsx(xe,{children:"Nguồn"}),r.jsxs(pe,{name:"source",value:void 0!==h.source?h.source:"",onChange:x,label:"Nguồn",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),r.jsx(Q,{value:Da.NguoiDungKeKhai,children:"Người dùng kê khai"}),r.jsx(Q,{value:Da.QuanLyNhap,children:"Quản lý nhập"})]})]})}),r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(O,{display:"flex",flexDirection:"column",gap:2,children:[r.jsx(we,{control:r.jsx(be,{checked:h.onlyRegisteredWorks,onChange:g,name:"onlyRegisteredWorks"}),label:"Công trình đã đăng ký"}),r.jsx(we,{control:r.jsx(be,{checked:h.onlyRegisterableWorks,onChange:g,name:"onlyRegisterableWorks"}),label:"Công trình có thể đăng ký"})]})})]})]}),r.jsxs(ke,{sx:{p:3,borderRadius:2,boxShadow:3},children:[r.jsxs(A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsxs(W,{variant:"h6",display:"flex",alignItems:"center",children:[r.jsxs("span",{children:["Kết quả (",i.length," công trình)"]}),e&&r.jsx($,{size:24,sx:{ml:2}})]}),r.jsx(c,{variant:"outlined",color:"primary",onClick:async()=>{try{n(!0);const e=await(async e=>(console.log("Đang gọi API xuất Excel với filter:",e),(await fn.get("/excel/export-by-user",{params:{academicYearId:e.academicYearId,proofStatus:e.proofStatus,source:e.source,onlyRegisteredWorks:e.onlyRegisteredWorks,onlyRegisterableWorks:e.onlyRegisterableWorks},responseType:"blob"})).data))(h),a=window.URL.createObjectURL(e),t=document.createElement("a");t.href=a,t.setAttribute("download",`KeKhaiCongTrinh_${(new Date).toISOString().slice(0,10)}.xlsx`),document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(a)}catch(e){console.error("Lỗi khi export:",e),t("Lỗi khi xuất file Excel")}finally{n(!1)}},startIcon:r.jsx(mn,{}),disabled:0===i.length,children:"Xuất Excel"})]}),a&&r.jsx(ie,{severity:"error",sx:{mb:2},children:a}),0!==i.length||e?r.jsx(ra,{columns:j,data:i}):r.jsx(ie,{severity:"info",children:"Không có công trình nào được tìm thấy. Vui lòng thay đổi bộ lọc hoặc thử lại."})]})]})},Dt=()=>{const[e,n]=u.useState(!1),[a,t]=u.useState(null),[i,s]=u.useState([]),[l,d]=u.useState([]),[o,h]=u.useState([]),{user:m}=Tn(),[g,x]=u.useState({academicYearId:"",departmentId:"",userId:"",proofStatus:void 0,source:void 0,onlyRegisteredWorks:!1});u.useEffect((()=>{(async()=>{try{const[e,n]=await Promise.all([za(),"Manager"===m?.role?Qn(m.id):Gn()]);d(e.data||[]),h(n.data||[])}catch(e){t("Lỗi khi tải dữ liệu ban đầu"),console.error("Error fetching initial data:",e)}})()}),[m]);const{data:p}=B({queryKey:["users","department",g.departmentId],queryFn:()=>kn(g.departmentId||""),enabled:!!g.departmentId}),j=p?.data||[],y=e=>{const{name:n,value:a}=e.target;x("proofStatus"===n||"source"===n?e=>({...e,[n]:""===a?void 0:Number(a)}):e=>({...e,[n]:a})),"departmentId"===n&&x((e=>({...e,userId:""})))},f=e=>{switch(e){case Da.NguoiDungKeKhai:return"Người dùng kê khai";case Da.QuanLyNhap:return"Quản lý nhập";default:return"N/A"}},v=[{field:"stt",headerName:"STT",width:70,renderCell:e=>{const n=e.api.getAllRowIds().indexOf(e.id);return r.jsx("div",{children:n+1})}},{field:"title",headerName:"Tên công trình",type:"string",width:250},{field:"workTypeName",headerName:"Loại công trình",type:"string",width:170},{field:"workLevelName",headerName:"Cấp công trình",type:"string",width:150},{field:"source",headerName:"Nguồn",type:"string",width:150,renderCell:e=>r.jsx("div",{children:f(e.value)})},{field:"academicYearName",headerName:"Năm học",type:"string",width:150},{field:"departmentName",headerName:"Phòng ban",type:"string",width:200},{field:"authorRoleName",headerName:"Vai trò tác giả",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id));return r.jsx("div",{children:a?a.authorRoleName:"-"})}},{field:"position",headerName:"Vị trí",type:"string",width:80,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id));return r.jsx("div",{children:null!=a?.position?a.position:"-"})}},{field:"purposeName",headerName:"Mục đích quy đổi",type:"string",width:180,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id));return r.jsx("div",{children:a?a.purposeName:"-"})}},{field:"fieldName",headerName:"Ngành tính điểm",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id));return r.jsx("div",{children:a?a.fieldName:"-"})}},{field:"scImagoFieldName",headerName:"Ngành SCImago",type:"string",width:180,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id));return r.jsx("div",{children:a?a.scImagoFieldName:"-"})}},{field:"scoreLevel",headerName:"Mức điểm",type:"string",width:150,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id));return a&&void 0!==a.scoreLevel&&null!==a.scoreLevel?r.jsx("div",{children:xa(a.scoreLevel)}):r.jsx("div",{children:"-"})}},{field:"workHour",headerName:"Giờ công trình",type:"string",width:120,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id));return r.jsx("div",{children:null!=a?.workHour?a.workHour:"-"})}},{field:"authorHour",headerName:"Giờ tác giả",type:"string",width:120,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id));return r.jsx("div",{children:null!=a?.authorHour?a.authorHour:"-"})}},{field:"proofStatus",headerName:"Trạng thái",type:"string",width:140,renderCell:e=>{const n=e.row,a=n.authors?.find((e=>e.userId===m?.id)),t=a?.proofStatus;return null==t?r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:"-"}):t===qa.HopLe?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Ie,{color:"success"}),"Hợp lệ"]}):t===qa.KhongHopLe?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Te,{color:"error"}),"Không hợp lệ"]}):t===qa.ChuaXuLy?r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(Me,{color:"action"}),"Chưa xử lý"]}):r.jsx("div",{style:{display:"flex",alignItems:"center",gap:"4px"},children:"-"})}},{field:"isRegistered",headerName:"Trạng thái đăng ký",type:"string",width:150,renderCell:e=>{const n=e.row.authors&&e.row.authors[0],a=null!=n?.authorRegistration;return r.jsx(Ce,{label:a?"Đã đăng ký":"Chưa đăng ký",color:a?"success":"default",size:"small"})}}];return r.jsxs(Ee,{maxWidth:"xl",sx:{mt:4,mb:4},children:[r.jsxs(ke,{sx:{p:3,mb:3,borderRadius:2,boxShadow:3},children:[r.jsxs(A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsxs(W,{variant:"h6",display:"flex",alignItems:"center",color:"primary",children:[r.jsx(hn,{sx:{mr:1}}),"Bộ lọc"]}),r.jsxs(A,{direction:"row",spacing:2,children:[r.jsx(c,{variant:"outlined",color:"primary",onClick:()=>{x({academicYearId:"",departmentId:"",userId:"",proofStatus:void 0,source:void 0,onlyRegisteredWorks:!1})},startIcon:r.jsx(un,{}),children:"Đặt lại"}),r.jsx(c,{variant:"contained",color:"primary",onClick:async()=>{n(!0),t(null);try{const e=await Sa({...g,isCurrentUser:!1});s(e.data||[])}catch(e){console.error("Error fetching works:",e),t("Lỗi khi tải danh sách công trình")}finally{n(!1)}},disabled:e,startIcon:e?r.jsx($,{size:20}):r.jsx(hn,{}),children:"Tìm kiếm"})]})]}),r.jsx(D,{sx:{mb:3}}),r.jsxs(R,{container:!0,spacing:3,children:[r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(se,{fullWidth:!0,size:"small",children:[r.jsx(xe,{children:"Năm học"}),r.jsxs(pe,{name:"academicYearId",value:g.academicYearId||"",onChange:y,label:"Năm học",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),l.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]})}),r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(se,{fullWidth:!0,size:"small",children:[r.jsx(xe,{children:"Phòng ban"}),r.jsxs(pe,{name:"departmentId",value:g.departmentId||"",onChange:y,label:"Phòng ban",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),o.map((e=>r.jsx(Q,{value:e.id,children:e.name},e.id)))]})]})}),r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(se,{fullWidth:!0,size:"small",children:[r.jsx(xe,{children:"Người dùng"}),r.jsxs(pe,{name:"userId",value:g.userId||"",onChange:y,label:"Người dùng",disabled:!g.departmentId,children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),j.map((e=>r.jsxs(Q,{value:e.id,children:[e.userName," - ",e.fullName]},e.id)))]})]})}),r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(se,{fullWidth:!0,size:"small",children:[r.jsx(xe,{children:"Trạng thái xác minh"}),r.jsxs(pe,{name:"proofStatus",value:void 0!==g.proofStatus?g.proofStatus:"",onChange:y,label:"Trạng thái xác minh",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),r.jsx(Q,{value:qa.HopLe,children:"Hợp lệ"}),r.jsx(Q,{value:qa.KhongHopLe,children:"Không hợp lệ"}),r.jsx(Q,{value:qa.ChuaXuLy,children:"Chưa xử lý"})]})]})}),r.jsx(R,{item:!0,xs:12,sm:6,md:3,children:r.jsxs(se,{fullWidth:!0,size:"small",children:[r.jsx(xe,{children:"Nguồn"}),r.jsxs(pe,{name:"source",value:void 0!==g.source?g.source:"",onChange:y,label:"Nguồn",children:[r.jsx(Q,{value:"",children:r.jsx("em",{children:"Không chọn"})}),r.jsx(Q,{value:Da.NguoiDungKeKhai,children:"Người dùng kê khai"}),r.jsx(Q,{value:Da.QuanLyNhap,children:"Quản lý nhập"})]})]})}),r.jsx(R,{item:!0,xs:12,children:r.jsx(we,{control:r.jsx(be,{checked:g.onlyRegisteredWorks,onChange:e=>{const{name:n,checked:a}=e.target;x((e=>({...e,[n]:a})))},name:"onlyRegisteredWorks"}),label:"Chỉ hiển thị công trình đã đăng ký"})})]})]}),r.jsxs(ke,{sx:{p:3,borderRadius:2,boxShadow:3},children:[r.jsx(A,{direction:"row",justifyContent:"space-between",alignItems:"center",mb:2,children:r.jsxs(W,{variant:"h6",display:"flex",alignItems:"center",children:[r.jsxs("span",{children:["Kết quả (",i.length," công trình)"]}),e&&r.jsx($,{size:24,sx:{ml:2}})]})}),a&&r.jsx(ie,{severity:"error",sx:{mb:2},children:a}),0!==i.length||e?r.jsx(ra,{columns:v,data:i}):r.jsx(ie,{severity:"info",children:"Không có công trình nào được tìm thấy. Vui lòng thay đổi bộ lọc hoặc thử lại."})]})]})},Rt=gn([{element:r.jsx(Pn,{}),children:[{element:r.jsx(ft,{}),children:[{path:"/",Component:function(){return r.jsx(Z,{slots:{toolbarAccount:Bn},children:r.jsx(_,{children:r.jsx(L,{})})})},children:[{path:"/",element:r.jsx(aa,{})},{path:"/cong-trinh",element:r.jsx(ft,{allowedRoles:["User","Manager"],children:r.jsx(Ma,{})})},{path:"dang-ky-quy-doi",element:r.jsx(ft,{allowedRoles:["User"],children:r.jsx(bt,{})})},{path:"/cham-diem",element:r.jsx(ft,{allowedRoles:["Manager","Admin"],children:r.jsx(qt,{})})},{path:"/cham-diem/user/:userId",element:r.jsx(ft,{allowedRoles:["Manager","Admin"],children:r.jsx(It,{})})},{path:"/phan-cong",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(it,{})})},{path:"/cap-nhat-thong-tin",element:r.jsx(ft,{children:r.jsx(Nt,{})})},{path:"/test",element:r.jsx(ft,{allowedRoles:["User","Manager","Admin"],children:r.jsx(Ua,{})})},{path:"/bao-cao",element:r.jsx(ft,{allowedRoles:["User","Manager"],children:r.jsx(Wt,{})})},{path:"/thong-ke",element:r.jsx(ft,{allowedRoles:["Admin","Manager"],children:r.jsx(Dt,{})})},{path:"/quan-ly-tai-khoan",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(yt,{})})},{path:"/cau-hinh-he-thong",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(ut,{})})},{path:"/cai-dat",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(ta,{})})},{path:"/cai-dat/loai-cong-trinh",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(at,{})})},{path:"/cai-dat/cap-cong-trinh",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(Ja,{})})},{path:"/cai-dat/vai-tro-tac-gia",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(ca,{})})},{path:"/cai-dat/muc-dich-quy-doi",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(Qa,{})})},{path:"/cai-dat/he-so-quy-doi",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(ka,{})})},{path:"/cai-dat/nganh-scimago",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(Ya,{})})},{path:"/cai-dat/don-vi",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(ma,{})})},{path:"/cai-dat/nganh",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(Ta,{})})},{path:"/cai-dat/nam-hoc",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(dt,{})})},{path:"/cai-dat/quan-ly-cache",element:r.jsx(ft,{allowedRoles:["Admin"],children:r.jsx(At,{})})}]}]}]},{path:"/dang-ky",element:r.jsx(na,{})},{path:"/dang-nhap",element:r.jsx(Xn,{})},{path:"/unauthorized",element:r.jsx(wt,{})},{path:"*",element:r.jsx(vt,{})}]);xn.createRoot(document.getElementById("root")).render(r.jsx(u.StrictMode,{children:r.jsx(pn,{theme:e,children:r.jsx(In,{children:r.jsx(jn,{router:Rt})})})}))}}}));
